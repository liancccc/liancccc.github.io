

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=light>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="守心">
  <meta name="keywords" content="">
  
    <meta name="description" content="项目介绍项目地址：https:&#x2F;&#x2F;github.com&#x2F;Qianlitp&#x2F;crawlergo crawlergo是一个使用chrome headless模式进行URL收集的浏览器爬虫。它对整个网页的关键位置与DOM渲染阶段进行HOOK，自动进行表单填充并提交，配合智能的JS事件触发，尽可能的收集网站暴露出的入口。内置URL去重模块，过滤掉了大量伪静态URL，对于大型网站仍保持较快的解析与抓取速度，">
<meta property="og:type" content="article">
<meta property="og:title" content="crawlergo 源码学习">
<meta property="og:url" content="https://liancccc.github.io/2024/03/12/%E6%8A%80%E6%9C%AF/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/crawlergo/index.html">
<meta property="og:site_name" content="liancccc&#39;s blog">
<meta property="og:description" content="项目介绍项目地址：https:&#x2F;&#x2F;github.com&#x2F;Qianlitp&#x2F;crawlergo crawlergo是一个使用chrome headless模式进行URL收集的浏览器爬虫。它对整个网页的关键位置与DOM渲染阶段进行HOOK，自动进行表单填充并提交，配合智能的JS事件触发，尽可能的收集网站暴露出的入口。内置URL去重模块，过滤掉了大量伪静态URL，对于大型网站仍保持较快的解析与抓取速度，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog-1310215391.cos.ap-beijing.myqcloud.com/images/crawlergo.png?imageSlim">
<meta property="og:image" content="https://blog-1310215391.cos.ap-beijing.myqcloud.com/images/323a4e635d9746da89c45c1108d5de60.png?imageSlim">
<meta property="og:image" content="https://blog-1310215391.cos.ap-beijing.myqcloud.com/images/image-20240327111535900.png?imageSlim">
<meta property="og:image" content="https://blog-1310215391.cos.ap-beijing.myqcloud.com/images/image-20240327161550750.png?imageSlim">
<meta property="og:image" content="https://blog-1310215391.cos.ap-beijing.myqcloud.com/images/image-20240328141653434.png?imageSlim">
<meta property="article:published_time" content="2024-03-12T13:24:30.000Z">
<meta property="article:modified_time" content="2025-06-11T12:30:08.000Z">
<meta property="article:author" content="守心">
<meta property="article:tag" content="源码学习">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog-1310215391.cos.ap-beijing.myqcloud.com/images/crawlergo.png?imageSlim">
  
  
  
  <title>crawlergo 源码学习 - liancccc&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/font.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"liancccc.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":false},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 50vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>琉璃魄</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/lbxx.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="crawlergo 源码学习"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-03-12 21:24" pubdate>
          2024年3月12日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    

    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">crawlergo 源码学习</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h2><p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/Qianlitp/crawlergo">https://github.com/Qianlitp/crawlergo</a></p>
<p>crawlergo是一个使用<code>chrome headless</code>模式进行URL收集的浏览器爬虫。它对整个网页的关键位置与DOM渲染阶段进行HOOK，自动进行表单填充并提交，配合智能的JS事件触发，尽可能的收集网站暴露出的入口。内置URL去重模块，过滤掉了大量伪静态URL，对于大型网站仍保持较快的解析与抓取速度，最后得到高质量的请求结果集合。</p>
<p>crawlergo 目前支持以下特性：</p>
<ul>
<li>原生浏览器环境，协程池调度任务</li>
<li>表单智能填充、自动化提交</li>
<li>完整DOM事件收集，自动化触发</li>
<li>智能URL去重，去掉大部分的重复请求</li>
<li>全面分析收集，包括javascript文件内容、页面注释、robots.txt文件和常见路径Fuzz</li>
<li>支持Host绑定，自动添加Referer</li>
<li>支持请求代理，支持爬虫结果主动推送</li>
</ul>
<p>crawlergo 是现在用的比较多的动态爬虫了，一般就是 crawlergo + xray 组合来进行漏扫，现在就来看看 crawlergo 的源码。</p>
<h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs shell">├── cmd<br>│   └── crawlergo<br>│       ├── flag.go<br>│       └── main.go<br>├── pkg<br>│   ├── config<br>│   │   ├── config.go<br>│   ├── domain_collect.go				// 域名收集 ( 从请求列表中获取到 hostname )<br>│   ├── engine<br>│   │   ├── after_dom_tasks.go			// DOM 节点加载完成之后 表单填充|ObserverJS监听DOM|启动 AfterLoadedRun() )<br>│   │   ├── after_loaded_tasks.go		// 页面加载之后 提交表单|事件触发<br>│   │   ├── browser.go					// 浏览器的初始化<br>│   │   ├── collect_links.go			// 链接收集 添加到请求列表<br>│   │   ├── intercept_request.go		// 请求处理 响应解析<br>│   │   ├── tab.go						// 爬虫启动...<br>│   ├── filter<br>│   │   ├── filter.go<br>│   │   ├── simple_filter.go			// 简单过滤<br>│   │   ├── smart_filter.go				// 智能过滤 =&gt; 打标签<br>│   │   └── smart_filter_test.go<br>│   ├── js<br>│   │   └── javascript.go				// 注入的 JS<br>│   ├── logger<br>│   │   └── logger.go<br>│   ├── model<br>│   │   ├── request.go<br>│   │   ├── url.go<br>│   │   └── url_test.go<br>│   ├── path_expansion.go				// robots<br>│   ├── taskconfig.go<br>│   ├── taskconfig_test.go<br>│   ├── task_main.go<br>│   └── tools<br>│       ├── common.go<br>│       ├── random.go<br>│       └── requests<br>│           ├── requests.go<br>│           ├── response.go<br>│           └── utils.go<br>├── README.md<br>└── README_zh-cn.md<br></code></pre></td></tr></table></figure>

<p>画了一下导图：</p>
<p><img src="https://blog-1310215391.cos.ap-beijing.myqcloud.com/images/crawlergo.png?imageSlim" srcset="/img/loading.gif" lazyload alt="crawlergo"></p>
<h2 id="源码学习"><a href="#源码学习" class="headerlink" title="源码学习"></a>源码学习</h2><p>跟着 crawlergo 的流程走一遍，具体的逻辑在 pkg&#x2F;task_main.go 的 Run()：</p>
<ol>
<li>通过 robots.txt 获取</li>
<li>通过 Fuzz 目录获取</li>
<li>收集到的 url 进行过滤后添加到 initTasks 中</li>
<li>开始对 initTasks 中的目标进行爬行 addTask2Pool </li>
<li>对所有请求进行去重处理</li>
<li>从去重后的请求中收集子域名 host</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *CrawlerTask)</span></span> Run() &#123;<br>	<span class="hljs-keyword">defer</span> t.Pool.Release()  <span class="hljs-comment">// 释放协程池</span><br>	<span class="hljs-keyword">defer</span> t.Browser.Close() <span class="hljs-comment">// 关闭浏览器</span><br><br>	t.Start = time.Now()<br>	<span class="hljs-comment">// 从 robots.txt 中获取 </span><br>	<span class="hljs-keyword">if</span> t.Config.PathFromRobots &#123;<br>		reqsFromRobots := GetPathsFromRobots(*t.Targets[<span class="hljs-number">0</span>])<br>		logger.Logger.Info(<span class="hljs-string">&quot;get paths from robots.txt: &quot;</span>, <span class="hljs-built_in">len</span>(reqsFromRobots))<br>		<span class="hljs-comment">// 获取的的目标添加到 Targets 中</span><br>		t.Targets = <span class="hljs-built_in">append</span>(t.Targets, reqsFromRobots...)<br>	&#125;<br>	<span class="hljs-comment">// 通过 Fuzz 获取 </span><br>	<span class="hljs-keyword">if</span> t.Config.FuzzDictPath != <span class="hljs-string">&quot;&quot;</span> &#123;<br>		<span class="hljs-keyword">if</span> t.Config.PathByFuzz &#123;<br>			logger.Logger.Warn(<span class="hljs-string">&quot;`--fuzz-path` is ignored, using `--fuzz-path-dict` instead&quot;</span>)<br>		&#125;<br>		reqsByFuzz := GetPathsByFuzzDict(*t.Targets[<span class="hljs-number">0</span>], t.Config.FuzzDictPath)<br>		t.Targets = <span class="hljs-built_in">append</span>(t.Targets, reqsByFuzz...)<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> t.Config.PathByFuzz &#123;<br>		reqsByFuzz := GetPathsByFuzz(*t.Targets[<span class="hljs-number">0</span>])<br>		logger.Logger.Info(<span class="hljs-string">&quot;get paths by fuzzing: &quot;</span>, <span class="hljs-built_in">len</span>(reqsByFuzz))<br>		t.Targets = <span class="hljs-built_in">append</span>(t.Targets, reqsByFuzz...)<br>	&#125;<br><br>	t.Result.AllReqList = t.Targets[:]<br><br>	<span class="hljs-keyword">var</span> initTasks []*model.Request<br>	<span class="hljs-comment">// 对请求进行过滤 打标记 计算唯一 ID 通过 SET 存储</span><br>	<span class="hljs-keyword">for</span> _, req := <span class="hljs-keyword">range</span> t.Targets &#123;<br>		<span class="hljs-keyword">if</span> t.filter.DoFilter(req) &#123;<br>			logger.Logger.Debugf(<span class="hljs-string">&quot;filter req: &quot;</span> + req.URL.RequestURI())<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		<span class="hljs-comment">// 没有重复 添加到任务列表</span><br>		initTasks = <span class="hljs-built_in">append</span>(initTasks, req)<br>		t.Result.ReqList = <span class="hljs-built_in">append</span>(t.Result.ReqList, req)<br>	&#125;<br>	logger.Logger.Info(<span class="hljs-string">&quot;filter repeat, target count: &quot;</span>, <span class="hljs-built_in">len</span>(initTasks))<br>	<span class="hljs-comment">// 遍历请求队列 开始访问</span><br>	<span class="hljs-keyword">for</span> _, req := <span class="hljs-keyword">range</span> initTasks &#123;<br>		<span class="hljs-keyword">if</span> !engine2.IsIgnoredByKeywordMatch(*req, t.Config.IgnoreKeywords) &#123;<br>			t.addTask2Pool(req)<br>		&#125;<br>	&#125;<br><br>	t.taskWG.Wait()<br><br>	<span class="hljs-comment">// 对全部请求进行唯一去重</span><br>	todoFilterAll := <span class="hljs-built_in">make</span>([]*model.Request, <span class="hljs-built_in">len</span>(t.Result.AllReqList))<br>	<span class="hljs-built_in">copy</span>(todoFilterAll, t.Result.AllReqList)<br><br>	t.Result.AllReqList = []*model.Request&#123;&#125;<br>	<span class="hljs-keyword">var</span> simpleFilter filter2.SimpleFilter<br>	<span class="hljs-keyword">for</span> _, req := <span class="hljs-keyword">range</span> todoFilterAll &#123;<br>		<span class="hljs-keyword">if</span> !simpleFilter.UniqueFilter(req) &#123;<br>			t.Result.AllReqList = <span class="hljs-built_in">append</span>(t.Result.AllReqList, req)<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// 全部域名</span><br>	t.Result.AllDomainList = AllDomainCollect(t.Result.AllReqList)<br>	<span class="hljs-comment">// 子域名</span><br>	t.Result.SubDomainList = SubDomainCollect(t.Result.AllReqList, t.RootDomain)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>robots.txt 获取：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetPathsFromRobots</span><span class="hljs-params">(navReq model2.Request)</span></span> []*model2.Request &#123;<br>	logger.Logger.Info(<span class="hljs-string">&quot;starting to get paths from robots.txt.&quot;</span>)<br>	<span class="hljs-keyword">var</span> result []*model2.Request<br>    <span class="hljs-comment">// 通过正则找到 Disallow: 这种格式后面的路径</span><br>	<span class="hljs-keyword">var</span> urlFindRegex = regexp.MustCompile(<span class="hljs-string">`(?:Disallow|Allow):.*?(/.+)`</span>)<br>	<span class="hljs-keyword">var</span> urlRegex = regexp.MustCompile(<span class="hljs-string">`(/.+)`</span>)<br><br>	navReq.URL.Path = <span class="hljs-string">&quot;/&quot;</span><br>	url := navReq.URL.NoQueryUrl() + <span class="hljs-string">&quot;robots.txt&quot;</span><br><br>	resp, err := requests.Get(url, tools.ConvertHeaders(navReq.Headers),<br>		&amp;requests.ReqOptions&#123;AllowRedirect: <span class="hljs-literal">false</span>,<br>			Timeout: <span class="hljs-number">5</span>,<br>			Proxy:   navReq.Proxy&#125;)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-comment">//for</span><br>		<span class="hljs-comment">//logger.Logger.Error(&quot;request to robots.txt error &quot;, err)</span><br>		<span class="hljs-keyword">return</span> result<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> resp.StatusCode &lt; <span class="hljs-number">200</span> || resp.StatusCode &gt;= <span class="hljs-number">300</span> &#123;<br>		<span class="hljs-keyword">return</span> result<br>	&#125;<br>	urlList := urlFindRegex.FindAllString(resp.Text, <span class="hljs-number">-1</span>)<br>    <span class="hljs-comment">// 生成 req</span><br>	<span class="hljs-keyword">for</span> _, _url := <span class="hljs-keyword">range</span> urlList &#123;<br>		_url = strings.TrimSpace(_url)<br>		_url = urlRegex.FindString(_url)<br>		url, err := model2.GetUrl(_url, *navReq.URL)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		req := model2.GetRequest(config.GET, url)<br>		req.Source = config.FromRobots<br>		result = <span class="hljs-built_in">append</span>(result, &amp;req)<br>	&#125;<br>	<span class="hljs-keyword">return</span> result<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Fuzz：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">doFuzz</span><span class="hljs-params">(navReq model2.Request, pathList []<span class="hljs-type">string</span>)</span></span> []*model2.Request &#123;<br>	validateUrl = mapset.NewSet()<br>	<span class="hljs-keyword">var</span> result []*model2.Request<br>	pool, _ := ants.NewPool(<span class="hljs-number">20</span>)<br>	<span class="hljs-keyword">defer</span> pool.Release()<br>	<span class="hljs-keyword">for</span> _, path := <span class="hljs-keyword">range</span> pathList &#123;<br>		path = strings.TrimPrefix(path, <span class="hljs-string">&quot;/&quot;</span>)<br>		path = strings.TrimSuffix(path, <span class="hljs-string">&quot;\n&quot;</span>)<br>		task := singleFuzz&#123;<br>			navReq: navReq,<br>			path:   path,<br>		&#125;<br>		pathFuzzWG.Add(<span class="hljs-number">1</span>)<br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            <span class="hljs-comment">// 发起请求</span><br>			err := pool.Submit(task.doRequest)<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				pathFuzzWG.Done()<br>			&#125;<br>		&#125;()<br>	&#125;<br><br>	pathFuzzWG.Wait()<br>    <span class="hljs-comment">// 对 URL 进行处理 生成 req</span><br>	<span class="hljs-keyword">for</span> _, _url := <span class="hljs-keyword">range</span> validateUrl.ToSlice() &#123;<br>		_url := _url.(<span class="hljs-type">string</span>)<br>		url, err := model2.GetUrl(_url)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		req := model2.GetRequest(config.GET, url)<br>		req.Source = config.FromFuzz<br>		result = <span class="hljs-built_in">append</span>(result, &amp;req)<br>	&#125;<br>	<span class="hljs-keyword">return</span> result<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s singleFuzz)</span></span> doRequest() &#123;<br>	<span class="hljs-keyword">defer</span> pathFuzzWG.Done()<br><br>	url := fmt.Sprintf(<span class="hljs-string">`%s://%s/%s`</span>, s.navReq.URL.Scheme, s.navReq.URL.Host, s.path)<br>	resp, errs := requests.Get(url, tools.ConvertHeaders(s.navReq.Headers),<br>		&amp;requests.ReqOptions&#123;Timeout: <span class="hljs-number">2</span>, AllowRedirect: <span class="hljs-literal">false</span>, Proxy: s.navReq.Proxy&#125;)<br>	<span class="hljs-keyword">if</span> errs != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>    <span class="hljs-comment">// 将存活的 URL 放到 validateUrl Set 中</span><br>	<span class="hljs-keyword">if</span> resp.StatusCode &gt;= <span class="hljs-number">200</span> &amp;&amp; resp.StatusCode &lt; <span class="hljs-number">300</span> &#123;<br>		validateUrl.Add(url)<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> resp.StatusCode == <span class="hljs-number">301</span> &#123;<br>		locations := resp.Header[<span class="hljs-string">&quot;Location&quot;</span>]<br>		<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(locations) == <span class="hljs-number">0</span> &#123;<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		location := locations[<span class="hljs-number">0</span>]<br>		redirectUrl, err := model2.GetUrl(location)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		<span class="hljs-keyword">if</span> redirectUrl.Host == s.navReq.URL.Host &#123;<br>			validateUrl.Add(url)<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>DoFilter 这里会先对初始收集到的 url 进行一个过滤，看一下过滤：</p>
<p>这里有两个：</p>
<ol>
<li>simple_filter</li>
<li>smart_filter</li>
</ol>
<p>simple_filter：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewSimpleFilter</span><span class="hljs-params">(host <span class="hljs-type">string</span>)</span></span> *SimpleFilter &#123;<br>	staticSuffixSet := config.StaticSuffixSet.Clone()<br><br>	<span class="hljs-keyword">for</span> _, suffix := <span class="hljs-keyword">range</span> []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;js&quot;</span>, <span class="hljs-string">&quot;css&quot;</span>, <span class="hljs-string">&quot;json&quot;</span>&#125; &#123;<br>		staticSuffixSet.Add(suffix)<br>	&#125;<br>	s := &amp;SimpleFilter&#123;UniqueSet: mapset.NewSet(), staticSuffixSet: staticSuffixSet, HostLimit: host&#125;<br>	<span class="hljs-keyword">return</span> s<br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li>域名限制 &#x3D;&gt; 限制爬取的域名</li>
<li>Unique 去重</li>
<li>静态资源</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *SimpleFilter)</span></span> DoFilter(req *model.Request) <span class="hljs-type">bool</span> &#123;<br>	<span class="hljs-keyword">if</span> s.UniqueSet == <span class="hljs-literal">nil</span> &#123;<br>		s.UniqueSet = mapset.NewSet()<br>	&#125;<br>	<span class="hljs-comment">// 过滤域名</span><br>	<span class="hljs-keyword">if</span> s.HostLimit != <span class="hljs-string">&quot;&quot;</span> &amp;&amp; s.DomainFilter(req) &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>	&#125;<br>	<span class="hljs-comment">// Unique 去重</span><br>	<span class="hljs-keyword">if</span> s.UniqueFilter(req) &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>	&#125;<br>	<span class="hljs-comment">// 过滤静态资源</span><br>	<span class="hljs-keyword">if</span> s.StaticFilter(req) &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里的 Unique 是使用的 req.UniqueId() ：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *SimpleFilter)</span></span> UniqueFilter(req *model.Request) <span class="hljs-type">bool</span> &#123;<br>	<span class="hljs-keyword">if</span> s.UniqueSet == <span class="hljs-literal">nil</span> &#123;<br>		s.UniqueSet = mapset.NewSet()<br>	&#125;<br>	<span class="hljs-keyword">if</span> s.UniqueSet.Contains(req.UniqueId()) &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		s.UniqueSet.Add(req.UniqueId())<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>看一下这个 UniqueId 是怎么生成的：</p>
<p>这里是根据请求方法 + URL + Post数据进行 MD5 获取的 UinqueId 值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(req *Request)</span></span> UniqueId() <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">if</span> req.RedirectionFlag &#123;<br>		<span class="hljs-keyword">return</span> tools.StrMd5(req.NoHeaderId() + <span class="hljs-string">&quot;Redirection&quot;</span>)<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">return</span> req.NoHeaderId()<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(req *Request)</span></span> NoHeaderId() <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">return</span> tools.StrMd5(req.Method + req.URL.String() + req.PostData)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>静态资源过滤：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *SimpleFilter)</span></span> StaticFilter(req *model.Request) <span class="hljs-type">bool</span> &#123;<br>	<span class="hljs-keyword">if</span> s.UniqueSet == <span class="hljs-literal">nil</span> &#123;<br>		s.UniqueSet = mapset.NewSet()<br>	&#125;<br>	<span class="hljs-comment">// 首先将slice转换成map</span><br><br>	<span class="hljs-keyword">if</span> req.URL.FileExt() == <span class="hljs-string">&quot;&quot;</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>	&#125;<br>    <span class="hljs-comment">// 后缀是 &quot;js&quot;, &quot;css&quot;, &quot;json&quot; 就过滤 ？</span><br>	<span class="hljs-keyword">if</span> s.staticSuffixSet.Contains(req.URL.FileExt()) &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里不太明白 JS 为什么要过滤，虽然动态爬虫是去模拟浏览器触发请求，但是 JS 里面也有可能存在一些路径或者敏感信息。</p>
<p>在看一下这个 smart_filter 过滤模式：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *SmartFilter)</span></span> DoFilter(req *model.Request) <span class="hljs-type">bool</span> &#123;<br>	<span class="hljs-comment">// 首先过滤掉静态资源、基础的去重、过滤其它的域名</span><br>	<span class="hljs-keyword">if</span> s.SimpleFilter.DoFilter(req) &#123;<br>		logger.Logger.Debugf(<span class="hljs-string">&quot;filter req by simplefilter: &quot;</span> + req.URL.RequestURI())<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>	&#125;<br>    <span class="hljs-comment">// 计算 Fragment ID</span><br>	req.Filter.FragmentID = s.calcFragmentID(req.URL.Fragment)<br>	<span class="hljs-comment">// 标记</span><br>	<span class="hljs-keyword">if</span> req.Method == config.GET || req.Method == config.DELETE || req.Method == config.HEAD || req.Method == config.OPTIONS &#123;<br>		s.getMark(req)<br>		s.repeatCountStatistic(req)<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> req.Method == config.POST || req.Method == config.PUT &#123;<br>		s.postMark(req)<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		logger.Logger.Debug(<span class="hljs-string">&quot;dont support such method: &quot;</span> + req.Method)<br>	&#125;<br>	<span class="hljs-comment">// 对标记后的请求进行去重</span><br>	uniqueId := req.Filter.UniqueId<br>	<span class="hljs-keyword">if</span> s.uniqueMarkedIds.Contains(uniqueId) &#123;<br>		logger.Logger.Debugf(<span class="hljs-string">&quot;filter req by uniqueMarkedIds 1: &quot;</span> + req.URL.RequestURI())<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>	&#125;<br>	<span class="hljs-comment">// 全局数值型参数标记</span><br>	s.globalFilterLocationMark(req)<br>	<span class="hljs-comment">// 接下来对标记的 GET 请求进行去重</span><br>	<span class="hljs-keyword">if</span> req.Method == config.GET || req.Method == config.DELETE || req.Method == config.HEAD || req.Method == config.OPTIONS &#123;<br>		<span class="hljs-comment">// 对超过阈值的GET请求进行标记</span><br>		s.overCountMark(req)<br>		<span class="hljs-comment">// 重新计算 QueryMapId</span><br>		req.Filter.QueryMapId = getParamMapID(req.Filter.MarkedQueryMap)<br>		<span class="hljs-comment">// 重新计算 PathId</span><br>		req.Filter.PathId = getPathID(req.Filter.MarkedPath)<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">// 重新计算 PostDataId</span><br>		req.Filter.PostDataId = getParamMapID(req.Filter.MarkedPostDataMap)<br>	&#125;<br>	<span class="hljs-comment">// 重新计算请求唯一ID</span><br>	req.Filter.UniqueId = getMarkedUniqueID(req)<br>	<span class="hljs-comment">// 新的ID再次去重</span><br>	newUniqueId := req.Filter.UniqueId<br>	<span class="hljs-keyword">if</span> s.uniqueMarkedIds.Contains(newUniqueId) &#123;<br>		logger.Logger.Debugf(<span class="hljs-string">&quot;filter req by uniqueMarkedIds 2: &quot;</span> + req.URL.RequestURI())<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>	&#125;<br>	<span class="hljs-comment">// 添加到结果集中</span><br>	s.uniqueMarkedIds.Add(newUniqueId)<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li>使用 simple_filter 简单过滤</li>
<li>计算 Fragment 的 ID </li>
<li>对请求进行打标记</li>
<li>通过标记后的 ID 进行去重</li>
<li>接下来对标记的 GET 请求进行去重</li>
</ol>
<p>calcFragmentID：</p>
<p>fragment 就是 # 后面的字符串：</p>
<p><img src="https://blog-1310215391.cos.ap-beijing.myqcloud.com/images/323a4e635d9746da89c45c1108d5de60.png?imageSlim" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// calcFragmentID 计算 fragment 唯一值，如果 fragment 的格式为 url path</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *SmartFilter)</span></span> calcFragmentID(fragment <span class="hljs-type">string</span>) <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">if</span> fragment == <span class="hljs-string">&quot;&quot;</span> || !strings.HasPrefix(fragment, <span class="hljs-string">&quot;/&quot;</span>) &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br>	&#125;<br>    <span class="hljs-comment">// 拼接获取 fragment 的 url</span><br>	fakeUrl, err := model.GetUrl(fragment)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		logger.Logger.Error(<span class="hljs-string">&quot;cannot calculate url fragment: &quot;</span>, err)<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br>	&#125;<br>    <span class="hljs-comment">// 对 fragment url 打标记 获取 UniqueId</span><br>	<span class="hljs-comment">// <span class="hljs-doctag">XXX:</span> discuss https://github.com/Qianlitp/crawlergo/issues/100</span><br>	fakeReq := model.GetRequest(config.GET, fakeUrl)<br>	s.getMark(&amp;fakeReq)<br>	<span class="hljs-comment">// s.repeatCountStatistic(&amp;fakeReq)</span><br>	<span class="hljs-keyword">return</span> fakeReq.Filter.UniqueId<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后就是看看它是怎么去打标记的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *SmartFilter)</span></span> getMark(req *model.Request) &#123;<br>	<span class="hljs-comment">// 首先是解码前的预先替换</span><br>	todoURL := *(req.URL)<br>	todoURL.RawQuery = s.preQueryMark(todoURL.RawQuery)<br><br>	<span class="hljs-comment">// 将参数部分转换为 map</span><br>	queryMap := todoURL.QueryMap()<br>	<span class="hljs-comment">// 对参数名打标记 数字和 long 标记</span><br>	queryMap = markParamName(queryMap)<br>	<span class="hljs-comment">// 对参数值打标记 =&gt; map[paramName]标记</span><br>	queryMap = s.markParamValue(queryMap, *req)<br>	markedPath := MarkPath(todoURL.Path)<br><br>	<span class="hljs-comment">// 计算唯一的ID</span><br>	<span class="hljs-keyword">var</span> queryKeyID <span class="hljs-type">string</span><br>	<span class="hljs-keyword">var</span> queryMapID <span class="hljs-type">string</span><br>    <span class="hljs-comment">// 参数名和参数的 ID</span><br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(queryMap) != <span class="hljs-number">0</span> &#123;<br>		queryKeyID = getKeysID(queryMap)<br>		queryMapID = getParamMapID(queryMap)<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		queryKeyID = <span class="hljs-string">&quot;&quot;</span><br>		queryMapID = <span class="hljs-string">&quot;&quot;</span><br>	&#125;<br>	pathID := getPathID(markedPath)<br><br>	req.Filter.MarkedQueryMap = queryMap<br>	req.Filter.QueryKeysId = queryKeyID<br>	req.Filter.QueryMapId = queryMapID<br>	req.Filter.MarkedPath = markedPath	<span class="hljs-comment">// 存储打标记后的路径</span><br>	req.Filter.PathId = pathID<br><br>	<span class="hljs-comment">// 最后计算标记后的唯一请求ID</span><br>	req.Filter.UniqueId = getMarkedUniqueID(req)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>preQueryMark 对原始的请求参数进行预先标记，这里的标记就是通过正则替换：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> chineseRegex = regexp.MustCompile(<span class="hljs-string">&quot;[\u4e00-\u9fa5]+&quot;</span>)<br><span class="hljs-keyword">var</span> urlencodeRegex = regexp.MustCompile(<span class="hljs-string">&quot;(?:%[A-Fa-f0-9]&#123;2,6&#125;)+&quot;</span>)<br><span class="hljs-keyword">var</span> unicodeRegex = regexp.MustCompile(<span class="hljs-string">`(?:\\u\w&#123;4&#125;)+`</span>)<br></code></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Query 的 Map 对象会自动解码，所以对 RawQuery 进行预先的标记 </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *SmartFilter)</span></span> preQueryMark(rawQuery <span class="hljs-type">string</span>) <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">if</span> chineseRegex.MatchString(rawQuery) &#123;<br>        <span class="hljs-comment">// 中文正则的地方替换为 &#123;&#123;chinese&#125;&#125; 其他同理 这个就是打标记</span><br>		<span class="hljs-keyword">return</span> chineseRegex.ReplaceAllString(rawQuery, ChineseMark)	<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> urlencodeRegex.MatchString(rawQuery) &#123;<br>		<span class="hljs-keyword">return</span> urlencodeRegex.ReplaceAllString(rawQuery, UrlEncodeMark)<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> unicodeRegex.MatchString(rawQuery) &#123;<br>		<span class="hljs-keyword">return</span> unicodeRegex.ReplaceAllString(rawQuery, UnicodeMark)<br>	&#125;<br>	<span class="hljs-keyword">return</span> rawQuery<br>&#125;<br></code></pre></td></tr></table></figure>

<p>将请求参数转换为 map:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *URL)</span></span> QueryMap() <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125; &#123;<br>    queryMap := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;&#125;<br>    <span class="hljs-keyword">for</span> key, value := <span class="hljs-keyword">range</span> u.Query() &#123;<br>       <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(value) == <span class="hljs-number">1</span> &#123;<br>          queryMap[key] = value[<span class="hljs-number">0</span>]<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>          queryMap[key] = value<br>       &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> queryMap<br>&#125;<br></code></pre></td></tr></table></figure>

<p>返回对 map 中的 key 也就是参数名打标记，参数名的标记仅标记过长和纯数字的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">markParamName</span><span class="hljs-params">(paramMap <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125; &#123;<br>	markedParamMap := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;&#125;<br>	<span class="hljs-keyword">for</span> key, value := <span class="hljs-keyword">range</span> paramMap &#123;<br>		<span class="hljs-comment">// 纯字母不处理</span><br>		<span class="hljs-keyword">if</span> onlyAlphaRegex.MatchString(key) &#123;<br>			markedParamMap[key] = value<br>			<span class="hljs-comment">// 参数名过长</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(key) &gt;= <span class="hljs-number">32</span> &#123;<br>			markedParamMap[TooLongMark] = value<br>			<span class="hljs-comment">// 替换掉数字</span><br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			key = replaceNumRegex.ReplaceAllString(key, NumberMark)<br>			markedParamMap[key] = value<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> markedParamMap<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后是参数值的标记，参数值是可变的所以就肯定是都标记的，这里的标记就是去初始化一个 map 存储 map[参数名]标记值 这样，其他的也是通过正则去进行标记替换，包含的很多模式，非字符类型，字符类型的大小写混合这种，考虑的很全：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *SmartFilter)</span></span> markParamValue(paramMap <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;, req model.Request) <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125; &#123;<br>	markedParamMap := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;&#125;<br>	<span class="hljs-keyword">for</span> key, value := <span class="hljs-keyword">range</span> paramMap &#123;<br>        <span class="hljs-comment">// 先处理 bool list number 类型的标记</span><br>		<span class="hljs-keyword">switch</span> value.(<span class="hljs-keyword">type</span>) &#123;<br>		<span class="hljs-keyword">case</span> <span class="hljs-type">bool</span>:<br>			markedParamMap[key] = BoolMark<br>			<span class="hljs-keyword">continue</span><br>		<span class="hljs-keyword">case</span> types.Slice:<br>			markedParamMap[key] = ListMark<br>			<span class="hljs-keyword">continue</span><br>		<span class="hljs-keyword">case</span> <span class="hljs-type">float64</span>:<br>			markedParamMap[key] = NumberMark<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		<span class="hljs-comment">// 然后就是对 string 类型的处理</span><br>		valueStr, ok := value.(<span class="hljs-type">string</span>)<br>		<span class="hljs-keyword">if</span> !ok &#123;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		<span class="hljs-comment">// Crawlergo 为特定字符，说明此参数位置为数值型，非逻辑型，记录下此参数，全局过滤</span><br>		<span class="hljs-keyword">if</span> strings.Contains(valueStr, <span class="hljs-string">&quot;Crawlergo&quot;</span>) &#123;<br>			name := req.URL.Hostname() + req.URL.Path + req.Method + key<br>			s.filterLocationSet.Add(name)<br>			markedParamMap[key] = CustomValueMark<br>			<span class="hljs-comment">// 全大写字母</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> onlyAlphaUpperRegex.MatchString(valueStr) &#123;<br>			markedParamMap[key] = UpperMark<br>			<span class="hljs-comment">// 参数值长度大于等于16</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(valueStr) &gt;= <span class="hljs-number">16</span> &#123;<br>			markedParamMap[key] = TooLongMark<br>			<span class="hljs-comment">// 均为数字和一些符号组成</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> onlyNumberRegex.MatchString(valueStr) || onlyNumberRegex.MatchString(numSymbolRegex.ReplaceAllString(valueStr, <span class="hljs-string">&quot;&quot;</span>)) &#123;<br>			markedParamMap[key] = NumberMark<br>			<span class="hljs-comment">// 存在中文</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> chineseRegex.MatchString(valueStr) &#123;<br>			markedParamMap[key] = ChineseMark<br>			<span class="hljs-comment">// urlencode</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> urlencodeRegex.MatchString(valueStr) &#123;<br>			markedParamMap[key] = UrlEncodeMark<br>			<span class="hljs-comment">// unicode</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> unicodeRegex.MatchString(valueStr) &#123;<br>			markedParamMap[key] = UnicodeMark<br>			<span class="hljs-comment">// 时间</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> onlyNumberRegex.MatchString(timeSymbolRegex.ReplaceAllString(valueStr, <span class="hljs-string">&quot;&quot;</span>)) &#123;<br>			markedParamMap[key] = TimeMark<br>			<span class="hljs-comment">// 字母加数字</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> onlyAlphaNumRegex.MatchString(valueStr) &amp;&amp; numberRegex.MatchString(valueStr) &#123;<br>			markedParamMap[key] = MixAlphaNumMark<br>			<span class="hljs-comment">// 含有一些特殊符号</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> hasSpecialSymbol(valueStr) &#123;<br>			markedParamMap[key] = MixSymbolMark<br>			<span class="hljs-comment">// 数字出现的次数超过3，视为数值型参数</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> b := OneNumberRegex.ReplaceAllString(valueStr, <span class="hljs-string">&quot;0&quot;</span>); strings.Count(b, <span class="hljs-string">&quot;0&quot;</span>) &gt;= <span class="hljs-number">3</span> &#123;<br>			markedParamMap[key] = MixNumMark<br>			<span class="hljs-comment">// 严格模式</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> s.StrictMode &#123;<br>			<span class="hljs-comment">// 无小写字母</span><br>			<span class="hljs-keyword">if</span> !alphaLowerRegex.MatchString(valueStr) &#123;<br>				markedParamMap[key] = NoLowerAlphaMark<br>				<span class="hljs-comment">// 常见的值一般为 大写字母、小写字母、数字、下划线的任意组合，组合类型超过三种则视为伪静态</span><br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				count := <span class="hljs-number">0</span><br>				<span class="hljs-keyword">if</span> alphaLowerRegex.MatchString(valueStr) &#123;<br>					count += <span class="hljs-number">1</span><br>				&#125;<br>				<span class="hljs-keyword">if</span> alphaUpperRegex.MatchString(valueStr) &#123;<br>					count += <span class="hljs-number">1</span><br>				&#125;<br>				<span class="hljs-keyword">if</span> numberRegex.MatchString(valueStr) &#123;<br>					count += <span class="hljs-number">1</span><br>				&#125;<br>				<span class="hljs-keyword">if</span> strings.Contains(valueStr, <span class="hljs-string">&quot;_&quot;</span>) || strings.Contains(valueStr, <span class="hljs-string">&quot;-&quot;</span>) &#123;<br>					count += <span class="hljs-number">1</span><br>				&#125;<br>				<span class="hljs-keyword">if</span> count &gt;= <span class="hljs-number">3</span> &#123;<br>					markedParamMap[key] = MixStringMark<br>				&#125;<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 其他情况就是不打了</span><br>			markedParamMap[key] = value<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> markedParamMap<br>&#125;<br></code></pre></td></tr></table></figure>

<p>之后是去做路径标记，路径标记就直接把匹配到的路径替换为空，然后再设置为标记位：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MarkPath</span><span class="hljs-params">(path <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>	pathParts := strings.Split(path, <span class="hljs-string">&quot;/&quot;</span>)<br>	<span class="hljs-keyword">for</span> index, part := <span class="hljs-keyword">range</span> pathParts &#123;<br>		<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(part) &gt;= <span class="hljs-number">32</span> &#123;<br>			pathParts[index] = TooLongMark<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> onlyNumberRegex.MatchString(numSymbolRegex.ReplaceAllString(part, <span class="hljs-string">&quot;&quot;</span>)) &#123;<br>			pathParts[index] = NumberMark<br>            <span class="hljs-comment">// html 类型</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> strings.HasSuffix(part, <span class="hljs-string">&quot;.html&quot;</span>) || strings.HasSuffix(part, <span class="hljs-string">&quot;.htm&quot;</span>) || strings.HasSuffix(part, <span class="hljs-string">&quot;.shtml&quot;</span>) &#123;<br>            <span class="hljs-comment">// 替换到 .html 这种后缀</span><br>			part = htmlReplaceRegex.ReplaceAllString(part, <span class="hljs-string">&quot;&quot;</span>)<br>			<span class="hljs-comment">// 大写、小写、数字混合</span><br>			<span class="hljs-keyword">if</span> numberRegex.MatchString(part) &amp;&amp; alphaUpperRegex.MatchString(part) &amp;&amp; alphaLowerRegex.MatchString(part) &#123;<br>				pathParts[index] = MixAlphaNumMark<br>				<span class="hljs-comment">// 纯数字</span><br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> b := numSymbolRegex.ReplaceAllString(part, <span class="hljs-string">&quot;&quot;</span>); onlyNumberRegex.MatchString(b) &#123;<br>				pathParts[index] = NumberMark<br>			&#125;<br>			<span class="hljs-comment">// 含有特殊符号</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> hasSpecialSymbol(part) &#123;<br>			pathParts[index] = MixSymbolMark<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> chineseRegex.MatchString(part) &#123;<br>			pathParts[index] = ChineseMark<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> unicodeRegex.MatchString(part) &#123;<br>			pathParts[index] = UnicodeMark<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> onlyAlphaUpperRegex.MatchString(part) &#123;<br>			pathParts[index] = UpperMark<br>			<span class="hljs-comment">// 均为数字和一些符号组成 先去掉一些符号 - _ 这些 然后看是否为纯数字 可能是针对如 /2024-01-02/ 这种 blog 类型的</span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> b := numSymbolRegex.ReplaceAllString(part, <span class="hljs-string">&quot;&quot;</span>); onlyNumberRegex.MatchString(b) &#123;<br>			pathParts[index] = NumberMark<br>			<span class="hljs-comment">// 数字出现的次数超过3，视为伪静态path </span><br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> b := OneNumberRegex.ReplaceAllString(part, <span class="hljs-string">&quot;0&quot;</span>); strings.Count(b, <span class="hljs-string">&quot;0&quot;</span>) &gt; <span class="hljs-number">3</span> &#123;<br>			pathParts[index] = MixNumMark<br>		&#125;<br>	&#125;<br>	newPath := strings.Join(pathParts, <span class="hljs-string">&quot;/&quot;</span>)<br>	<span class="hljs-keyword">return</span> newPath<br>&#125;<br></code></pre></td></tr></table></figure>

<p>返回是去生成参数名和参数部分的 ID：</p>
<p>参数名这里就是拼接然后 md5：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getKeysID</span><span class="hljs-params">(dataMap <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">var</span> keys []<span class="hljs-type">string</span><br>	<span class="hljs-keyword">var</span> idStr <span class="hljs-type">string</span><br>	<span class="hljs-keyword">for</span> key := <span class="hljs-keyword">range</span> dataMap &#123;<br>		keys = <span class="hljs-built_in">append</span>(keys, key)<br>	&#125;<br>	sort.Strings(keys)<br>	<span class="hljs-keyword">for</span> _, key := <span class="hljs-keyword">range</span> keys &#123;<br>		idStr += key<br>	&#125;<br>	<span class="hljs-keyword">return</span> tools.StrMd5(idStr)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>参数这里：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getParamMapID</span><span class="hljs-params">(dataMap <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">var</span> keys []<span class="hljs-type">string</span><br>	<span class="hljs-keyword">var</span> idStr <span class="hljs-type">string</span><br>	<span class="hljs-keyword">var</span> markReplaceRegex = regexp.MustCompile(<span class="hljs-string">`&#123;&#123;.+&#125;&#125;`</span>)<br>	<span class="hljs-keyword">for</span> key := <span class="hljs-keyword">range</span> dataMap &#123;<br>		keys = <span class="hljs-built_in">append</span>(keys, key)<br>	&#125;<br>	sort.Strings(keys)<br>	<span class="hljs-keyword">for</span> _, key := <span class="hljs-keyword">range</span> keys &#123;<br>		value := dataMap[key]<br>		idStr += key<br>		<span class="hljs-keyword">if</span> value, ok := value.(<span class="hljs-type">string</span>); ok &#123;<br>            <span class="hljs-comment">// 把参数值打过标记的部分替换成 &#123;&#123;mark&#125;&#125; 拼接后进行 MD5</span><br>			idStr += markReplaceRegex.ReplaceAllString(value, <span class="hljs-string">&quot;&#123;&#123;mark&#125;&#125;&quot;</span>)<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> tools.StrMd5(idStr)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>计算 Path ID 直接 MD5 :</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getPathID</span><span class="hljs-params">(path <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">return</span> tools.StrMd5(path)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后赋值到 Filter 中：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">req.Filter.MarkedQueryMap = queryMap<br>req.Filter.QueryKeysId = queryKeyID<br>req.Filter.QueryMapId = queryMapID<br>req.Filter.MarkedPath = markedPath<br>req.Filter.PathId = pathID<br></code></pre></td></tr></table></figure>

<p>通过请求方法、参数ID、路径ID、Host、FragmentID、协议等组合起来 md5 后作为请求的 uniqueStr</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getMarkedUniqueID</span><span class="hljs-params">(req *model.Request)</span></span> <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">var</span> paramId <span class="hljs-type">string</span><br>	<span class="hljs-keyword">if</span> req.Method == config.GET || req.Method == config.DELETE || req.Method == config.HEAD || req.Method == config.OPTIONS &#123;<br>		paramId = req.Filter.QueryMapId<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		paramId = req.Filter.PostDataId<br>	&#125;<br><br>	uniqueStr := req.Method + paramId + req.Filter.PathId + req.URL.Host + req.Filter.FragmentID<br>	<span class="hljs-keyword">if</span> req.RedirectionFlag &#123;<br>		uniqueStr += <span class="hljs-string">&quot;Redirection&quot;</span><br>	&#125;<br>	<span class="hljs-keyword">if</span> req.URL.Path == <span class="hljs-string">&quot;/&quot;</span> &amp;&amp; req.URL.RawQuery == <span class="hljs-string">&quot;&quot;</span> &amp;&amp; req.URL.Scheme == <span class="hljs-string">&quot;https&quot;</span> &#123;<br>		uniqueStr += <span class="hljs-string">&quot;https&quot;</span><br>	&#125;<br><br>	<span class="hljs-keyword">return</span> tools.StrMd5(uniqueStr)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>GET 、HEAD 等类型的请求还会做一个重复参数标记，这个其实就是去记录请求参数ID的数量，还有请求ID+参数名[参数值] 的数量</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/*</span><br><span class="hljs-comment">*</span><br><span class="hljs-comment">进行全局重复参数名、参数值、路径的统计标记</span><br><span class="hljs-comment">之后对超过阈值的部分再次打标记</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *SmartFilter)</span></span> repeatCountStatistic(req *model.Request) &#123;<br>	queryKeyId := req.Filter.QueryKeysId<br>	pathId := req.Filter.PathId<br>	<span class="hljs-keyword">if</span> queryKeyId != <span class="hljs-string">&quot;&quot;</span> &#123;<br>		<span class="hljs-comment">// 所有参数名重复数量统计 =&gt; 存储 queryKeyId 和数量</span><br>		<span class="hljs-keyword">if</span> v, ok := s.filterParamKeyRepeatCount.Load(queryKeyId); ok &#123;<br>			s.filterParamKeyRepeatCount.Store(queryKeyId, v.(<span class="hljs-type">int</span>)+<span class="hljs-number">1</span>)<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			s.filterParamKeyRepeatCount.Store(queryKeyId, <span class="hljs-number">1</span>)<br>		&#125;<br><br>		<span class="hljs-keyword">for</span> key, value := <span class="hljs-keyword">range</span> req.Filter.MarkedQueryMap &#123;<br>			<span class="hljs-comment">// 某个URL的所有参数名重复数量统计 参数 key id + 该 key</span><br>			paramQueryKey := queryKeyId + key<br><br>			<span class="hljs-keyword">if</span> set, ok := s.filterParamKeySingleValues.Load(paramQueryKey); ok &#123;<br>				set := set.(mapset.Set)<br>				set.Add(value)<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				s.filterParamKeySingleValues.Store(paramQueryKey, mapset.NewSet(value))<br>			&#125;<br><br>			<span class="hljs-comment">//本轮所有URL中某个参数重复数量统计</span><br>			<span class="hljs-keyword">if</span> _, ok := s.filterParamKeyAllValues.Load(key); !ok &#123;<br>				s.filterParamKeyAllValues.Store(key, mapset.NewSet(value))<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				<span class="hljs-keyword">if</span> v, ok := s.filterParamKeyAllValues.Load(key); ok &#123;<br>					set := v.(mapset.Set)<br>					<span class="hljs-keyword">if</span> !set.Contains(value) &#123;<br>						set.Add(value)<br>					&#125;<br>				&#125;<br>			&#125;<br><br>			<span class="hljs-comment">// 如果参数值为空，统计该PATH下的空值参数名个数</span><br>			<span class="hljs-keyword">if</span> value == <span class="hljs-string">&quot;&quot;</span> &#123;<br>				<span class="hljs-keyword">if</span> _, ok := s.filterPathParamEmptyValues.Load(pathId); !ok &#123;<br>					s.filterPathParamEmptyValues.Store(pathId, mapset.NewSet(key))<br>				&#125; <span class="hljs-keyword">else</span> &#123;<br>					<span class="hljs-keyword">if</span> v, ok := s.filterPathParamEmptyValues.Load(pathId); ok &#123;<br>						set := v.(mapset.Set)<br>						<span class="hljs-keyword">if</span> !set.Contains(key) &#123;<br>							set.Add(key)<br>						&#125;<br>					&#125;<br>				&#125;<br>			&#125;<br><br>			pathIdKey := pathId + key<br>			<span class="hljs-comment">// 某path下的参数值去重标记出现次数统计</span><br>			<span class="hljs-keyword">if</span> v, ok := s.filterPathParamKeySymbol.Load(pathIdKey); ok &#123;<br>				<span class="hljs-keyword">if</span> markedStringRegex.MatchString(value.(<span class="hljs-type">string</span>)) &#123;<br>					s.filterPathParamKeySymbol.Store(pathIdKey, v.(<span class="hljs-type">int</span>)+<span class="hljs-number">1</span>)<br>				&#125;<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				s.filterPathParamKeySymbol.Store(pathIdKey, <span class="hljs-number">1</span>)<br>			&#125;<br><br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// 相对于上一级目录，本级path目录的数量统计，存在文件后缀的情况下，放行常见脚本后缀</span><br>	<span class="hljs-keyword">if</span> req.URL.ParentPath() == <span class="hljs-string">&quot;&quot;</span> || inCommonScriptSuffix(req.URL.FileExt()) &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	<span class="hljs-comment">//</span><br>	parentPathId := tools.StrMd5(req.URL.ParentPath())<br>	currentPath := strings.Replace(req.Filter.MarkedPath, req.URL.ParentPath(), <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-number">-1</span>)<br>	<span class="hljs-keyword">if</span> _, ok := s.filterParentPathValues.Load(parentPathId); !ok &#123;<br>		s.filterParentPathValues.Store(parentPathId, mapset.NewSet(currentPath))<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">if</span> v, ok := s.filterParentPathValues.Load(parentPathId); ok &#123;<br>			set := v.(mapset.Set)<br>			<span class="hljs-keyword">if</span> !set.Contains(currentPath) &#123;<br>				set.Add(currentPath)<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Post 类型的也进行打标记和 Get 的类型：</p>
<img src="https://blog-1310215391.cos.ap-beijing.myqcloud.com/images/image-20240327111535900.png?imageSlim" srcset="/img/loading.gif" lazyload alt="image-20240327111535900" style="zoom:67%;" />

<p>打完标记后会根据 <code>req.Filter.UniqueId</code> 进行去重</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 全局数值型参数标记</span><br>s.globalFilterLocationMark(req)<br><br><span class="hljs-comment">// 接下来对标记的 GET 请求进行去重</span><br><span class="hljs-keyword">if</span> req.Method == config.GET || req.Method == config.DELETE || req.Method == config.HEAD || req.Method == config.OPTIONS &#123;<br>    <span class="hljs-comment">// 对超过阈值的GET请求进行标记</span><br>    s.overCountMark(req)<br><br>    <span class="hljs-comment">// 重新计算 QueryMapId</span><br>    req.Filter.QueryMapId = getParamMapID(req.Filter.MarkedQueryMap)<br>    <span class="hljs-comment">// 重新计算 PathId</span><br>    req.Filter.PathId = getPathID(req.Filter.MarkedPath)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 重新计算 PostDataId</span><br>    req.Filter.PostDataId = getParamMapID(req.Filter.MarkedPostDataMap)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>overCountMark 这里就是对参数、路径部分超过最大阈值的去打一个最大标记</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *SmartFilter)</span></span> overCountMark(req *model.Request) &#123;<br>	queryKeyId := req.Filter.QueryKeysId<br>	pathId := req.Filter.PathId<br>	<span class="hljs-comment">// 参数不为空，</span><br>	<span class="hljs-keyword">if</span> req.Filter.QueryKeysId != <span class="hljs-string">&quot;&quot;</span> &#123;<br>		<span class="hljs-comment">// 某个URL的所有参数名重复数量超过阈值 且该参数有超过三个不同的值 则打标记</span><br>		<span class="hljs-keyword">if</span> v, ok := s.filterParamKeyRepeatCount.Load(queryKeyId); ok &amp;&amp; v.(<span class="hljs-type">int</span>) &gt; MaxParamKeySingleCount &#123;<br>			<span class="hljs-keyword">for</span> key := <span class="hljs-keyword">range</span> req.Filter.MarkedQueryMap &#123;<br>				paramQueryKey := queryKeyId + key<br>				<span class="hljs-keyword">if</span> set, ok := s.filterParamKeySingleValues.Load(paramQueryKey); ok &#123;<br>					set := set.(mapset.Set)<br>					<span class="hljs-comment">// 3 个打标记 &#123;&#123;fix_param&#125;&#125;</span><br>					<span class="hljs-keyword">if</span> set.Cardinality() &gt; <span class="hljs-number">3</span> &#123;<br>						req.Filter.MarkedQueryMap[key] = FixParamRepeatMark<br>					&#125;<br>				&#125;<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-keyword">for</span> key := <span class="hljs-keyword">range</span> req.Filter.MarkedQueryMap &#123;<br>			<span class="hljs-comment">// 所有URL中，某个参数不同的值出现次数超过阈值，打标记去重</span><br>			<span class="hljs-keyword">if</span> paramKeySet, ok := s.filterParamKeyAllValues.Load(key); ok &#123;<br>				paramKeySet := paramKeySet.(mapset.Set)<br>				<span class="hljs-keyword">if</span> paramKeySet.Cardinality() &gt; MaxParamKeyAllCount &#123;<br>					req.Filter.MarkedQueryMap[key] = FixParamRepeatMark<br>				&#125;<br>			&#125;<br><br>			pathIdKey := pathId + key<br>			<span class="hljs-comment">// 某个PATH的GET参数值去重标记出现次数超过阈值，则对该PATH的该参数进行全局标记</span><br>			<span class="hljs-keyword">if</span> v, ok := s.filterPathParamKeySymbol.Load(pathIdKey); ok &amp;&amp; v.(<span class="hljs-type">int</span>) &gt; MaxPathParamKeySymbolCount &#123;<br>				req.Filter.MarkedQueryMap[key] = FixParamRepeatMark<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">// 处理某个path下空参数值的参数个数超过阈值 如伪静态： http://bang.360.cn/?chu_xiu</span><br>		<span class="hljs-keyword">if</span> v, ok := s.filterPathParamEmptyValues.Load(pathId); ok &#123;<br>			set := v.(mapset.Set)<br>			<span class="hljs-keyword">if</span> set.Cardinality() &gt; MaxPathParamEmptyCount &#123;<br>				newMarkerQueryMap := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;&#125;<br>				<span class="hljs-keyword">for</span> key, value := <span class="hljs-keyword">range</span> req.Filter.MarkedQueryMap &#123;<br>					<span class="hljs-keyword">if</span> value == <span class="hljs-string">&quot;&quot;</span> &#123;<br>						newMarkerQueryMap[FixParamRepeatMark] = <span class="hljs-string">&quot;&quot;</span><br>					&#125; <span class="hljs-keyword">else</span> &#123;<br>						newMarkerQueryMap[key] = value<br>					&#125;<br>				&#125;<br>				req.Filter.MarkedQueryMap = newMarkerQueryMap<br>			&#125;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// 处理本级 path 的伪静态</span><br>	<span class="hljs-keyword">if</span> req.URL.ParentPath() == <span class="hljs-string">&quot;&quot;</span> || inCommonScriptSuffix(req.URL.FileExt()) &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	parentPathId := tools.StrMd5(req.URL.ParentPath())<br>	<span class="hljs-keyword">if</span> set, ok := s.filterParentPathValues.Load(parentPathId); ok &#123;<br>		set := set.(mapset.Set)<br>		<span class="hljs-keyword">if</span> set.Cardinality() &gt; MaxParentPathCount &#123;<br>			<span class="hljs-keyword">if</span> strings.HasSuffix(req.URL.ParentPath(), <span class="hljs-string">&quot;/&quot;</span>) &#123;<br>				req.Filter.MarkedPath = req.URL.ParentPath() + FixPathMark<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				req.Filter.MarkedPath = req.URL.ParentPath() + <span class="hljs-string">&quot;/&quot;</span> + FixPathMark<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>处理过超过阈值的部分后会再进行一次打标记，这个时候路径、参数会经过改变，所以会进行再一轮打标记：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 接下来对标记的 GET 请求进行去重</span><br><span class="hljs-keyword">if</span> req.Method == config.GET || req.Method == config.DELETE || req.Method == config.HEAD || req.Method == config.OPTIONS &#123;<br>    <span class="hljs-comment">// 对超过阈值的GET请求进行标记</span><br>    s.overCountMark(req)<br><br>    <span class="hljs-comment">// 重新计算 QueryMapId</span><br>    req.Filter.QueryMapId = getParamMapID(req.Filter.MarkedQueryMap)<br>    <span class="hljs-comment">// 重新计算 PathId</span><br>    req.Filter.PathId = getPathID(req.Filter.MarkedPath)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 重新计算 PostDataId</span><br>    req.Filter.PostDataId = getParamMapID(req.Filter.MarkedPostDataMap)<br>&#125;<br><br><span class="hljs-comment">// 重新计算请求唯一ID</span><br>req.Filter.UniqueId = getMarkedUniqueID(req)<br></code></pre></td></tr></table></figure>

<p>然后就是使用新的标记 ID 进行去重处理了：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go">req.Filter.UniqueId = getMarkedUniqueID(req)<br><br><span class="hljs-comment">// 新的ID再次去重</span><br>newUniqueId := req.Filter.UniqueId<br><span class="hljs-keyword">if</span> s.uniqueMarkedIds.Contains(newUniqueId) &#123;<br>    logger.Logger.Debugf(<span class="hljs-string">&quot;filter req by uniqueMarkedIds 2: &quot;</span> + req.URL.RequestURI())<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-comment">// 添加到结果集中</span><br>s.uniqueMarkedIds.Add(newUniqueId)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>

<p>到这里 crawlergo 的去重部分就完了，它是通过对参数进行打标记进行的去重处理：</p>
<p>简单一下就是这样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://url/abc?<span class="hljs-built_in">id</span>=1<br>http://url/abc?<span class="hljs-built_in">id</span>=2<br>http://url/abc?<span class="hljs-built_in">id</span>=3<br></code></pre></td></tr></table></figure>

<p>这些会被打标机为：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">http://url/abc?id=</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">number</span>&#125;&#125;</span><br></code></pre></td></tr></table></figure>

<p>这样就做到了去重。</p>
<p>过滤之后，会把请求添加到 initTasks 列表中，然后就开始爬行任务了：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> _, req := <span class="hljs-keyword">range</span> initTasks &#123;<br>    <span class="hljs-keyword">if</span> !engine2.IsIgnoredByKeywordMatch(*req, t.Config.IgnoreKeywords) &#123;<br>        t.addTask2Pool(req)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>IsIgnoredByKeywordMatch 用来判断该请求是否是需要忽略掉的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">IsIgnoredByKeywordMatch</span><span class="hljs-params">(req model2.Request, IgnoreKeywords []<span class="hljs-type">string</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>	<span class="hljs-keyword">for</span> _, _str := <span class="hljs-keyword">range</span> IgnoreKeywords &#123;<br>		<span class="hljs-keyword">if</span> strings.Contains(req.URL.String(), _str) &#123;<br>			logger.Logger.Info(<span class="hljs-string">&quot;ignore request: &quot;</span>, req.SimpleFormat())<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后就是爬行部分：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *CrawlerTask)</span></span> addTask2Pool(req *model.Request) &#123;<br>	t.taskCountLock.Lock()<br>	<span class="hljs-comment">// 爬行数量</span><br>	<span class="hljs-keyword">if</span> t.crawledCount &gt;= t.Config.MaxCrawlCount &#123;<br>		t.taskCountLock.Unlock()<br>		<span class="hljs-keyword">return</span><br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		t.crawledCount += <span class="hljs-number">1</span><br>	&#125;<br>	<span class="hljs-comment">// 超时</span><br>	<span class="hljs-keyword">if</span> t.Start.Add(time.Second * time.Duration(t.Config.MaxRunTime)).Before(time.Now()) &#123;<br>		t.taskCountLock.Unlock()<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	t.taskCountLock.Unlock()<br><br>	t.taskWG.Add(<span class="hljs-number">1</span>)<br>	<span class="hljs-comment">// 根据请求生成协程任务</span><br>	task := t.generateTabTask(req)<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-comment">// 这里使用了 ants 去控制协程 执行的是 task.Task() 去做爬行的具体逻辑</span><br>		err := t.Pool.Submit(task.Task)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			t.taskWG.Done()<br>			logger.Logger.Error(<span class="hljs-string">&quot;addTask2Pool &quot;</span>, err)<br>		&#125;<br>	&#125;()<br>&#125;<br></code></pre></td></tr></table></figure>

<p>generateTabTask 就是封装了一下这个请求：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *CrawlerTask)</span></span> generateTabTask(req *model.Request) *tabTask &#123;<br>	task := tabTask&#123;<br>		crawlerTask: t,<br>		browser:     t.Browser,<br>		req:         req,<br>	&#125;<br>	<span class="hljs-keyword">return</span> &amp;task<br>&#125;<br></code></pre></td></tr></table></figure>

<p>具体的爬行任务就是在 Task() 这里了：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *tabTask)</span></span> Task() &#123;<br>	<span class="hljs-keyword">defer</span> t.crawlerTask.taskWG.Done()<br><br>	<span class="hljs-comment">// 设置tab超时时间，若设置了程序最大运行时间， tab超时时间和程序剩余时间取小</span><br>	timeremaining := t.crawlerTask.Start.Add(time.Duration(t.crawlerTask.Config.MaxRunTime) * time.Second).Sub(time.Now())<br>	tabTime := t.crawlerTask.Config.TabRunTimeout<br>	<span class="hljs-keyword">if</span> t.crawlerTask.Config.TabRunTimeout &gt; timeremaining &#123;<br>		tabTime = timeremaining<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> tabTime &lt;= <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-comment">// 创建一个标签页</span><br>	tab := engine2.NewTab(t.browser, *t.req, engine2.TabConfig&#123;<br>		TabRunTimeout:           tabTime,<br>		DomContentLoadedTimeout: t.crawlerTask.Config.DomContentLoadedTimeout,<br>		EventTriggerMode:        t.crawlerTask.Config.EventTriggerMode,<br>		EventTriggerInterval:    t.crawlerTask.Config.EventTriggerInterval,<br>		BeforeExitDelay:         t.crawlerTask.Config.BeforeExitDelay,<br>		EncodeURLWithCharset:    t.crawlerTask.Config.EncodeURLWithCharset,<br>		IgnoreKeywords:          t.crawlerTask.Config.IgnoreKeywords,<br>		CustomFormValues:        t.crawlerTask.Config.CustomFormValues,<br>		CustomFormKeywordValues: t.crawlerTask.Config.CustomFormKeywordValues,<br>	&#125;)<br>    <span class="hljs-comment">// 开始爬行</span><br>	tab.Start()<br><br>	<span class="hljs-comment">// 收集结果</span><br>	t.crawlerTask.Result.resultLock.Lock()<br>	t.crawlerTask.Result.AllReqList = <span class="hljs-built_in">append</span>(t.crawlerTask.Result.AllReqList, tab.ResultList...)<br>	t.crawlerTask.Result.resultLock.Unlock()<br>	<span class="hljs-comment">// 遍历收集到的结构 添加任务</span><br>	<span class="hljs-keyword">for</span> _, req := <span class="hljs-keyword">range</span> tab.ResultList &#123;<br>		<span class="hljs-keyword">if</span> !t.crawlerTask.filter.DoFilter(req) &#123;<br>			t.crawlerTask.Result.resultLock.Lock()<br>			t.crawlerTask.Result.ReqList = <span class="hljs-built_in">append</span>(t.crawlerTask.Result.ReqList, req)<br>			t.crawlerTask.Result.resultLock.Unlock()<br>			<span class="hljs-keyword">if</span> !engine2.IsIgnoredByKeywordMatch(*req, t.crawlerTask.Config.IgnoreKeywords) &#123;<br>				t.crawlerTask.addTask2Pool(req)<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在 NewTab 这里主要是设置请求拦截：</p>
<ol>
<li>js 、json 类型的使用 ParseResponseURL 收集页面中可能存在的 url</li>
<li>重定向处理</li>
<li>认证页面阻塞处理</li>
<li>表单填充</li>
<li>JS 注入</li>
<li>回调处理</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewTab</span><span class="hljs-params">(browser *Browser, navigateReq model2.Request, config TabConfig)</span></span> *Tab &#123;<br>	<span class="hljs-keyword">var</span> tab Tab<br>	tab.ExtraHeaders = <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;&#125;<br>	<span class="hljs-keyword">var</span> DOMContentLoadedRun = <span class="hljs-literal">false</span><br>	tab.Ctx, tab.Cancel = browser.NewTab(config.TabRunTimeout)<br>	<span class="hljs-keyword">for</span> key, value := <span class="hljs-keyword">range</span> browser.ExtraHeaders &#123;<br>		navigateReq.Headers[key] = value<br>		<span class="hljs-keyword">if</span> key != <span class="hljs-string">&quot;Host&quot;</span> &#123;<br>			tab.ExtraHeaders[key] = value<br>		&#125;<br>	&#125;<br>	tab.NavigateReq = navigateReq<br>	tab.config = config<br>	tab.DocBodyNodeId = <span class="hljs-number">0</span><br><br>	<span class="hljs-comment">// 设置请求拦截监听</span><br>	chromedp.ListenTarget(*tab.Ctx, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(v <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>		<span class="hljs-keyword">switch</span> v := v.(<span class="hljs-keyword">type</span>) &#123;<br>		<span class="hljs-comment">// 根据不同的事件 选择执行对应的动作</span><br>		<span class="hljs-keyword">case</span> *network.EventRequestWillBeSent:<br>			<span class="hljs-keyword">if</span> <span class="hljs-type">string</span>(v.RequestID) == <span class="hljs-type">string</span>(v.LoaderID) &amp;&amp; v.Type == <span class="hljs-string">&quot;Document&quot;</span> &amp;&amp; tab.TopFrameId == <span class="hljs-string">&quot;&quot;</span> &#123;<br>				tab.LoaderID = <span class="hljs-type">string</span>(v.LoaderID)<br>				tab.TopFrameId = <span class="hljs-type">string</span>(v.FrameID)<br>			&#125;<br><br>		<span class="hljs-comment">// 请求发出时暂停 即 请求拦截</span><br>		<span class="hljs-keyword">case</span> *fetch.EventRequestPaused:<br>			tab.WG.Add(<span class="hljs-number">1</span>)<br>			<span class="hljs-keyword">go</span> tab.InterceptRequest(v)<br><br>		<span class="hljs-comment">// 解析所有JS文件中的URL并添加到结果中</span><br>		<span class="hljs-comment">// 解析HTML文档中的URL</span><br>		<span class="hljs-comment">// 查找当前页面的编码</span><br>		<span class="hljs-keyword">case</span> *network.EventResponseReceived:<br>			<span class="hljs-keyword">if</span> v.Response.MimeType == <span class="hljs-string">&quot;application/javascript&quot;</span> || v.Response.MimeType == <span class="hljs-string">&quot;text/html&quot;</span> || v.Response.MimeType == <span class="hljs-string">&quot;application/json&quot;</span> &#123;<br>				tab.WG.Add(<span class="hljs-number">1</span>)<br>				<span class="hljs-keyword">go</span> tab.ParseResponseURL(v)<br>			&#125;<br>			<span class="hljs-keyword">if</span> v.RequestID.String() == tab.NavNetworkID &#123;<br>				tab.WG.Add(<span class="hljs-number">1</span>)<br>				<span class="hljs-keyword">go</span> tab.GetContentCharset(v)<br>			&#125;<br>		<span class="hljs-comment">// 处理后端重定向 3XX</span><br>		<span class="hljs-keyword">case</span> *network.EventResponseReceivedExtraInfo:<br>			<span class="hljs-keyword">if</span> v.RequestID.String() == tab.NavNetworkID &#123;<br>				tab.WG.Add(<span class="hljs-number">1</span>)<br>				<span class="hljs-keyword">go</span> tab.HandleRedirectionResp(v)<br>			&#125;<br>		<span class="hljs-comment">//case *network.EventLoadingFailed:</span><br>		<span class="hljs-comment">//	logger.Logger.Error(&quot;EventLoadingFailed &quot;, v.ErrorText)</span><br>		<span class="hljs-comment">// 401 407 要求认证 此时会阻塞当前页面 需要处理解决</span><br>		<span class="hljs-keyword">case</span> *fetch.EventAuthRequired:<br>			tab.WG.Add(<span class="hljs-number">1</span>)<br>			<span class="hljs-keyword">go</span> tab.HandleAuthRequired(v)<br><br>		<span class="hljs-comment">// DOMContentLoaded</span><br>		<span class="hljs-comment">// 开始执行表单填充 和 执行DOM节点观察函数</span><br>		<span class="hljs-comment">// 只执行一次</span><br>		<span class="hljs-keyword">case</span> *page.EventDomContentEventFired: <span class="hljs-comment">// 当 DOM 内容加载完成时触发的事件</span><br>			<span class="hljs-keyword">if</span> DOMContentLoadedRun &#123;<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>			DOMContentLoadedRun = <span class="hljs-literal">true</span><br>			tab.WG.Add(<span class="hljs-number">1</span>)<br>			<span class="hljs-keyword">go</span> tab.AfterDOMRun()<br>		<span class="hljs-comment">// Loaded</span><br>		<span class="hljs-keyword">case</span> *page.EventLoadEventFired: <span class="hljs-comment">// 当页面完全加载完成时触发的事件</span><br>			<span class="hljs-keyword">if</span> DOMContentLoadedRun &#123;<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>			DOMContentLoadedRun = <span class="hljs-literal">true</span><br>			tab.WG.Add(<span class="hljs-number">1</span>)<br>			<span class="hljs-keyword">go</span> tab.AfterDOMRun()<br><br>		<span class="hljs-comment">// 关闭弹窗</span><br>		<span class="hljs-keyword">case</span> *page.EventJavascriptDialogOpening: <span class="hljs-comment">// 当页面弹出 JavaScript 对话框时触发的事件</span><br>			tab.WG.Add(<span class="hljs-number">1</span>)<br>			<span class="hljs-keyword">go</span> tab.dismissDialog()<br><br>		<span class="hljs-comment">// handle expose function</span><br>		<span class="hljs-keyword">case</span> *runtime.EventBindingCalled: <span class="hljs-comment">// 当页面中的绑定函数被调用时触发的事件</span><br>			tab.WG.Add(<span class="hljs-number">1</span>)<br>			<span class="hljs-keyword">go</span> tab.HandleBindingCalled(v)<br>		&#125;<br>	&#125;)<br><br>	<span class="hljs-keyword">return</span> &amp;tab<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里主要看一下 URL 收集的部分：</p>
<p>ParseResponseURL 通过正则去从页面响应中去提取 URL：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tab *Tab)</span></span> ParseResponseURL(v *network.EventResponseReceived) &#123;<br>	<span class="hljs-comment">// 通过请求 ID 获取响应内容</span><br>	<span class="hljs-keyword">defer</span> tab.WG.Done()<br>	ctx := tab.GetExecutor()<br>	res, err := network.GetResponseBody(v.RequestID).Do(ctx)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		logger.Logger.Debug(<span class="hljs-string">&quot;ParseResponseURL &quot;</span>, err)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	resStr := <span class="hljs-type">string</span>(res)<br>    <span class="hljs-comment">// 这里测试 https://identity-dev.schibsted.com/api/status 发现 json 响应中的路径被转义了</span><br>	<span class="hljs-comment">//resStr = strings.ReplaceAll(resStr, &quot;\\/&quot;, &quot;/&quot;) // json 类型的数据 string 后会 \/ 导致正则无法匹配</span><br>	urlRegex := regexp.MustCompile(<span class="hljs-string">`(?s)`</span> + config.SuspectURLRegex)<br>	urlList := urlRegex.FindAllString(resStr, <span class="hljs-number">-1</span>)<br>	<span class="hljs-keyword">for</span> _, url := <span class="hljs-keyword">range</span> urlList &#123;<br>		<span class="hljs-comment">// 去除首尾字符 =&gt; 可以优化</span><br>		url = url[<span class="hljs-number">1</span> : <span class="hljs-built_in">len</span>(url)<span class="hljs-number">-1</span>]<br>		url_lower := strings.ToLower(url)<br>		<span class="hljs-keyword">if</span> strings.HasPrefix(url_lower, <span class="hljs-string">&quot;image/x-icon&quot;</span>) || strings.HasPrefix(url_lower, <span class="hljs-string">&quot;text/css&quot;</span>) || strings.HasPrefix(url_lower, <span class="hljs-string">&quot;text/javascript&quot;</span>) &#123;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		<span class="hljs-comment">// 输出 =&gt; 添加到结果 url</span><br>		tab.AddResultUrl(config.GET, url, config.FromJSFile)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后看下它这里注入的 JS 操作：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tab *Tab)</span></span> AfterDOMRun() &#123;<br>	<span class="hljs-keyword">defer</span> tab.WG.Done()<br><br>	logger.Logger.Debug(<span class="hljs-string">&quot;afterDOMRun start&quot;</span>)<br>	<span class="hljs-keyword">if</span> !tab.getBodyNodeId() &#123;<br>		logger.Logger.Debug(<span class="hljs-string">&quot;no body document NodeID, exit.&quot;</span>)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	tab.domWG.Add(<span class="hljs-number">2</span>)<br>	<span class="hljs-keyword">go</span> tab.fillForm() <span class="hljs-comment">// 表单填充</span><br>	<span class="hljs-keyword">go</span> tab.setObserverJS()<br>	tab.domWG.Wait()<br>	logger.Logger.Debug(<span class="hljs-string">&quot;afterDOMRun end&quot;</span>)<br>	tab.WG.Add(<span class="hljs-number">1</span>)<br>	<span class="hljs-keyword">go</span> tab.AfterLoadedRun()<br>&#125;<br></code></pre></td></tr></table></figure>

<p>表单填充 tab.fillForm() ：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tab *Tab)</span></span> fillForm() &#123;<br>	<span class="hljs-keyword">defer</span> tab.domWG.Done()<br>	logger.Logger.Debug(<span class="hljs-string">&quot;fillForm start&quot;</span>)<br>	tab.fillFormWG.Add(<span class="hljs-number">3</span>)<br>	f := FillForm&#123;<br>		tab: tab,<br>	&#125;<br>	<span class="hljs-keyword">go</span> f.fillInput()	<span class="hljs-comment">// input 标签</span><br>	<span class="hljs-keyword">go</span> f.fillMultiSelect()	<span class="hljs-comment">// 多选框</span><br>	<span class="hljs-keyword">go</span> f.fillTextarea()	<span class="hljs-comment">// 文本框</span><br><br>	tab.fillFormWG.Wait()<br>	logger.Logger.Debug(<span class="hljs-string">&quot;fillForm end&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>看一下是怎么去实现填充的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *FillForm)</span></span> fillInput() &#123;<br>	<span class="hljs-keyword">defer</span> f.tab.fillFormWG.Done()<br>	<span class="hljs-keyword">var</span> nodes []*cdp.Node<br>	ctx := f.tab.GetExecutor()<br><br>	tCtx, cancel := context.WithTimeout(ctx, time.Second*<span class="hljs-number">2</span>)<br>	<span class="hljs-keyword">defer</span> cancel()<br>	<span class="hljs-comment">// 首先判断input标签是否存在，减少等待时间 提前退出</span><br>	inputNodes, inputErr := f.tab.GetNodeIDs(<span class="hljs-string">`input`</span>)<br>	<span class="hljs-keyword">if</span> inputErr != <span class="hljs-literal">nil</span> || <span class="hljs-built_in">len</span>(inputNodes) == <span class="hljs-number">0</span> &#123;<br>		logger.Logger.Debug(<span class="hljs-string">&quot;fillInput: get form input element err&quot;</span>)<br>		<span class="hljs-keyword">if</span> inputErr != <span class="hljs-literal">nil</span> &#123;<br>			logger.Logger.Debug(inputErr)<br>		&#125;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-comment">// 获取所有的input标签</span><br>	err := chromedp.Nodes(<span class="hljs-string">`input`</span>, &amp;nodes, chromedp.ByQueryAll).Do(tCtx)<br><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		logger.Logger.Debug(<span class="hljs-string">&quot;get all input element err&quot;</span>)<br>		logger.Logger.Debug(err)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	<span class="hljs-comment">// 找出 type 为空 或者 type=text</span><br>	<span class="hljs-keyword">for</span> _, node := <span class="hljs-keyword">range</span> nodes &#123;<br>		<span class="hljs-comment">// 兜底超时</span><br>		tCtxN, cancelN := context.WithTimeout(ctx, time.Second*<span class="hljs-number">5</span>)<br>		attrType := node.AttributeValue(<span class="hljs-string">&quot;type&quot;</span>)<br>		<span class="hljs-keyword">if</span> attrType == <span class="hljs-string">&quot;text&quot;</span> || attrType == <span class="hljs-string">&quot;&quot;</span> &#123;<br>			inputName := node.AttributeValue(<span class="hljs-string">&quot;id&quot;</span>) + node.AttributeValue(<span class="hljs-string">&quot;class&quot;</span>) + node.AttributeValue(<span class="hljs-string">&quot;name&quot;</span>)<br>			value := f.GetMatchInputText(inputName)<br>			<span class="hljs-keyword">var</span> nodeIds = []cdp.NodeID&#123;node.NodeID&#125;<br>			<span class="hljs-comment">// 先使用模拟输入</span><br>			_ = chromedp.SendKeys(nodeIds, value, chromedp.ByNodeID).Do(tCtxN)<br>			<span class="hljs-comment">// 再直接赋值JS属性</span><br>			_ = chromedp.SetAttributeValue(nodeIds, <span class="hljs-string">&quot;value&quot;</span>, value, chromedp.ByNodeID).Do(tCtxN)<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> attrType == <span class="hljs-string">&quot;email&quot;</span> || attrType == <span class="hljs-string">&quot;password&quot;</span> || attrType == <span class="hljs-string">&quot;tel&quot;</span> &#123;<br>			value := f.GetMatchInputText(attrType)<br>			<span class="hljs-keyword">var</span> nodeIds = []cdp.NodeID&#123;node.NodeID&#125;<br>			<span class="hljs-comment">// 先使用模拟输入</span><br>			_ = chromedp.SendKeys(nodeIds, value, chromedp.ByNodeID).Do(tCtxN)<br>			<span class="hljs-comment">// 再直接赋值JS属性</span><br>			_ = chromedp.SetAttributeValue(nodeIds, <span class="hljs-string">&quot;value&quot;</span>, value, chromedp.ByNodeID).Do(tCtxN)<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> attrType == <span class="hljs-string">&quot;radio&quot;</span> || attrType == <span class="hljs-string">&quot;checkbox&quot;</span> &#123;<br>			<span class="hljs-keyword">var</span> nodeIds = []cdp.NodeID&#123;node.NodeID&#125;<br>			_ = chromedp.SetAttributeValue(nodeIds, <span class="hljs-string">&quot;checked&quot;</span>, <span class="hljs-string">&quot;true&quot;</span>, chromedp.ByNodeID).Do(tCtxN)<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> attrType == <span class="hljs-string">&quot;file&quot;</span> || attrType == <span class="hljs-string">&quot;image&quot;</span> &#123;<br>			<span class="hljs-keyword">var</span> nodeIds = []cdp.NodeID&#123;node.NodeID&#125;<br>			wd, _ := os.Getwd()<br>			filePath := wd + <span class="hljs-string">&quot;/upload/image.png&quot;</span><br>			_ = chromedp.RemoveAttribute(nodeIds, <span class="hljs-string">&quot;accept&quot;</span>, chromedp.ByNodeID).Do(tCtxN)<br>			_ = chromedp.RemoveAttribute(nodeIds, <span class="hljs-string">&quot;required&quot;</span>, chromedp.ByNodeID).Do(tCtxN)<br>			_ = chromedp.SendKeys(nodeIds, filePath, chromedp.ByNodeID).Do(tCtxN)<br>		&#125;<br>		cancelN()<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>获取到 input 之后再去判断需要填充的类型，根据类型选择不同的文本去填充：</p>
<p><img src="https://blog-1310215391.cos.ap-beijing.myqcloud.com/images/image-20240327161550750.png?imageSlim" srcset="/img/loading.gif" lazyload alt="image-20240327161550750"></p>
<p>对于单选框，文件上传也做了对应的处理。</p>
<p>之后去注入 JS 去检测 Dom 变化：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tab *Tab)</span></span> setObserverJS() &#123;<br>	<span class="hljs-keyword">defer</span> tab.domWG.Done()<br>	logger.Logger.Debug(<span class="hljs-string">&quot;setObserverJS start&quot;</span>)<br>	<span class="hljs-comment">// 设置 Dom 节点变化的观察函数</span><br>	<span class="hljs-keyword">go</span> tab.Evaluate(js.ObserverJS)<br>	logger.Logger.Debug(<span class="hljs-string">&quot;setObserverJS end&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>JS 如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">init_observer_sec_auto_b</span>(<span class="hljs-params"></span>) &#123;<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">dom_listener_func_sec_auto</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) &#123;<br>		<span class="hljs-keyword">let</span> node = e.<span class="hljs-property">target</span>;<br>        <span class="hljs-comment">// 收集 src </span><br>		<span class="hljs-keyword">let</span> nodeListSrc = node.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&quot;[src]&quot;</span>);<br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> each <span class="hljs-keyword">of</span> nodeListSrc) &#123;<br>			<span class="hljs-keyword">if</span> (each.<span class="hljs-property">src</span>) &#123;<br>                <span class="hljs-comment">// 这里的 addLink 也是自定义的 就是去收集链接的</span><br>				<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addLink</span>(each.<span class="hljs-property">src</span>, <span class="hljs-string">&quot;DOM&quot;</span>);<br>				<span class="hljs-keyword">let</span> attrValue = each.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&quot;src&quot;</span>);<br>                <span class="hljs-comment">// 如果是 javascript: 就执行后面的代码</span><br>				<span class="hljs-keyword">if</span> (attrValue.<span class="hljs-title function_">toLocaleLowerCase</span>().<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;javascript:&quot;</span>)) &#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>						<span class="hljs-built_in">eval</span>(attrValue.<span class="hljs-title function_">substring</span>(<span class="hljs-number">11</span>));<br>					&#125;<br>					<span class="hljs-keyword">catch</span> &#123;&#125;<br>				&#125;<br>			&#125;<br>		&#125;<br>		<span class="hljs-comment">// 收集 href</span><br>		<span class="hljs-keyword">let</span> nodeListHref = node.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&quot;[href]&quot;</span>);<br>		nodeListHref = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">randArr</span>(nodeListHref);<br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> each <span class="hljs-keyword">of</span> nodeListHref) &#123;<br>			<span class="hljs-keyword">if</span> (each.<span class="hljs-property">href</span>) &#123;<br>				<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addLink</span>(each.<span class="hljs-property">href</span>, <span class="hljs-string">&quot;DOM&quot;</span>);<br>				<span class="hljs-keyword">let</span> attrValue = each.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&quot;href&quot;</span>);<br>				<span class="hljs-keyword">if</span> (attrValue.<span class="hljs-title function_">toLocaleLowerCase</span>().<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;javascript:&quot;</span>)) &#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>						<span class="hljs-built_in">eval</span>(attrValue.<span class="hljs-title function_">substring</span>(<span class="hljs-number">11</span>));<br>					&#125;<br>					<span class="hljs-keyword">catch</span> &#123;&#125;<br>				&#125;<br>			&#125;<br>		&#125;<br>	&#125;;<br>    <span class="hljs-comment">// 监测 dom 节点的变化 触发 window.dom_listener_func_sec_auto 也就是上面收集 src 和 href 的函数</span><br>	<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;DOMNodeInserted&#x27;</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">dom_listener_func_sec_auto</span>, <span class="hljs-literal">true</span>);<br>	<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;DOMSubtreeModified&#x27;</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">dom_listener_func_sec_auto</span>, <span class="hljs-literal">true</span>);<br>	<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;DOMNodeInsertedIntoDocument&#x27;</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">dom_listener_func_sec_auto</span>, <span class="hljs-literal">true</span>);<br>	<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;DOMAttrModified&#x27;</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">dom_listener_func_sec_auto</span>, <span class="hljs-literal">true</span>);<br>&#125;)()<br></code></pre></td></tr></table></figure>

<p>表单填充完毕、Dom 检测 JS 注入之后，它会去调用 AfterLoadedRun 去触发页面的动作，触发动作是通过 JS 去完成的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tab *Tab)</span></span> AfterLoadedRun() &#123;<br>	<span class="hljs-keyword">defer</span> tab.WG.Done()<br>	logger.Logger.Debug(<span class="hljs-string">&quot;afterLoadedRun start&quot;</span>)<br>	tab.formSubmitWG.Add(<span class="hljs-number">2</span>)<br>	tab.loadedWG.Add(<span class="hljs-number">3</span>)<br>	tab.removeLis.Add(<span class="hljs-number">1</span>)<br><br>	<span class="hljs-keyword">go</span> tab.formSubmit() <span class="hljs-comment">// 表单提交</span><br>	tab.formSubmitWG.Wait()<br>	logger.Logger.Debug(<span class="hljs-string">&quot;formSubmit end&quot;</span>)<br>	<span class="hljs-comment">// 异步</span><br>	<span class="hljs-keyword">if</span> tab.config.EventTriggerMode == config.EventTriggerAsync &#123;<br>		<span class="hljs-keyword">go</span> tab.triggerJavascriptProtocol()<br>		<span class="hljs-keyword">go</span> tab.triggerInlineEvents()<br>		<span class="hljs-keyword">go</span> tab.triggerDom2Events()<br>		tab.loadedWG.Wait()<br>		<span class="hljs-comment">// 同步 按照一定的顺序</span><br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tab.config.EventTriggerMode == config.EventTriggerSync &#123;<br>		tab.triggerInlineEvents()<br>		time.Sleep(tab.config.EventTriggerInterval)<br>		tab.triggerDom2Events()<br>		time.Sleep(tab.config.EventTriggerInterval)<br>		tab.triggerJavascriptProtocol()<br>	&#125;<br><br>	<span class="hljs-comment">// 事件触发之后 需要等待一点时间让浏览器成功发出 ajax 请求 更新 DOM</span><br>	time.Sleep(tab.config.BeforeExitDelay)<br><br>	<span class="hljs-keyword">go</span> tab.RemoveDOMListener()<br>	tab.removeLis.Wait()<br>	logger.Logger.Debug(<span class="hljs-string">&quot;afterLoadedRun end&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>看一下用于触发动作的 JS 代码：</p>
<p>triggerJavascriptProtocol：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">click_all_a_tag_javascript</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-comment">// 获取 href 节点列表</span><br>	<span class="hljs-keyword">let</span> nodeListHref = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&quot;[href]&quot;</span>);<br>    <span class="hljs-comment">// 随机排列</span><br>	nodeListHref = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">randArr</span>(nodeListHref);<br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> node <span class="hljs-keyword">of</span> nodeListHref) &#123;<br>        <span class="hljs-comment">// 获取属性值 如果是 javascript: 就会去执行后面的 JS 代码</span><br>		<span class="hljs-keyword">let</span> attrValue = node.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&quot;href&quot;</span>);<br>		<span class="hljs-keyword">if</span> (attrValue.<span class="hljs-title function_">toLocaleLowerCase</span>().<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;javascript: &quot;</span>)) &#123;<br>			<span class="hljs-keyword">await</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">sleep</span>(%f);<br>			<span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-built_in">eval</span>(attrValue.<span class="hljs-title function_">substring</span>(<span class="hljs-number">11</span>));<br>			&#125;<br>			<span class="hljs-keyword">catch</span> &#123;&#125;<br>		&#125;<br>	&#125;<br>    <span class="hljs-comment">// src 同理</span><br>	<span class="hljs-keyword">let</span> nodeListSrc = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&quot;[src]&quot;</span>);<br>	nodeListSrc = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">randArr</span>(nodeListSrc);<br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> node <span class="hljs-keyword">of</span> nodeListSrc) &#123;<br>		<span class="hljs-keyword">let</span> attrValue = node.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&quot;src&quot;</span>);<br>		<span class="hljs-keyword">if</span> (attrValue.<span class="hljs-title function_">toLocaleLowerCase</span>().<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;javascript:&quot;</span>)) &#123;<br>			<span class="hljs-keyword">await</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">sleep</span>(%f);<br>			<span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-built_in">eval</span>(attrValue.<span class="hljs-title function_">substring</span>(<span class="hljs-number">11</span>));<br>			&#125;<br>			<span class="hljs-keyword">catch</span> &#123;&#125;<br>		&#125;<br>	&#125;<br>&#125;)()<br></code></pre></td></tr></table></figure>

<p>内联事件：triggerInlineEvents</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go">(async function trigger_all_inline_event()&#123;<br>    <span class="hljs-comment">// 一些内联事件名称</span><br>	let eventNames = [<span class="hljs-string">&quot;onabort&quot;</span>, <span class="hljs-string">&quot;onblur&quot;</span>, <span class="hljs-string">&quot;onchange&quot;</span>, <span class="hljs-string">&quot;onclick&quot;</span>, <span class="hljs-string">&quot;ondblclick&quot;</span>, <span class="hljs-string">&quot;onerror&quot;</span>, <span class="hljs-string">&quot;onfocus&quot;</span>, <span class="hljs-string">&quot;onkeydown&quot;</span>, <span class="hljs-string">&quot;onkeypress&quot;</span>, <span class="hljs-string">&quot;onkeyup&quot;</span>, <span class="hljs-string">&quot;onload&quot;</span>, <span class="hljs-string">&quot;onmousedown&quot;</span>, <span class="hljs-string">&quot;onmousemove&quot;</span>, <span class="hljs-string">&quot;onmouseout&quot;</span>, <span class="hljs-string">&quot;onmouseover&quot;</span>, <span class="hljs-string">&quot;onmouseup&quot;</span>, <span class="hljs-string">&quot;onreset&quot;</span>, <span class="hljs-string">&quot;onresize&quot;</span>, <span class="hljs-string">&quot;onselect&quot;</span>, <span class="hljs-string">&quot;onsubmit&quot;</span>, <span class="hljs-string">&quot;onunload&quot;</span>];<br>	<span class="hljs-keyword">for</span> (let eventName of eventNames) &#123;<br>		let event = eventName.replace(<span class="hljs-string">&quot;on&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>		let nodeList = document.querySelectorAll(<span class="hljs-string">&quot;[&quot;</span> + eventName + <span class="hljs-string">&quot;]&quot;</span>);<br>		<span class="hljs-keyword">if</span> (nodeList.length &gt; <span class="hljs-number">100</span>) &#123;<br>			nodeList = nodeList.slice(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>);<br>		&#125;<br>		nodeList = window.randArr(nodeList);<br>		<span class="hljs-keyword">for</span> (let node of nodeList) &#123;<br>			await window.sleep(%f);<br>            <span class="hljs-comment">// 触发事件</span><br>			let evt = document.createEvent(<span class="hljs-string">&#x27;CustomEvent&#x27;</span>);<br>			evt.initCustomEvent(event, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>, null);<br>			try &#123;<br>				node.dispatchEvent(evt);<br>			&#125;<br>			catch &#123;&#125;<br>		&#125;<br>	&#125;<br>&#125;)()<br></code></pre></td></tr></table></figure>

<p>触发 DOM2 级事件 triggerDom2Events ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 定义一个立即执行的异步函数</span><br>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">trigger_all_dom2_custom_event</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// 定义一个函数，用于向下传递事件到子节点</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">transmit_child</span>(<span class="hljs-params">node, event, loop</span>) &#123;<br>		<span class="hljs-keyword">let</span> _loop = loop + <span class="hljs-number">1</span> <span class="hljs-comment">// 递归深度增加</span><br>		<span class="hljs-keyword">if</span> (_loop &gt; <span class="hljs-number">4</span>) &#123;<br>			<span class="hljs-keyword">return</span>; <span class="hljs-comment">// 如果递归深度超过4，则停止递归</span><br>		&#125;<br>		<span class="hljs-keyword">if</span> (node.<span class="hljs-property">nodeType</span> === <span class="hljs-number">1</span>) &#123; <span class="hljs-comment">// 确保节点是一个元素节点</span><br>			<span class="hljs-keyword">if</span> (node.<span class="hljs-property">hasChildNodes</span>) &#123;<br>				<span class="hljs-comment">// 随机选择一个子节点并尝试触发事件</span><br>				<span class="hljs-keyword">let</span> index = <span class="hljs-built_in">parseInt</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>()*node.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>,<span class="hljs-number">10</span>);<br>				<span class="hljs-keyword">try</span> &#123;<br>					node.<span class="hljs-property">children</span>[index].<span class="hljs-title function_">dispatchEvent</span>(event);<br>				&#125; <span class="hljs-keyword">catch</span>(e) &#123;&#125;<br>				<span class="hljs-comment">// 对最多5个子节点（或所有子节点如果少于5个）递归执行相同操作</span><br>				<span class="hljs-keyword">let</span> max = node.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>&gt;<span class="hljs-number">5</span>?<span class="hljs-number">5</span>:node.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>;<br>				<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> count=<span class="hljs-number">0</span>;count&lt;max;count++) &#123;<br>					<span class="hljs-keyword">let</span> index = <span class="hljs-built_in">parseInt</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>()*node.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>,<span class="hljs-number">10</span>);<br>					<span class="hljs-title function_">transmit_child</span>(node.<span class="hljs-property">children</span>[index], event, _loop);<br>				&#125;<br>			&#125;<br>		&#125;<br>	&#125;<br>    <br>    <span class="hljs-comment">// 选择所有带有特定标记（sec_auto_dom2_event_flag）的节点</span><br>	<span class="hljs-keyword">let</span> nodes = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&quot;[sec_auto_dom2_event_flag]&quot;</span>);<br>	<span class="hljs-keyword">if</span> (nodes.<span class="hljs-property">length</span> &gt; <span class="hljs-number">200</span>) &#123;<br>        <span class="hljs-comment">// 如果选中的节点超过200，只取前200个</span><br>		nodes = nodes.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">200</span>);<br>	&#125;<br>    <br>    <span class="hljs-comment">// 假设randArr是一个自定义函数，用于打乱数组顺序</span><br>	nodes = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">randArr</span>(nodes);<br>    <br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> node <span class="hljs-keyword">of</span> nodes) &#123;<br>		<span class="hljs-keyword">let</span> loop = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">// 等待一段时间，%f需要替换为实际的等待时间（毫秒）</span><br>		<span class="hljs-keyword">await</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">sleep</span>(%f);<br>        <br>        <span class="hljs-comment">// 从节点获取要触发的事件名称列表，并使用Set去重</span><br>		<span class="hljs-keyword">let</span> event_name_list = node.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&quot;sec_auto_dom2_event_flag&quot;</span>).<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;|&quot;</span>);<br>		<span class="hljs-keyword">let</span> event_name_set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(event_name_list);<br>		event_name_list = [...event_name_set];<br>        <br>        <span class="hljs-comment">// 遍历所有事件名称</span><br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> event_name <span class="hljs-keyword">of</span> event_name_list) &#123;<br>            <span class="hljs-comment">// 创建并初始化自定义事件</span><br>			<span class="hljs-keyword">let</span> evt = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createEvent</span>(<span class="hljs-string">&#x27;CustomEvent&#x27;</span>);<br>			evt.<span class="hljs-title function_">initCustomEvent</span>(event_name, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">null</span>);<br>			<br>            <span class="hljs-comment">// 对特定事件，递归地向子节点传递</span><br>			<span class="hljs-keyword">if</span> (event_name == <span class="hljs-string">&quot;click&quot;</span> || event_name == <span class="hljs-string">&quot;focus&quot;</span> || event_name == <span class="hljs-string">&quot;mouseover&quot;</span> || event_name == <span class="hljs-string">&quot;select&quot;</span>) &#123;<br>				<span class="hljs-title function_">transmit_child</span>(node, evt, loop);<br>			&#125;<br>            <br>            <span class="hljs-comment">// 如果节点的class或id包含&quot;close&quot;，则跳过此节点</span><br>			<span class="hljs-keyword">if</span> ((node.<span class="hljs-property">className</span> &amp;&amp; node.<span class="hljs-property">className</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;close&quot;</span>)) || (node.<span class="hljs-property">id</span> &amp;&amp; node.<span class="hljs-property">id</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;close&quot;</span>))) &#123;<br>				<span class="hljs-keyword">continue</span>;<br>			&#125;<br>			<br>            <span class="hljs-comment">// 尝试在节点上触发事件</span><br>			<span class="hljs-keyword">try</span> &#123;<br>				node.<span class="hljs-title function_">dispatchEvent</span>(evt);<br>			&#125; <span class="hljs-keyword">catch</span>(e) &#123;&#125;<br>		&#125;<br>	&#125;<br>&#125;)() <span class="hljs-comment">// 立即执行函数</span><br><br></code></pre></td></tr></table></figure>

<p>事件触发完毕后等待，之后会移除掉监听：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-keyword">function</span> <span class="hljs-title function_">remove_dom_listener</span>(<span class="hljs-params"></span>) &#123;<br>	<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;DOMNodeInserted&#x27;</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">dom_listener_func_sec_auto</span>, <span class="hljs-literal">true</span>);<br>	<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;DOMSubtreeModified&#x27;</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">dom_listener_func_sec_auto</span>, <span class="hljs-literal">true</span>);<br>	<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;DOMNodeInsertedIntoDocument&#x27;</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">dom_listener_func_sec_auto</span>, <span class="hljs-literal">true</span>);<br>	<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;DOMAttrModified&#x27;</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">dom_listener_func_sec_auto</span>, <span class="hljs-literal">true</span>);<br>&#125;)()<br></code></pre></td></tr></table></figure>

<p>然后是 tab.HandleBindingCalled 这里去进行绑定函数的处理，这里的绑定是 Start() 中 runtime.AddBinding 绑定的函数，其中的 addLink 在 JS 中用的很多，就是各种情况操作都使用它去做链接收集，那就看下这里是如果实现的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tab *Tab)</span></span> HandleBindingCalled(event *runtime.EventBindingCalled) &#123;<br>	<span class="hljs-keyword">defer</span> tab.WG.Done()<br>	payload := []<span class="hljs-type">byte</span>(event.Payload)<br>	<span class="hljs-keyword">var</span> bcPayload bindingCallPayload<br>	_ = json.Unmarshal(payload, &amp;bcPayload)<br>    <span class="hljs-comment">// 对于 addLink 获取它的 url 然后添加到 ResultUrl 中 =&gt; JS 和 Go 进行交互 </span><br>	<span class="hljs-keyword">if</span> bcPayload.Name == <span class="hljs-string">&quot;addLink&quot;</span> &amp;&amp; <span class="hljs-built_in">len</span>(bcPayload.Args) &gt; <span class="hljs-number">1</span> &#123;<br>		tab.AddResultUrl(config.GET, bcPayload.Args[<span class="hljs-number">0</span>], bcPayload.Args[<span class="hljs-number">1</span>])<br>	&#125;<br>	<span class="hljs-keyword">if</span> bcPayload.Name == <span class="hljs-string">&quot;Test&quot;</span> &#123;<br>		fmt.Println(bcPayload.Args)<br>	&#125;<br>	tab.Evaluate(fmt.Sprintf(js.DeliverResultJS, bcPayload.Name, bcPayload.Seq, <span class="hljs-string">&quot;s&quot;</span>))<br>&#125;<br></code></pre></td></tr></table></figure>

<p>标签页创建完成之后就使用 Start() 开始爬行：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tab *Tab)</span></span> Start() &#123;<br>	logger.Logger.Info(<span class="hljs-string">&quot;Crawling &quot;</span> + tab.NavigateReq.Method + <span class="hljs-string">&quot; &quot;</span> + tab.NavigateReq.URL.String())<br>	<span class="hljs-keyword">defer</span> tab.Cancel()<br>	<span class="hljs-keyword">if</span> err := chromedp.Run(*tab.Ctx,<br>		RunWithTimeOut(tab.Ctx, tab.config.DomContentLoadedTimeout, chromedp.Tasks&#123;<br>			<span class="hljs-comment">//</span><br>			runtime.Enable(),<br>			<span class="hljs-comment">// 开启网络层API</span><br>			network.Enable(),<br>			<span class="hljs-comment">// 开启请求拦截API</span><br>			fetch.Enable().WithHandleAuthRequests(<span class="hljs-literal">true</span>),<br>			<span class="hljs-comment">// 添加回调函数绑定</span><br>			<span class="hljs-comment">// XSS-Scan 使用的回调</span><br>			runtime.AddBinding(<span class="hljs-string">&quot;addLink&quot;</span>),<br>			runtime.AddBinding(<span class="hljs-string">&quot;Test&quot;</span>),<br>			<span class="hljs-comment">// 初始化执行JS</span><br>			chromedp.ActionFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> <span class="hljs-type">error</span> &#123;<br>				<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>                <span class="hljs-comment">// 页面加载时执行JS代码</span><br>				_, err = page.AddScriptToEvaluateOnNewDocument(js.TabInitJS).Do(ctx)<br>				<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>					<span class="hljs-keyword">return</span> err<br>				&#125;<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>			&#125;),<br>			network.SetExtraHTTPHeaders(tab.ExtraHeaders),<br>			<span class="hljs-comment">// 执行导航</span><br>			chromedp.Navigate(tab.NavigateReq.URL.String()),<br>		&#125;),<br>	); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">if</span> errors.Is(err, context.Canceled) &#123;<br>			logger.Logger.Debug(<span class="hljs-string">&quot;Crawling Canceled&quot;</span>)<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		logger.Logger.Warn(<span class="hljs-string">&quot;navigate timeout &quot;</span>, tab.NavigateReq.URL.String())<br>	&#125;<br><br>	waitDone := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125; &#123;<br>		tab.WG.Wait()<br>		ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br>		<span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(ch)<br>		<span class="hljs-keyword">return</span> ch<br>	&#125;<br><br>	<span class="hljs-keyword">select</span> &#123;<br>	<span class="hljs-keyword">case</span> &lt;-waitDone():<br>		logger.Logger.Debug(<span class="hljs-string">&quot;all navigation tasks done.&quot;</span>)<br>	<span class="hljs-keyword">case</span> &lt;-time.After(tab.config.DomContentLoadedTimeout + time.Second*<span class="hljs-number">10</span>):<br>		logger.Logger.Warn(<span class="hljs-string">&quot;navigation tasks TIMEOUT.&quot;</span>)<br>	&#125;<br><br>	<span class="hljs-comment">// 等待收集所有链接</span><br>	logger.Logger.Debug(<span class="hljs-string">&quot;collectLinks start.&quot;</span>)<br>	tab.collectLinkWG.Add(<span class="hljs-number">3</span>)<br>	<span class="hljs-keyword">go</span> tab.collectLinks()<br>	tab.collectLinkWG.Wait()<br>	logger.Logger.Debug(<span class="hljs-string">&quot;collectLinks end.&quot;</span>)<br><br>	<span class="hljs-comment">// 识别页面编码 并编码所有 URL</span><br>	<span class="hljs-keyword">if</span> tab.config.EncodeURLWithCharset &#123;<br>		tab.DetectCharset()<br>		tab.EncodeAllURLWithCharset()<br>	&#125;<br><br>	<span class="hljs-comment">//fmt.Println(tab.NavigateReq.URL.String(), len(tab.ResultList))</span><br>	<span class="hljs-comment">//for _, v := range tab.ResultList &#123;</span><br>	<span class="hljs-comment">//	v.SimplePrint()</span><br>	<span class="hljs-comment">//&#125;</span><br>	<span class="hljs-comment">// fmt.Println(&quot;Finished &quot; + tab.NavigateReq.Method + &quot; &quot; + tab.NavigateReq.URL.String())</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>它先去绑定了 addLink、Test 作用如下，主要是用于 go 和浏览器 JS 交互，这里的作用其实就是通过这种方式去收集链接，在 上面的 init_observer_sec_auto_b 和下面的 addTabInitScript 函数中都可以看到链接收集的操作。</p>
<p><img src="https://blog-1310215391.cos.ap-beijing.myqcloud.com/images/image-20240328141653434.png?imageSlim" srcset="/img/loading.gif" lazyload alt="image-20240328141653434"></p>
<p>然后在加载页面时注入 js.TabInitJS ，该 JS 处理了初始化和各种场景的链接收集操作：</p>
<p>涉及的一些 JS 知识：</p>
<ul>
<li>window.navigator.webdriver：用于检测当前页面是否在使用自动化测试工具</li>
<li>navigator.plugins：返回浏览器的插件列表</li>
<li>navigator.permissions：提供了对浏览器权限状态的查询和更改的功能</li>
<li>Histor：接口允许操作浏览器的曾经在标签页或者框架里访问的会话历史记录</li>
<li>window.history.pushState：向浏览器的历史记录栈中添加一条新的记录，并在不刷新页面的情况下改变URL。这个方法常用于单页面应用程序（SPA）中，可以帮助开发者实现前端路由和用户界面的状态管理</li>
<li>window.history.replaceState：更改浏览器地址栏中显示的URL，而无需加载新的页面或重新加载现有页面。这对于在Web应用程序中实现单页应用程序（SPA）非常有用，因为可以更改URL并在不刷新整个页面的情况下更新应用程序的状态。</li>
<li>hash 属性：一个可读可写的字符串，该字符串是 URL 的锚部分，一般有当前页面中 href 中 # 地址触发。hash 即 URL 中 # 字符后面的部分。可以通过 window.location.hash 属性获取和设置 hash 值。window.location.hash 值的变化会直接反应到浏览器地址栏（#后面的部分会发生变化），同时，浏览器地址栏 hash 值的变化也会触发 window.location.hash 值的变化，从而触发 onhashchange 事件。当 URL 的片段标识符更改时，将触发 hashchange 事件。Vue 这种前端框架就是 #&#x2F;path 的</li>
<li>window.EventSource：创建一个新的 <code>EventSource</code>，用于从指定的 URL 接收服务器发送事件，可以选择开启凭据模式。这是服务器向浏览器推送信息除过 websocket 的另一种方式 。</li>
<li>window.fetch：是浏览器提供的用于发起网络请求的API。它是一种现代的替代传统XHR（XMLHttpRequest）的方式，提供了更简洁和强大的请求和响应处理能力。</li>
<li>window.open：是JavaScript中的一个方法，用于在浏览器中打开一个新窗口或标签页，并加载指定的URL。</li>
<li>window.setInterval：定时调用的函数，可按照指定的周期（以毫秒计）来调用函数或计算表达式。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br></pre></td><td class="code"><pre><code class="hljs go">(function addTabInitScript () &#123;<br><br>	<span class="hljs-comment">// 移除 window.navigator.webdriver</span><br>	Object.defineProperty(navigator, <span class="hljs-string">&#x27;webdriver&#x27;</span>, &#123;<br>        get: () =&gt; <span class="hljs-literal">false</span>,<br>    &#125;);<br><br>	<span class="hljs-comment">// 绕过浏览器插件数量测试</span><br>    <span class="hljs-comment">// 开发者可能会检测浏览器中已安装的插件数量，以此作为一种安全检测机制或用于浏览器指纹识别。</span><br>	Object.defineProperty(navigator, <span class="hljs-string">&#x27;plugins&#x27;</span>, &#123;<br>        get: () =&gt; [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>],<br>    &#125;);<br>	<br>	<span class="hljs-comment">// 用于通过 Chrome 测试</span><br>    <span class="hljs-comment">// 网站开发者可能会检测浏览器是否为Chrome浏览器，并根据检测结果提供不同的行为。</span><br>	window.chrome = &#123;<br>		runtime: &#123;&#125;,<br>	&#125;;<br><br>	<span class="hljs-comment">// 修改浏览器权限通知行为</span><br>    <span class="hljs-comment">// 在特定的测试场景或需要检查通知权限的情况下，模拟返回不同的通知权限状态。通过返回自定义的权限状态对象，网页可以根据不同的权限状态来执行相应的逻辑，例如显示不同的提示信息、调整页面行为等。</span><br>  	<span class="hljs-keyword">const</span> originalQuery = window.navigator.permissions.query;<br>	window.navigator.permissions.query = (parameters) =&gt; (<br>    	parameters.name === <span class="hljs-string">&#x27;notifications&#x27;</span> ?<br>			Promise.resolve(&#123; state: Notification.permission &#125;) :<br>			originalQuery(parameters)<br>	);<br><br>	<span class="hljs-comment">// 模拟 userAgent</span><br>	Object.defineProperty(navigator, <span class="hljs-string">&#x27;userAgent&#x27;</span>, &#123;<br>        get: () =&gt; <span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.0 Safari/537.36&quot;</span>,<br>    &#125;);<br><br>	<span class="hljs-comment">// 修改浏览器对象的属性</span><br>	Object.defineProperty(navigator, <span class="hljs-string">&#x27;platform&#x27;</span>, &#123;<br>		get: function () &#123; <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;win32&#x27;</span>; &#125;<br>	&#125;);<br>	<br>	Object.defineProperty(navigator, <span class="hljs-string">&#x27;language&#x27;</span>, &#123;<br>		get: function () &#123; <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;zh-CN&#x27;</span>; &#125;<br>	&#125;);<br>	<br>	Object.defineProperty(navigator, <span class="hljs-string">&#x27;languages&#x27;</span>, &#123;<br>		get: function () &#123; <span class="hljs-keyword">return</span> [<span class="hljs-string">&quot;zh-CN&quot;</span>, <span class="hljs-string">&quot;zh&quot;</span>]; &#125;<br>	&#125;);<br>	<br>	<span class="hljs-comment">// history api hook</span><br>    <span class="hljs-comment">// 重写 pushState replaceState 方法 监听历史记录中的 API </span><br>    <span class="hljs-comment">// 使用使用 window.addLink  去记录 API 到 HistoryAPI</span><br>	window.history.pushState = function(a, b, c) &#123; <br>		window.addLink(c, <span class="hljs-string">&quot;HistoryAPI&quot;</span>);<br>	&#125;<br>	window.history.replaceState = function(a, b, c) &#123; <br>		window.addLink(c, <span class="hljs-string">&quot;HistoryAPI&quot;</span>);<br>	&#125;<br>    <span class="hljs-comment">// 可写性和可配置性设置为false，即禁止对这两个方法进行重写或修改。</span><br>	Object.defineProperty(window.history,<span class="hljs-string">&quot;pushState&quot;</span>,&#123;<span class="hljs-string">&quot;writable&quot;</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;configurable&quot;</span>: <span class="hljs-literal">false</span>&#125;);<br>	Object.defineProperty(window.history,<span class="hljs-string">&quot;replaceState&quot;</span>,&#123;<span class="hljs-string">&quot;writable&quot;</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;configurable&quot;</span>: <span class="hljs-literal">false</span>&#125;);<br>	<br>    <span class="hljs-comment">// 添加 hashchange 事件监听，监听 hash</span><br>	window.addEventListener(<span class="hljs-string">&quot;hashchange&quot;</span>, function() &#123;<br>		window.addLink(document.location.href, <span class="hljs-string">&quot;HashChange&quot;</span>);<br>	&#125;);<br>	<span class="hljs-comment">// 重写 webSocket 构造方法 记录 websokcet 连接相关信息</span><br>	<span class="hljs-keyword">var</span> oldWebSocket = window.WebSocket;<br>	window.WebSocket = function(url, arg) &#123;<br>		window.addLink(url, <span class="hljs-string">&quot;WebSocket&quot;</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span> oldWebSocket(url, arg);<br>	&#125;<br>	<span class="hljs-comment">// 重写 EventSource 构造方法 记录 EventSource 连接相关信息</span><br>	<span class="hljs-keyword">var</span> oldEventSource = window.EventSource;<br>	window.EventSource = function(url) &#123;<br>		window.addLink(url, <span class="hljs-string">&quot;EventSource&quot;</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span> oldEventSource(url);<br>	&#125;<br>	<span class="hljs-comment">// 记录 fetch 发起请求的 url</span><br>	<span class="hljs-keyword">var</span> oldFetch = window.fetch;<br>	window.fetch = function(url) &#123;<br>		window.addLink(url, <span class="hljs-string">&quot;Fetch&quot;</span>);<br>		<span class="hljs-keyword">return</span> oldFetch(url);<br>	&#125;<br>	<br>	<span class="hljs-comment">// 锁定表单重置</span><br>	HTMLFormElement.prototype.reset = function() &#123;console.log(<span class="hljs-string">&quot;cancel reset form&quot;</span>)&#125;;<br>	Object.defineProperty(HTMLFormElement.prototype,<span class="hljs-string">&quot;reset&quot;</span>,&#123;<span class="hljs-string">&quot;writable&quot;</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;configurable&quot;</span>: <span class="hljs-literal">false</span>&#125;);<br>	<br>	<span class="hljs-comment">// 监听 DOM2 级事件</span><br>	window.add_even_listener_count_sec_auto = &#123;&#125;;<br>	<span class="hljs-comment">// DOM2 级事件限制函数</span><br>	let old_event_handle = Element.prototype.addEventListener;<br>	Element.prototype.addEventListener = function(event_name, event_func, useCapture) &#123;<br>		let name = <span class="hljs-string">&quot;&lt;&quot;</span> + this.tagName + <span class="hljs-string">&quot;&gt; &quot;</span> + this.id + this.name + this.getAttribute(<span class="hljs-string">&quot;class&quot;</span>) + <span class="hljs-string">&quot;|&quot;</span> + event_name;<br>		<span class="hljs-comment">// console.log(name)</span><br>		<span class="hljs-comment">// 对每个事件设定最大的添加次数，防止无限触发，最大次数为5</span><br>		<span class="hljs-keyword">if</span> (!window.add_even_listener_count_sec_auto.hasOwnProperty(name)) &#123;<br>			window.add_even_listener_count_sec_auto[name] = <span class="hljs-number">1</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (window.add_even_listener_count_sec_auto[name] == <span class="hljs-number">5</span>) &#123;<br>			<span class="hljs-keyword">return</span> ;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			 window.add_even_listener_count_sec_auto[name] += <span class="hljs-number">1</span>;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (this.hasAttribute(<span class="hljs-string">&quot;sec_auto_dom2_event_flag&quot;</span>)) &#123;<br>			let sec_auto_dom2_event_flag = this.getAttribute(<span class="hljs-string">&quot;sec_auto_dom2_event_flag&quot;</span>);<br>			this.setAttribute(<span class="hljs-string">&quot;sec_auto_dom2_event_flag&quot;</span>, sec_auto_dom2_event_flag + <span class="hljs-string">&quot;|&quot;</span> + event_name);<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			this.setAttribute(<span class="hljs-string">&quot;sec_auto_dom2_event_flag&quot;</span>, event_name);<br>		&#125;<br>		old_event_handle.apply(this, arguments);<br>	&#125;;<br>	<span class="hljs-comment">// Dom0 级事件限制函数</span><br>	function dom0_listener_hook(that, event_name) &#123;<br>		let name = <span class="hljs-string">&quot;&lt;&quot;</span> + that.tagName + <span class="hljs-string">&quot;&gt; &quot;</span> + that.id + that.name + that.getAttribute(<span class="hljs-string">&quot;class&quot;</span>) + <span class="hljs-string">&quot;|&quot;</span> + event_name;<br>		<span class="hljs-comment">// console.log(name);</span><br>		<span class="hljs-comment">// 对每个事件设定最大的添加次数，防止无限触发，最大次数为5</span><br>		<span class="hljs-keyword">if</span> (!window.add_even_listener_count_sec_auto.hasOwnProperty(name)) &#123;<br>			window.add_even_listener_count_sec_auto[name] = <span class="hljs-number">1</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (window.add_even_listener_count_sec_auto[name] == <span class="hljs-number">5</span>) &#123;<br>			<span class="hljs-keyword">return</span> ;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			 window.add_even_listener_count_sec_auto[name] += <span class="hljs-number">1</span>;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (that.hasAttribute(<span class="hljs-string">&quot;sec_auto_dom2_event_flag&quot;</span>)) &#123;<br>			let sec_auto_dom2_event_flag = that.getAttribute(<span class="hljs-string">&quot;sec_auto_dom2_event_flag&quot;</span>);<br>			that.setAttribute(<span class="hljs-string">&quot;sec_auto_dom2_event_flag&quot;</span>, sec_auto_dom2_event_flag + <span class="hljs-string">&quot;|&quot;</span> + event_name);<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			that.setAttribute(<span class="hljs-string">&quot;sec_auto_dom2_event_flag&quot;</span>, event_name);<br>		&#125;<br>	&#125;<br>	<br>	<span class="hljs-comment">// hook dom0 级事件监听</span><br>	Object.defineProperties(HTMLElement.prototype, &#123;<br>		onclick: &#123;set: function(newValue)&#123;onclick = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;click&quot;</span>);&#125;&#125;,<br>		onchange: &#123;set: function(newValue)&#123;onchange = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;change&quot;</span>);&#125;&#125;,<br>		onblur: &#123;set: function(newValue)&#123;onblur = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;blur&quot;</span>);&#125;&#125;,<br>		ondblclick: &#123;set: function(newValue)&#123;ondblclick = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;dbclick&quot;</span>);&#125;&#125;,<br>		onfocus: &#123;set: function(newValue)&#123;onfocus = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;focus&quot;</span>);&#125;&#125;,<br>		onkeydown: &#123;set: function(newValue)&#123;onkeydown = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;keydown&quot;</span>);&#125;&#125;,<br>		onkeypress: &#123;set: function(newValue)&#123;onkeypress = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;keypress&quot;</span>);&#125;&#125;,<br>		onkeyup: &#123;set: function(newValue)&#123;onkeyup = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;keyup&quot;</span>);&#125;&#125;,<br>		onload: &#123;set: function(newValue)&#123;onload = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;load&quot;</span>);&#125;&#125;,<br>		onmousedown: &#123;set: function(newValue)&#123;onmousedown = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;mousedown&quot;</span>);&#125;&#125;,<br>		onmousemove: &#123;set: function(newValue)&#123;onmousemove = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;mousemove&quot;</span>);&#125;&#125;,<br>		onmouseout: &#123;set: function(newValue)&#123;onmouseout = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;mouseout&quot;</span>);&#125;&#125;,<br>		onmouseover: &#123;set: function(newValue)&#123;onmouseover = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;mouseover&quot;</span>);&#125;&#125;,<br>		onmouseup: &#123;set: function(newValue)&#123;onmouseup = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;mouseup&quot;</span>);&#125;&#125;,<br>		onreset: &#123;set: function(newValue)&#123;onreset = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;reset&quot;</span>);&#125;&#125;,<br>		onresize: &#123;set: function(newValue)&#123;onresize = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;resize&quot;</span>);&#125;&#125;,<br>		onselect: &#123;set: function(newValue)&#123;onselect = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;select&quot;</span>);&#125;&#125;,<br>		onsubmit: &#123;set: function(newValue)&#123;onsubmit = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;submit&quot;</span>);&#125;&#125;,<br>		onunload: &#123;set: function(newValue)&#123;onunload = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;unload&quot;</span>);&#125;&#125;,<br>		onabort: &#123;set: function(newValue)&#123;onabort = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;abort&quot;</span>);&#125;&#125;,<br>		onerror: &#123;set: function(newValue)&#123;onerror = newValue;dom0_listener_hook(this, <span class="hljs-string">&quot;error&quot;</span>);&#125;&#125;,<br>	&#125;)<br>	<br>	<span class="hljs-comment">// 监听 window.open 的 url</span><br>	window.open = function (url) &#123;<br>		console.log(<span class="hljs-string">&quot;trying to open window.&quot;</span>);<br>		window.addLink(url, <span class="hljs-string">&quot;OpenWindow&quot;</span>);<br>	&#125;<br>	Object.defineProperty(window,<span class="hljs-string">&quot;open&quot;</span>,&#123;<span class="hljs-string">&quot;writable&quot;</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;configurable&quot;</span>: <span class="hljs-literal">false</span>&#125;);<br>	<br>	<span class="hljs-comment">// hook window close 不真的关闭页面</span><br>	window.<span class="hljs-built_in">close</span> = function() &#123;console.log(<span class="hljs-string">&quot;trying to close page.&quot;</span>);&#125;;<br>	Object.defineProperty(window,<span class="hljs-string">&quot;close&quot;</span>,&#123;<span class="hljs-string">&quot;writable&quot;</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;configurable&quot;</span>: <span class="hljs-literal">false</span>&#125;);<br>	<br>	<span class="hljs-comment">// hook setTimeout</span><br>	<span class="hljs-comment">//window.__originalSetTimeout = window.setTimeout;</span><br>	<span class="hljs-comment">//window.setTimeout = function() &#123;</span><br>	<span class="hljs-comment">//    arguments[1] = 0;</span><br>	<span class="hljs-comment">//    return window.__originalSetTimeout.apply(this, arguments);</span><br>	<span class="hljs-comment">//&#125;;</span><br>	<span class="hljs-comment">//Object.defineProperty(window,&quot;setTimeout&quot;,&#123;&quot;writable&quot;: false, &quot;configurable&quot;: false&#125;);</span><br>	<br>	<span class="hljs-comment">// hook setInterval 时间设置为60秒 目的是减 轻chrome 的压力</span><br>    <span class="hljs-comment">// 限制定时调用函数的的事件为 60 秒</span><br>	window.__originalSetInterval = window.setInterval;<br>	window.setInterval = function() &#123;<br>		arguments[<span class="hljs-number">1</span>] = <span class="hljs-number">60000</span>;<br>		<span class="hljs-keyword">return</span> window.__originalSetInterval.apply(this, arguments);<br>	&#125;;<br>	Object.defineProperty(window,<span class="hljs-string">&quot;setInterval&quot;</span>,&#123;<span class="hljs-string">&quot;writable&quot;</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;configurable&quot;</span>: <span class="hljs-literal">false</span>&#125;);<br>	<br>	<span class="hljs-comment">// 劫持原生ajax，并对每个请求设置最大请求次数</span><br>	window.ajax_req_count_sec_auto = &#123;&#125;;<br>	XMLHttpRequest.prototype.__originalOpen = XMLHttpRequest.prototype.open;<br>	XMLHttpRequest.prototype.open = function(method, url, async, user, password) &#123;<br>		<span class="hljs-comment">// hook code</span><br>		this.url = url;<br>		this.method = method;<br>		let name = method + url;<br>		<span class="hljs-keyword">if</span> (!window.ajax_req_count_sec_auto.hasOwnProperty(name)) &#123;<br>			window.ajax_req_count_sec_auto[name] = <span class="hljs-number">1</span><br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			window.ajax_req_count_sec_auto[name] += <span class="hljs-number">1</span><br>		&#125;<br>		<br>		<span class="hljs-keyword">if</span> (window.ajax_req_count_sec_auto[name] &lt;= <span class="hljs-number">10</span>) &#123;<br>			<span class="hljs-keyword">return</span> this.__originalOpen(method, url, <span class="hljs-literal">true</span>, user, password);<br>		&#125;<br>	&#125;<br>	Object.defineProperty(XMLHttpRequest.prototype,<span class="hljs-string">&quot;open&quot;</span>,&#123;<span class="hljs-string">&quot;writable&quot;</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;configurable&quot;</span>: <span class="hljs-literal">false</span>&#125;);<br>	<br>	XMLHttpRequest.prototype.__originalSend = XMLHttpRequest.prototype.send;<br>	XMLHttpRequest.prototype.send = function(data) &#123;<br>		<span class="hljs-comment">// hook code</span><br>		let name = this.method + this.url;<br>		<span class="hljs-keyword">if</span> (window.ajax_req_count_sec_auto[name] &lt;= <span class="hljs-number">10</span>) &#123;<br>			<span class="hljs-keyword">return</span> this.__originalSend(data);<br>		&#125;<br>	&#125;<br>	Object.defineProperty(XMLHttpRequest.prototype,<span class="hljs-string">&quot;send&quot;</span>,&#123;<span class="hljs-string">&quot;writable&quot;</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;configurable&quot;</span>: <span class="hljs-literal">false</span>&#125;);<br><br>	XMLHttpRequest.prototype.__originalAbort = XMLHttpRequest.prototype.abort;<br>	XMLHttpRequest.prototype.abort = function() &#123;<br>		<span class="hljs-comment">// hook code</span><br>	&#125;<br>	Object.defineProperty(XMLHttpRequest.prototype,<span class="hljs-string">&quot;abort&quot;</span>,&#123;<span class="hljs-string">&quot;writable&quot;</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;configurable&quot;</span>: <span class="hljs-literal">false</span>&#125;);<br>	<br>	<span class="hljs-comment">// 打乱数组的方法</span><br>	window.randArr = function (arr) &#123;<br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; arr.length; i++) &#123;<br>			<span class="hljs-keyword">var</span> iRand = parseInt(arr.length * Math.random());<br>			<span class="hljs-keyword">var</span> temp = arr[i];<br>			arr[i] = arr[iRand];<br>			arr[iRand] = temp;<br>		&#125;<br>		<span class="hljs-keyword">return</span> arr;<br>	&#125;<br>	<span class="hljs-comment">// 延迟执行</span><br>	window.sleep = function(time) &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span> Promise((resolve) =&gt; setTimeout(resolve, time));<br>	&#125;<br>	<br>	Array.prototype.indexOf = function(val) &#123;<br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; this.length; i++) &#123;<br>			<span class="hljs-keyword">if</span> (this[i] == val) <span class="hljs-keyword">return</span> i;<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>	&#125;;<br>	<br>	Array.prototype.remove = function(val) &#123;<br>		<span class="hljs-keyword">var</span> index = this.indexOf(val);<br>		<span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">-1</span>) &#123;<br>			this.splice(index, <span class="hljs-number">1</span>);<br>		&#125;<br>	&#125;;<br>	<br>	<span class="hljs-keyword">const</span> binding = window[<span class="hljs-string">&quot;addLink&quot;</span>];<br>	window[<span class="hljs-string">&quot;addLink&quot;</span>] = async(...args) =&gt; &#123;<br>        <span class="hljs-comment">// 从 addLink 中获取 callbacks 它是一个 Map()</span><br>		<span class="hljs-keyword">const</span> me = window[<span class="hljs-string">&quot;addLink&quot;</span>];<br>		let callbacks = me[<span class="hljs-string">&#x27;callbacks&#x27;</span>];<br>		<span class="hljs-keyword">if</span> (!callbacks) &#123;<br>		  callbacks = <span class="hljs-built_in">new</span> Map();<br>		  me[<span class="hljs-string">&#x27;callbacks&#x27;</span>] = callbacks;<br>		&#125;<br>        <span class="hljs-comment">// 当前序列号</span><br>		<span class="hljs-keyword">const</span> seq = (me[<span class="hljs-string">&#x27;lastSeq&#x27;</span>] || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>;<br>		me[<span class="hljs-string">&#x27;lastSeq&#x27;</span>] = seq;<br>		<span class="hljs-keyword">const</span> promise = <span class="hljs-built_in">new</span> Promise(fulfill =&gt; callbacks.set(seq, fulfill));<br>		binding(JSON.stringify(&#123;name: <span class="hljs-string">&quot;addLink&quot;</span>, seq, args&#125;));<br>		<span class="hljs-keyword">return</span> promise;<br>	&#125;;<br><br>	<span class="hljs-keyword">const</span> bindingTest = window[<span class="hljs-string">&quot;Test&quot;</span>];<br>	window[<span class="hljs-string">&quot;Test&quot;</span>] = async(...args) =&gt; &#123;<br>		<span class="hljs-keyword">const</span> me = window[<span class="hljs-string">&quot;Test&quot;</span>];<br>		let callbacks = me[<span class="hljs-string">&#x27;callbacks&#x27;</span>];<br>		<span class="hljs-keyword">if</span> (!callbacks) &#123;<br>		  callbacks = <span class="hljs-built_in">new</span> Map();<br>		  me[<span class="hljs-string">&#x27;callbacks&#x27;</span>] = callbacks;<br>		&#125;<br>		<span class="hljs-keyword">const</span> seq = (me[<span class="hljs-string">&#x27;lastSeq&#x27;</span>] || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>;<br>		me[<span class="hljs-string">&#x27;lastSeq&#x27;</span>] = seq;<br>		<span class="hljs-keyword">const</span> promise = <span class="hljs-built_in">new</span> Promise(fulfill =&gt; callbacks.set(seq, fulfill));<br>		binding(JSON.stringify(&#123;name: <span class="hljs-string">&quot;Test&quot;</span>, seq, args&#125;));<br>		<span class="hljs-keyword">return</span> promise;<br>	&#125;;<br>&#125;)()<br></code></pre></td></tr></table></figure>

<p>之后是做了一个链接收集的操作，就是收集 src href data-url 属性值、 object[data] 、还有注释中的链接</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tab *Tab)</span></span> collectLinks() &#123;<br>	<span class="hljs-keyword">go</span> tab.collectHrefLinks()<br>	<span class="hljs-keyword">go</span> tab.collectObjectLinks()<br>	<span class="hljs-keyword">go</span> tab.collectCommentLinks()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tab *Tab)</span></span> collectHrefLinks() &#123;<br>	<span class="hljs-keyword">defer</span> tab.collectLinkWG.Done()<br>	ctx := tab.GetExecutor()<br>	<span class="hljs-comment">// 收集 src href data-url 属性值</span><br>	attrNameList := []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;src&quot;</span>, <span class="hljs-string">&quot;href&quot;</span>, <span class="hljs-string">&quot;data-url&quot;</span>, <span class="hljs-string">&quot;data-href&quot;</span>&#125;<br>	<span class="hljs-keyword">for</span> _, attrName := <span class="hljs-keyword">range</span> attrNameList &#123;<br>		tCtx, cancel := context.WithTimeout(ctx, time.Second*<span class="hljs-number">1</span>)<br>		<span class="hljs-keyword">var</span> attrs []<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span><br>		_ = chromedp.AttributesAll(fmt.Sprintf(<span class="hljs-string">`[%s]`</span>, attrName), &amp;attrs, chromedp.ByQueryAll).Do(tCtx)<br>		cancel()<br>		<span class="hljs-keyword">for</span> _, attrMap := <span class="hljs-keyword">range</span> attrs &#123;<br>			tab.AddResultUrl(config.GET, attrMap[attrName], config.FromDOM)<br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tab *Tab)</span></span> collectObjectLinks() &#123;<br>	<span class="hljs-keyword">defer</span> tab.collectLinkWG.Done()<br>	ctx := tab.GetExecutor()<br>	<span class="hljs-comment">// 收集 object[data] links</span><br>	tCtx, cancel := context.WithTimeout(ctx, time.Second*<span class="hljs-number">1</span>)<br>	<span class="hljs-keyword">defer</span> cancel()<br>	<span class="hljs-keyword">var</span> attrs []<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span><br>	_ = chromedp.AttributesAll(<span class="hljs-string">`object[data]`</span>, &amp;attrs, chromedp.ByQueryAll).Do(tCtx)<br>	<span class="hljs-keyword">for</span> _, attrMap := <span class="hljs-keyword">range</span> attrs &#123;<br>		tab.AddResultUrl(config.GET, attrMap[<span class="hljs-string">&quot;data&quot;</span>], config.FromDOM)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tab *Tab)</span></span> collectCommentLinks() &#123;<br>	<span class="hljs-keyword">defer</span> tab.collectLinkWG.Done()<br>	ctx := tab.GetExecutor()<br>	<span class="hljs-comment">// 收集注释中的链接</span><br>	<span class="hljs-keyword">var</span> nodes []*cdp.Node<br>	tCtxComment, cancel := context.WithTimeout(ctx, time.Second*<span class="hljs-number">1</span>)<br>	<span class="hljs-keyword">defer</span> cancel()<br>	commentErr := chromedp.Nodes(<span class="hljs-string">`//comment()`</span>, &amp;nodes, chromedp.BySearch).Do(tCtxComment)<br>	<span class="hljs-keyword">if</span> commentErr != <span class="hljs-literal">nil</span> &#123;<br>		logger.Logger.Debug(<span class="hljs-string">&quot;get comment nodes err&quot;</span>)<br>		logger.Logger.Debug(commentErr)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	urlRegex := regexp.MustCompile(config.URLRegex)<br>	<span class="hljs-keyword">for</span> _, node := <span class="hljs-keyword">range</span> nodes &#123;<br>		content := node.NodeValue<br>		urlList := urlRegex.FindAllString(content, <span class="hljs-number">-1</span>)<br>		<span class="hljs-keyword">for</span> _, url := <span class="hljs-keyword">range</span> urlList &#123;<br>			tab.AddResultUrl(config.GET, url, config.FromComment)<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在 Start() 完成之后，它会去把这些收集到的链接再去爬一遍：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go">tab.Start()<br><br><span class="hljs-comment">// 收集结果</span><br>t.crawlerTask.Result.resultLock.Lock()<br>t.crawlerTask.Result.AllReqList = <span class="hljs-built_in">append</span>(t.crawlerTask.Result.AllReqList, tab.ResultList...)<br>t.crawlerTask.Result.resultLock.Unlock()<br><span class="hljs-comment">// 遍历收集到的结构 添加任务</span><br><span class="hljs-keyword">for</span> _, req := <span class="hljs-keyword">range</span> tab.ResultList &#123;<br>    <span class="hljs-keyword">if</span> !t.crawlerTask.filter.DoFilter(req) &#123;<br>        t.crawlerTask.Result.resultLock.Lock()<br>        t.crawlerTask.Result.ReqList = <span class="hljs-built_in">append</span>(t.crawlerTask.Result.ReqList, req)<br>        t.crawlerTask.Result.resultLock.Unlock()<br>        <span class="hljs-keyword">if</span> !engine2.IsIgnoredByKeywordMatch(*req, t.crawlerTask.Config.IgnoreKeywords) &#123;<br>            t.crawlerTask.addTask2Pool(req)<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>再总体简单理一下流程：</p>
<p>task.Run() </p>
<ol>
<li>initTasks url 收集<ol>
<li>robots.txt</li>
<li>Fuzz</li>
</ol>
</li>
<li>filter.DoFilter 去重</li>
<li>addTask2Pool 开始爬 &#x3D;&gt; task.Task()<ol>
<li>tab.Start() &#x3D;&gt; 爬行逻辑<ol>
<li>engine2.NewTab &#x3D;&gt; 初始化 Tab 和请求拦截监听<ol>
<li>响应处理 js、json、html 解析响应中的链接</li>
<li>基础认证页面注释处理</li>
<li>tab.AfterDOMRun()<ol>
<li>表单填充、提交</li>
<li>注入 ObserverJS 收集 src、href 属性值</li>
<li>触发事件</li>
</ol>
</li>
</ol>
</li>
<li>初始化 chromedp.Run<ol>
<li>runtime.AddBinding(“addLink”) &#x3D;&gt; 绑定函数，用于 go 和 js 进行交互去收集链接</li>
<li>注入 js.TabInitJS 浏览器属性、url 收集（ addLink ）</li>
</ol>
</li>
</ol>
</li>
<li>tab.ResultList 当前页面收集的链接去重再使用 addTask2Pool 去爬</li>
</ol>
</li>
<li>所有请求去重</li>
<li>从请求中收集域名数据</li>
</ol>
<h2 id="学习总结"><a href="#学习总结" class="headerlink" title="学习总结"></a>学习总结</h2><p>学到的比较多，动态爬虫的具体实现、请求去重的方式、crawlergo 库深入使用、js 的一些知识，准备再看一看静态爬虫，看看它是如何去实现的。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%8A%80%E6%9C%AF/" class="category-chain-item">技术</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" class="print-no-link">#源码学习</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>crawlergo 源码学习</div>
      <div>https://liancccc.github.io/2024/03/12/技术/源码学习/crawlergo/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>守心</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年3月12日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/09/15/%E6%8A%80%E6%9C%AF/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93/" title="数据传输">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">数据传输</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/03/12/%E6%8A%80%E6%9C%AF/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/GoSpider/" title="GoSpider 源码学习">
                        <span class="hidden-mobile">GoSpider 源码学习</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
